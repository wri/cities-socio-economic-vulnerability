
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)
library(leaflet)
library(leaflet.extras)
library(sf)
library(DT)
library(shinycssloaders)




s3_path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/"

env = "dev"
selected_year = "2020"
country = "mexico"

# read census variables definition ----

# mexico
census_variables_definition = read.csv(paste(s3_path, "data/", env, "/",country,"/census/",selected_year,"/census_variables_definition.csv",sep = ""))
census_variables_group = unique(census_variables_definition$variable_category)

# colombia
census_variables_definition_col = read.csv(paste(s3_path, "data/", env, "/","colombia","/census/census_variables_definition.csv",sep = ""))
census_variables_group_col = unique(census_variables_definition_col$variable_category)

# brazil ----
census_variables_definition_bra = read.csv(paste(s3_path, "data/", env, "/","brazil","/census/census_variable_definition.csv",sep = ""))
census_variables_group_bra = unique(census_variables_definition_bra$variable_category)

# india
census_variables_definition_ind = read.csv(paste(s3_path, "data/", env, "/","india","/census/2011/census_variables_definition_v2.csv",sep = ""))
census_variables_group_ind = unique(census_variables_definition_ind$variable_category)

# india dev
census_variables_definition_ind_dev = read.csv(paste(s3_path, "data/", env, "/","india_2","/census/2011/census_variables_definition.csv",sep = ""))
census_variables_group_ind_dev = unique(census_variables_definition_ind_dev$variable_category)

# geographical level names ----

# Mexico ----
geo_levels_names = data.table::fread(paste(s3_path, "data/",env,"/",country,"/boundaries/",selected_year,"/geo_levels_names.csv",sep = ""),
                                     sep = ",",
                                     header = TRUE,
                                     colClasses = c('state_name'='character',
                                                    'state_code'='character',
                                                    'municipality_name'='character',
                                                    'locality_name'='character'))
geo_levels_names = as.data.frame(geo_levels_names)


# Colombia -----
geo_levels_names_col= data.table::fread(paste(s3_path, "data/",env,"/","colombia","/boundaries/geo_levels_names.csv",sep = ""),
                                        sep = ",",
                                        header = TRUE,
                                        encoding = "Latin-1",
                                        colClasses = c('municipality_name'='character',
                                                       'municipality_id'='character',
                                                       'department_name'='character',
                                                       'dept_id'='character'))


geo_levels_names_col = as.data.frame(geo_levels_names_col)

geo_levels_names_col = geo_levels_names_col %>% 
  add_row(dept_id = "All",
          department_name = "All",
          municipality_id= "All",
          municipality_name = "All")


# India ----

# india 
geo_levels_names_ind_v2 = data.table::fread(paste(s3_path, "data/",env,"/","india","/boundaries/","2011","/geo_levels_names_v2.csv",sep = ""),
                                            sep = ",",
                                            header = TRUE,
                                            colClasses = c('state_name'='character',
                                                           'state_id'='character',
                                                           'district_name'='character',
                                                           'district_id'='character',
                                                           'sub_district_name'='character',
                                                           'sub_district_id'='character'))

geo_levels_names_ind_v2 = as.data.frame(geo_levels_names_ind_v2)

geo_levels_names_ind_v2 = geo_levels_names_ind_v2 %>% 
  add_row(state_id = "All",
          state_name = "All",
          district_id= "All",
          district_name = "All",
          sub_district_name = "All",
          sub_district_id = "All")

# india dev 

geo_levels_names_ind_dev = data.table::fread(paste(s3_path, "data/",env,"/","india_2","/boundaries/","2011","/geo_levels_names.csv",sep = ""),
                                             sep = ",",
                                             header = TRUE,
                                             colClasses = c('state_name'='character',
                                                            'state_id'='character',
                                                            'district_name'='character',
                                                            'district_id'='character',
                                                            'subdistrict_name'='character',
                                                            'subdistrict_id'='character',
                                                            'townvill_id'='character',
                                                            'townvill_name'='character'))


geo_levels_names_ind_dev = as.data.frame(geo_levels_names_ind_dev)

geo_levels_names_ind_dev$state_id = str_pad(geo_levels_names_ind_dev$state_id, 2, pad = "0")

geo_levels_names_ind_dev = geo_levels_names_ind_dev %>% 
  add_row(state_id = "All",
          state_name = "All",
          district_id= "All",
          district_name = "All",
          subdistrict_id = "All",
          subdistrict_name = "All",
          townvill_id = "All",
          townvill_name = "All")

# brazil -----

geo_levels_names_bra= data.table::fread(paste(s3_path, "data/",env,"/","brazil","/boundaries/geo_levels_names.csv",sep = ""),
                                        sep = ",",
                                        header = TRUE,
                                        encoding = "Latin-1",
                                        colClasses = c('state_id'='character',
                                                       'state_name'='character',
                                                       'reg_id'='character',
                                                       'reg_name'='character',
                                                       'mesoreg_id'='character',
                                                       'mesoreg_name'='character',
                                                       'microreg_id'='character',
                                                       'microreg_name'='character',
                                                       'municipality_id'='character',
                                                       'municipality_name'='character'
                                        ))


geo_levels_names_bra = as.data.frame(geo_levels_names_bra)

geo_levels_names_bra = geo_levels_names_bra %>% 
  add_row(state_id = "All",
          state_name = "All",
          reg_id= "All",
          reg_name = "All",
          mesoreg_id = "All",
          mesoreg_name = "All",
          microreg_id = "All",
          microreg_name = "All",
          municipality_id = "All",
          municipality_name = "All")


# filed rename for tables ----

field_rename <- c(State = "state_name", 
                  Municipality = "municipality_name", 
                  Locality = "locality_name",
                  Department = "department_name",
                  Sector = "sect_urb_id",
                  Section = "sect_urb_id",
                  Block = "block_id",
                  Ageb = "ageb_id",
                  District = "district_name",
                  Ward = "ward_name",
                  Region = "reg_name",
                  SubDistrict = "sub.district_name",
                  SubDistrict = "subdistrict_name",
                  City = "townvill_name")

# Define UI for application 
ui <- navbarPage("Socio-economic Data Dashboard",
                 # Mexico Tab ----
                 tabPanel("Mexico",
                          fluidRow(
                            # select entity level
                            column(3,
                                   selectizeInput(inputId = "entity_level",
                                                  label = "Geographical level:",
                                                  choices =  c("state","municipality","locality", "ageb", "block") ,
                                                  selected = "state",
                                                  multiple = FALSE)
                            ),
                            
                            # select group of variable
                            column(3,
                                   selectizeInput(inputId = "variable_group",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group,
                                                  selected = census_variables_group[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable
                            column(3,
                                   selectizeInput(inputId = "variable",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition$variable_name_processed_viz,
                                                  selected = census_variables_definition$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year
                            column(3,
                                   selectizeInput(inputId = "year",
                                                  label = "Year:",
                                                  choices = c("2020", "2010"),
                                                  selected = "2020",
                                                  multiple = FALSE)
                            ),
                            
                            # select state
                            column(3,
                                   selectizeInput(inputId = "state_name",
                                                  label = "State:",
                                                  choices = unique(geo_levels_names$state_name),
                                                  # choices = c("All",unique(geo_levels_names$state_name)),
                                                  selected = "All",
                                                  multiple = FALSE)
                            ),
                            
                            
                            column(3,
                                   selectizeInput(inputId = "municipality_name",
                                                  label = "Municpality:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            ),
                            column(3,
                                   selectizeInput(inputId = "locality_name",
                                                  label = "Locality:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            )
                          ),
                          
                          # plot table
                          column(6,
                                 withSpinner(DT::dataTableOutput("table")),
                                 downloadButton(outputId = "download_tabular_data_mex", 
                                                label = "Download tabular data")
                          ),
                          
                          # plot map
                          column(6,
                                 withSpinner(leafletOutput("census_map", height = 600)),
                                 downloadButton(outputId = "download_geo_data_mex", 
                                                label = "Download Geospatial data")
                          )
                          
                 ),
                 
                 # Colombia Tab ----
                 tabPanel("Colombia",
                          fluidRow(
                            # select entity level ----
                            column(3,
                                   selectizeInput(inputId = "entity_level_col",
                                                  label = "Geographical level:",
                                                  choices =  c("dept","municipality","urban_sect","urban_secc","block") ,
                                                  selected = "dept",
                                                  multiple = FALSE)
                            ),
                            
                            
                            # select group of variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_group_col",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group_col,
                                                  selected = census_variables_group_col[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_col",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition_col$variable_name_processed_viz,
                                                  selected = census_variables_definition_col$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year ----
                            column(3,
                                   selectizeInput(inputId = "year_col",
                                                  label = "Year:",
                                                  choices = c("2018"),
                                                  selected = "2018",
                                                  multiple = FALSE)
                            ),
                            
                            # select department ----
                            column(3,
                                   selectizeInput(inputId = "department_name_col",
                                                  label = "Department:",
                                                  choices = unique(geo_levels_names_col$department_name),
                                                  selected = "All",
                                                  multiple = FALSE)
                            ),
                            
                            
                            column(3,
                                   selectizeInput(inputId = "municipality_name_col",
                                                  label = "Municpality:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            )
                          ),
                          
                          # plot table
                          column(6,
                                 withSpinner(DT::dataTableOutput("table_col")),
                                 # downloadButton(outputId = "downloadData_col", 
                                 #                label = "Download data"),
                                 downloadButton(outputId = "download_tabular_data_col", 
                                                label = "Download tabular data")
                          ),
                          
                          # plot map
                          column(6,
                                 withSpinner(leafletOutput("census_map_col", height = 600)),
                                 downloadButton(outputId = "download_geo_data_col", 
                                                label = "Download Geospatial data")
                          )
                          
                 ),
                 
                 
                 # Brazil Tab ----
                 tabPanel("Brazil",
                          fluidRow(
                            # select entity level ----
                            column(3,
                                   selectizeInput(inputId = "entity_level_bra",
                                                  label = "Geographical level:",
                                                  choices =  c("reg", "state","mesoreg","municipality","weighting_area") ,
                                                  selected = "reg",
                                                  multiple = FALSE)
                            ),
                            
                            
                            # select group of variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_group_bra",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group_bra,
                                                  selected = census_variables_group_bra[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_bra",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition_bra$variable_name_processed_viz,
                                                  selected = census_variables_definition_bra$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year ----
                            column(3,
                                   selectizeInput(inputId = "year_bra",
                                                  label = "Year:",
                                                  choices = c("2010"),
                                                  selected = "2010",
                                                  multiple = FALSE)
                            ),
                            
                            # select region ----
                            column(3,
                                   selectizeInput(inputId = "region_name_bra",
                                                  label = "Region:",
                                                  choices = unique(geo_levels_names_bra$reg_name),
                                                  selected ="All", # unique(geo_levels_names_bra$reg_name)[1], # "All"
                                                  multiple = FALSE)
                            ),
                            
                            # select state ----
                            column(3,
                                   selectizeInput(inputId = "state_name_bra",
                                                  label = "State:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            )
                            
                          ),
                          
                          # Create a new row for the table.----
                          column(6,
                                 withSpinner(DT::dataTableOutput("table_bra")),
                                 downloadButton(outputId = "download_tabular_data_bra", 
                                                label = "Download tabular data")
                          ),
                          column(6,
                                 withSpinner(leafletOutput("census_map_bra",  height = 600)),
                                 downloadButton(outputId = "download_geo_data_bra", 
                                                label = "Download Geospatial data")
                          )
                          
                 ),
                 
                 
                 # India Tab  ----
                 tabPanel("India",
                          fluidRow(
                            # select entity level ----
                            column(3,
                                   selectizeInput(inputId = "entity_level_india",
                                                  label = "Geographical level:",
                                                  choices =  c("state","district","sub-district") ,
                                                  selected = "state",
                                                  multiple = FALSE)
                            ),
                            
                            
                            # select group of variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_group_india",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group_ind,
                                                  selected = census_variables_group_ind[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_india",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition_ind$variable_name_processed_viz,
                                                  selected = census_variables_definition_ind$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year ----
                            column(3,
                                   selectizeInput(inputId = "year_india",
                                                  label = "Year:",
                                                  choices = c("2011"),
                                                  selected = "2011",
                                                  multiple = FALSE)
                            ),
                            
                            # select state ----
                            column(3,
                                   selectizeInput(inputId = "state_name_india",
                                                  label = "State:",
                                                  choices = unique(geo_levels_names_ind_v2$state_name),
                                                  selected = "All",
                                                  multiple = FALSE)
                            ),
                            
                            # select district ----
                            column(3,
                                   selectizeInput(inputId = "district_name_india",
                                                  label = "District:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            ),
                            
                            
                            
                          ),
                          
                          # plot table ----
                          column(6,
                                 withSpinner(DT::dataTableOutput("table_india")),
                                 downloadButton(outputId = "download_tabular_data_india", 
                                                label = "Download Tabular data")
                          ),
                          
                          # plot map ----
                          column(6,
                                 withSpinner(leafletOutput("census_map_india", height = 600)),
                                 downloadButton(outputId = "download_geo_data_india", 
                                                label = "Download Geospatial data")
                          )
                          
                 ),
                 # India dev Tab  ----
                 tabPanel("India-dev",
                          fluidRow(
                            # select entity level ----
                            column(3,
                                   selectizeInput(inputId = "entity_level_india_dev",
                                                  label = "Geographical level:",
                                                  choices =  c("state","district","subdistrict", "city", "ward") ,
                                                  selected = "state",
                                                  multiple = FALSE)
                            ),
                            
                            
                            # select group of variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_group_india_dev",
                                                  label = "Census variable theme:",
                                                  choices = census_variables_group_ind_dev,
                                                  selected = census_variables_group_ind_dev[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select variable ----
                            column(3,
                                   selectizeInput(inputId = "variable_india_dev",
                                                  label = "Census variable:",
                                                  choices = census_variables_definition_ind_dev$variable_name_processed_viz,
                                                  selected = census_variables_definition_ind_dev$variable_name_processed_viz[1],
                                                  multiple = TRUE)
                            ),
                            
                            # select year ----
                            column(3,
                                   selectizeInput(inputId = "year_india_dev",
                                                  label = "Year:",
                                                  choices = c("2011"),
                                                  selected = "2011",
                                                  multiple = FALSE)
                            ),
                            
                            # select state ----
                            column(3,
                                   selectizeInput(inputId = "state_name_india_dev",
                                                  label = "State:",
                                                  choices = unique(geo_levels_names_ind_dev$state_name),
                                                  selected = "All",
                                                  multiple = FALSE)
                            ),
                            
                            # select district ----
                            column(3,
                                   selectizeInput(inputId = "district_name_india_dev",
                                                  label = "District:",
                                                  choices =  NULL,
                                                  multiple = FALSE)
                            ),
                            
                            
                            
                          ),
                          
                          # plot table ----
                          column(6,
                                 withSpinner(DT::dataTableOutput("table_india_dev")),
                                 downloadButton(outputId = "download_tabular_data_india_dev", 
                                                label = "Download Tabular data")
                          ),
                          
                          # plot map ----
                          column(6,
                                 withSpinner(leafletOutput("census_map_india_dev", height = 600)),
                                 downloadButton(outputId = "download_geo_data_india_dev", 
                                                label = "Download Geospatial data")
                          )
                          
                 )
                 
)



# Define server -----
server <- function(input, output, session) {
  
  # Mexico ----
  
  # Update municipality list based on selected state ----
  observeEvent(input$state_name,{
    updateSelectInput(session,
                      'municipality_name',
                      choices=c("All", unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "municipality_name"])),
                      selected = "All",
    )
  })
  
  # Update locality list based on selected state ----
  observeEvent(input$state_name,{
    updateSelectInput(session,
                      'locality_name',
                      choices=c("All",
                                unique(geo_levels_names[geo_levels_names$state_name==input$state_name, "locality_name"])),
                      selected = "All",
    )
  })
  
  # Update locality list based on selected municipality_
  observeEvent(input$municipality_name,{
    updateSelectInput(session,
                      'locality_name',
                      choices=c("All",
                                unique(geo_levels_names[geo_levels_names$state_name==input$state_name & geo_levels_names$municipality_name==input$municipality_name, "locality_name"])),
                      selected = "All",
    )
  })
  
  # Update variable list based on selected group of variables
  observeEvent(input$variable_group,{
    updateSelectInput(session,
                      'variable',
                      choices= unique(census_variables_definition[census_variables_definition$variable_category %in% input$variable_group, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition[census_variables_definition$variable_category %in% input$variable_group, "variable_name_processed_viz"])[1],
    )
  })
  
  # Colombia ----
  
  # Update municipality list based on selected state ----
  observeEvent(input$department_name_col,{
    updateSelectInput(session,
                      'municipality_name_col',
                      choices=c("All", unique(geo_levels_names_col[geo_levels_names_col$department_name==input$department_name_col, "municipality_name"])),
                      selected = "All",
    )
  })
  
  # Update variable list based on selected group of variables ----
  observeEvent(input$variable_group_col,{
    updateSelectInput(session,
                      'variable_col',
                      choices= unique(census_variables_definition_col[census_variables_definition_col$variable_category %in% input$variable_group_col, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_col[census_variables_definition_col$variable_category %in% input$variable_group_col, "variable_name_processed_viz"])[1],
    )
  })
  
  
  # Brazil ----
  
  # Update state list based on selected region ----
  observeEvent(input$region_name_bra,{
    updateSelectInput(session,
                      'state_name_bra',
                      choices=c("All", unique(geo_levels_names_bra[geo_levels_names_bra$reg_name==input$region_name_bra, "state_name"])),
                      selected = "All",
                      # choices= unique(geo_levels_names_bra[geo_levels_names_bra$state_name==input$state_name_bra, "state_name"]),
                      # # selected = "All",
                      
    )
    
  })
  
  
  # Update variable list based on selected group of variabless ----
  observeEvent(input$variable_group_bra,{
    updateSelectInput(session,
                      'variable_bra',
                      choices= unique(census_variables_definition_bra[census_variables_definition_bra$variable_category %in% input$variable_group_bra, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_bra[census_variables_definition_bra$variable_category %in% input$variable_group_bra, "variable_name_processed_viz"])[1],
    )
  })
  
  # India ----
  
  # Update variable list based on selected group of variables ----
  observeEvent(input$variable_group_india,{
    updateSelectInput(session,
                      'variable_india',
                      choices= unique(census_variables_definition_ind[census_variables_definition_ind$variable_category %in% input$variable_group_india, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_ind[census_variables_definition_ind$variable_category %in% input$variable_group_india, "variable_name_processed_viz"])[1],
    )
  })
  
  # Update district list based on selected state ----
  observeEvent(input$state_name_india,{
    updateSelectInput(session,
                      'district_name_india',
                      choices=c("All", unique(geo_levels_names_ind_v2[geo_levels_names_ind_v2$state_name==input$state_name_india, "district_name"])),
                      selected = "All"
                      
    )
    
  })
  
  # India dev ----
  
  # Update variable list based on selected group of variables ----
  observeEvent(input$variable_group_india_dev,{
    updateSelectInput(session,
                      'variable_india_dev',
                      choices= unique(census_variables_definition_ind_dev[census_variables_definition_ind_dev$variable_category %in% input$variable_group_india_dev, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_ind_dev[census_variables_definition_ind_dev$variable_category %in% input$variable_group_india_dev, "variable_name_processed_viz"])[1],
    )
  })
  
  # Update district list based on selected state ----
  observeEvent(input$state_name_india_dev,{
    updateSelectInput(session,
                      'district_name_india_dev',
                      choices=c("All", unique(geo_levels_names_ind_dev[geo_levels_names_ind_dev$state_name==input$state_name_india_dev, "district_name"])),
                      selected = "All"
                      
    )
    
  })
  
  observe({
    
    input$active_tab
    
    ################################################
    # Mexico -----
    ################################################
    
    # get selected year ----
    selected_year = input$year
    
    # read census variables definition ----
    
    census_variables_definition = read.csv(paste(s3_path, "data/", env, "/",country,"/census/",selected_year,"/census_variables_definition.csv",sep = ""))
    census_variables_group = unique(census_variables_definition$variable_category)
    
    
    # geographical level names ----
    
    geo_levels_names = data.table::fread(paste(s3_path, "data/",env,"/",country,"/boundaries/",selected_year,"/geo_levels_names.csv",sep = ""),
                                         sep = ",",
                                         header = TRUE,
                                         colClasses = c('state_name'='character',
                                                        'state_code'='character',
                                                        'municipality_name'='character',
                                                        'locality_name'='character'))
    geo_levels_names = as.data.frame(geo_levels_names)
    
    
    
    # get selected level ----
    selected_level = input$entity_level
    
    # get selected state ----
    selected_state = input$state_name
    print(selected_state)
    
    # get selected state code ----
    state_code = geo_levels_names %>% 
      filter(state_name == selected_state) %>% 
      distinct(state_code) %>% 
      as.character()
    print(state_code)
    
    
    data_path = paste(s3_path,
                      "data/",env,"/",country,"/census_geo/",selected_year,"/",
                      selected_level,
                      "/",
                      state_code,
                      "/census_geo.geojson",
                      sep = "")
    
    census_geo = st_read(data_path)
    
    selected_variable_viz = input$variable
    
    selected_variable = census_variables_definition %>% 
      filter(variable_name_processed_viz %in% selected_variable_viz) %>% 
      pull(variable_name_processed)
    
    if (input$entity_level == "state") {
      
      data_filtered = census_geo %>% 
        select("state_name", selected_variable) 
      
      geo_name = data_filtered$state_name
      
      
    }
    
    if (input$entity_level == "municipality") {
      
      
      if(input$municipality_name == "All"){
        data_filtered = census_geo %>% 
          # filter(state_name == input$state_name) %>% 
          select("state_name","municipality_name", selected_variable)
        geo_name = data_filtered$municipality_name
      } else {
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("state_name","municipality_name", selected_variable)
        geo_name = data_filtered$municipality_name
      }
      
    }
    
    if (input$entity_level == "locality") {
      
      if(input$municipality_name == "All" & input$locality_name == "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("state_name","municipality_name","locality_name", selected_variable)
        geo_name = data_filtered$locality_name
      } else if (input$municipality_name != "All" & input$locality_name == "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("state_name","municipality_name","locality_name", selected_variable)
        geo_name = data_filtered$locality_name
      } else if (input$municipality_name != "All" & input$locality_name != "All"){
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name,
                 locality_name == input$locality_name) %>% 
          select("state_name","municipality_name","locality_name", selected_variable)
        geo_name = data_filtered$locality_name
      } 
    }
    
    if (input$entity_level == "ageb") {
      
      if(input$municipality_name == "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("state_name","municipality_name","locality_name","ageb_id", selected_variable)
        
        geo_name = data_filtered$ageb_id
        
      } else if (input$municipality_name != "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("state_name","municipality_name","locality_name","ageb_id", selected_variable)
        
        geo_name = data_filtered$ageb_id
        
      } else if (input$municipality_name != "All" & input$locality_name != "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name,
                 locality_name == input$locality_name) %>% 
          select("state_name","municipality_name","locality_name","ageb_id", selected_variable)
        
        geo_name = data_filtered$ageb_id
      } 
    }
    
    if (input$entity_level == "block") {
      
      if(input$municipality_name == "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name) %>% 
          select("state_name","municipality_name","locality_name", "block_id",selected_variable) 
        
        geo_name = data_filtered$block_id
        
      } else if (input$municipality_name != "All" & input$locality_name == "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name) %>% 
          select("state_name","municipality_name","locality_name","block_id", selected_variable)
        
        geo_name = data_filtered$block_id
        
      } else if (input$municipality_name != "All" & input$locality_name != "All"){
        
        data_filtered = census_geo %>% 
          filter(state_name == input$state_name,
                 municipality_name == input$municipality_name,
                 locality_name == input$locality_name) %>% 
          select("state_name","municipality_name","locality_name","block_id",  selected_variable)
        
        geo_name = data_filtered$block_id
      } 
    }
    
    
    # table -----
    
    data_filtered_table = data_filtered %>% 
      as.data.frame() %>% 
      select(-geometry) %>% 
      rename(any_of(field_rename))
    
    # change variable names
    col_variable_idx = which(names(data_filtered_table) %in% selected_variable)
    colnames(data_filtered_table)[col_variable_idx] = selected_variable_viz
    
    # plot table
    output$table <- DT::renderDataTable(DT::datatable(
      data_filtered_table,
      filter = 'top',
      options = list(paging = TRUE,    
                     pageLength = 10,  
                     scrollX = TRUE,   
                     scrollY = TRUE,   
                     autoWidth = TRUE, 
                     server = FALSE)
    ))
    
    # output data to download ----
    output$download_tabular_data_mex <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table, file)
      }
    )
    
    
    
    # map ----
    
    
    # base map 
    m = leaflet(data_filtered) %>% 
      addTiles() %>% 
      fitBounds(~as.numeric(st_bbox(census_geo)[1]),
                ~as.numeric(st_bbox(census_geo)[2]),
                ~as.numeric(st_bbox(census_geo)[3]),
                ~as.numeric(st_bbox(census_geo)[4])) %>% 
      addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") 
    
    
    # plot census map layers
    layer_map = c()
    
    for(i in 1:length(selected_variable_viz)){
      
      selected_variable_map = selected_variable_viz[i]
      print(i) 
      print(selected_variable_map)
      
      selected_variable = census_variables_definition %>% 
        filter(variable_name_processed_viz %in% selected_variable_map) %>% 
        pull(variable_name_processed)
      print(selected_variable)
      
      
      census_variable_values = data_filtered %>%
        as.data.frame() %>%
        pull(selected_variable)
      
      # define pal
      
      
      if(selected_variable_map == "Marginalization level"){
        pal_census <- colorFactor(palette = c("#145A32","#2ECC71","#F4D03F","#E67E22","#C0392B"), 
                                  levels = c("Muy alto","Alto","Medio","Bajo","Muy bajo"),
                                  na.color = "transparent",
                                  revers = TRUE)
      } else if(selected_variable_map == "Marginalization index"){
        pal_census<- colorNumeric("RdYlBu",
                                  census_variable_values,
                                  na.color = "transparent",
                                  reverse = FALSE)
      } else{
        pal_census<- colorNumeric("RdYlBu",
                                  census_variable_values,
                                  na.color = "transparent",
                                  reverse = TRUE)
      }
      
      
      # define labels information
      labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                              "Census variable", selected_variable_map,
                              "Value", census_variable_values,
                              "Name", geo_name) %>%
        lapply(htmltools::HTML)
      
      m = m %>%
        addPolygons(data = data_filtered[,selected_variable],
                    group = selected_variable_map,
                    fillColor = ~pal_census(census_variable_values),
                    weight = 0.1,
                    opacity = 1,
                    color = "grey",
                    fillOpacity = 0.9,
                    label = labels_cesus,
                    highlightOptions = highlightOptions(color = "black", weight = 2,
                                                        bringToFront = FALSE),
                    labelOptions = labelOptions(
                      style = list("font-weight" = "normal", padding = "3px 6px"),
                      textsize = "15px",
                      direction = "auto")) 
      
      
      if(selected_variable_map == "Marginalization level"){
        m = m %>%
          addLegend(colors =  c("#145A32","#2ECC71","#F4D03F","#E67E22","#C0392B"),
                    labels = c("Muy bajo",
                               "Bajo",
                               "Medio",
                               "Alto",
                               "Muy alto"),
                    opacity = 0.9,
                    title = selected_variable_map,
                    group = selected_variable_map,
                    position = "bottomright",
                    labFormat = labelFormat(suffix = ""))
      } else{
        m = m %>%
          addLegend(pal = pal_census,
                    values = census_variable_values,
                    opacity = 0.9,
                    title = selected_variable_map,
                    group = selected_variable_map,
                    position = "bottomright",
                    labFormat = labelFormat(suffix = ""))
      }
      
      layer_map = c(layer_map,selected_variable_map)
      
      m = m %>%
        # Layers control ----
      addLayersControl(
        overlayGroups = layer_map,
        baseGroups = c("OSM","Toner Lite", "CartoDB"),
        options = layersControlOptions(collapsed = FALSE)
      ) 
      
    }
    
    # render map
    output$census_map <- renderLeaflet({
      m %>% 
        hideGroup(layer_map[-length(layer_map)]) 
      
    })
    
    # download geospatial data
    output$download_geo_data_mex <- downloadHandler(
      filename = function() {
        paste("data-geo-", Sys.Date(), ".geojson", sep="")
      },
      content = function(file) {
        st_write(data_filtered, file, driver = "GeoJSON")
      }
    )
    
    ################################################
    # Colombia -----
    ################################################
    
    # get selected year ----
    selected_year_col = input$year_col
    
    
    # get selected level ----
    selected_level_col = input$entity_level_col
    
    # get selected department ----
    selected_department = input$department_name_col
    print(selected_department)
    
    # get selected department code ----
    department_code = geo_levels_names_col %>%
      filter(department_name == selected_department) %>%
      distinct(dept_id) %>%
      as.character()
    print(department_code)
    
    
    data_path_col = paste(s3_path,
                          "data/",env,"/","colombia","/census_geo/",
                          selected_level_col,
                          "/",
                          department_code,
                          "/census_geo.geojson",
                          sep = "")
    
    census_geo_col = st_read(data_path_col)
    
    
    
    selected_variable_viz_col = input$variable_col
    
    selected_variable_col = census_variables_definition_col %>%
      filter(variable_name_processed_viz %in% selected_variable_viz_col) %>%
      pull(variable_name_processed)
    
    # filter data state ----
    
    # department level
    if (input$entity_level_col == "dept") {
      
      data_filtered_col = census_geo_col %>%
        select("department_name", selected_variable_col)
      
      geo_name_col = data_filtered_col$department_name
      
      
      
    }
    
    # municipality level
    if (input$entity_level_col == "municipality") {
      
      
      if(input$municipality_name_col == "All"){
        
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col) %>% 
          select("department_name","municipality_name", selected_variable_col)
        geo_name_col = data_filtered_col$municipality_name
      } else {
        
        
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col,
                 municipality_name == input$municipality_name_col) %>% 
          select("department_name","municipality_name", selected_variable_col)
        geo_name_col = data_filtered_col$municipality_name
      }
      
    }
    
    
    
    
    # urban sector level
    if (input$entity_level_col == "urban_sect") {
      
      
      if(input$municipality_name_col == "All"){
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col) %>% 
          select("department_name","municipality_name", "sect_urb_id",selected_variable_col)
        geo_name_col = data_filtered_col$sect_urb_id
      } else {
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col,
                 municipality_name == input$municipality_name_col) %>% 
          select("department_name","municipality_name", "sect_urb_id",selected_variable_col)
        geo_name_col = data_filtered_col$sect_urb_id
      }
      
    }
    
    # urban section level
    if (input$entity_level_col == "urban_secc") {
      
      
      if(input$municipality_name_col == "All"){
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col) %>% 
          select("department_name","municipality_name", "sect_urb_id","secc_urb_id",selected_variable_col)
        geo_name_col = data_filtered_col$secc_urb_id
      } else {
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col,
                 municipality_name == input$municipality_name_col) %>% 
          select("department_name","municipality_name", "sect_urb_id","secc_urb_id",selected_variable_col)
        geo_name_col = data_filtered_col$secc_urb_id
      }
      
    }
    
    # Block level
    if (input$entity_level_col == "block") {
      
      
      if(input$municipality_name_col == "All"){
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col) %>% 
          select("department_name","municipality_name", "sect_urb_id","secc_urb_id","block_id",selected_variable_col)
        geo_name_col = data_filtered_col$block_id
      } else {
        data_filtered_col = census_geo_col %>% 
          filter(department_name == input$department_name_col,
                 municipality_name == input$municipality_name_col) %>% 
          select("department_name","municipality_name", "sect_urb_id","secc_urb_id","block_id",selected_variable_col)
        geo_name_col = data_filtered_col$block_id
      }
      
    }
    
    
    
    # table ----
    
    
    data_filtered_table_col = data_filtered_col %>%
      as.data.frame() %>%
      select(-geometry) %>% 
      rename(any_of(field_rename))
    
    
    # change variable names
    col_variable_idx_col = which(names(data_filtered_table_col) %in% selected_variable_col)
    colnames(data_filtered_table_col)[col_variable_idx_col] = selected_variable_viz_col
    
    # plot table
    output$table_col <- DT::renderDataTable(DT::datatable(
      data_filtered_table_col,
      filter = 'top',
      options = list(paging = TRUE,
                     pageLength = 10,
                     scrollX = TRUE,
                     scrollY = TRUE,
                     autoWidth = TRUE,
                     server = FALSE)
    ))
    
    # output data to download ----
    
    output$download_tabular_data_col <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table_col, file)
      }
    )
    
    # base map  ----
    m_col = leaflet(data_filtered_col) %>% 
      addTiles() %>% 
      fitBounds(~as.numeric(st_bbox(data_filtered_col)[1]),
                ~as.numeric(st_bbox(data_filtered_col)[2]),
                ~as.numeric(st_bbox(data_filtered_col)[3]),
                ~as.numeric(st_bbox(data_filtered_col)[4])) %>% 
      addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite")
    
    
    # plot census map layers ----
    layer_map_col = c()
    
    for(i in 1:length(selected_variable_viz_col)){
      
      selected_variable_map_col = selected_variable_viz_col[i]
      
      selected_variable_col = census_variables_definition_col %>% 
        filter(variable_name_processed_viz %in% selected_variable_map_col) %>% 
        pull(variable_name_processed)
      
      
      census_variable_values_col = data_filtered_col %>%
        as.data.frame() %>%
        pull(selected_variable_col)
      
      # define pal
      pal_census_col<- colorNumeric("RdYlBu",
                                    census_variable_values_col,
                                    na.color = "transparent",
                                    reverse = TRUE)
      
      
      # define labels information
      labels_census_col <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                   "Census variable", selected_variable_map_col,
                                   "Value", census_variable_values_col,
                                   "Name", geo_name_col) %>%
        lapply(htmltools::HTML)
      
      m_col = m_col %>%
        addPolygons(data = data_filtered_col[,selected_variable_col],
                    group = selected_variable_map_col,
                    fillColor = ~pal_census_col(census_variable_values_col),
                    weight = 0.1,
                    opacity = 1,
                    color = "grey",
                    fillOpacity = 0.9,
                    label = labels_census_col,
                    highlightOptions = highlightOptions(color = "black", weight = 2,
                                                        bringToFront = FALSE),
                    labelOptions = labelOptions(
                      style = list("font-weight" = "normal", padding = "3px 6px"),
                      textsize = "15px",
                      direction = "auto"))
      
      m_col = m_col %>%
        addLegend(pal = pal_census_col,
                  values = census_variable_values_col,
                  opacity = 0.9,
                  title = selected_variable_map_col,
                  group = selected_variable_map_col,
                  position = "bottomright",
                  labFormat = labelFormat(suffix = ""))
      
      
      layer_map_col = c(layer_map_col,selected_variable_map_col)
      
      m_col = m_col %>%
        # Layers control ----
      addLayersControl(
        overlayGroups = layer_map_col,
        baseGroups = c("OSM","Toner Lite", "CartoDB"),
        options = layersControlOptions(collapsed = FALSE)
      )
      
    }
    
    # render map
    output$census_map_col <- renderLeaflet({
      m_col %>% 
        hideGroup(layer_map_col[-length(layer_map_col)]) 
      
    })
    
    # download geospatial data ----
    output$download_geo_data_col <- downloadHandler(
      filename = function() {
        paste("data-geo-", Sys.Date(), ".geojson", sep="")
      },
      content = function(file) {
        st_write(data_filtered_col, file, driver = "GeoJSON")
      }
    )
    
    
    
    ################################################
    # Brazil -----
    ################################################
    
    # get selected year ----
    selected_year_bra = input$year_bra
    
    
    # get selected level ----
    selected_level_bra = input$entity_level_bra
    
    # get selected region
    selected_region_bra = input$region_name_bra
    region_code_bra = geo_levels_names_bra %>%
      filter(reg_name == selected_region_bra) %>%
      distinct(reg_id) %>%
      as.character()
    print(region_code_bra)
    
    # read data ----
    
    data_path_bra = paste(s3_path,
                          "data/",env,"/","brazil","/census_geo/",
                          selected_level_bra,
                          # "reg",
                          "/",
                          region_code_bra,
                          "/census_geo.geojson",
                          sep = "")
    
    census_geo_bra = st_read(data_path_bra)
    
    # select census variable ----
    
    selected_variable_viz_bra = input$variable_bra
    
    selected_variable_bra = census_variables_definition_bra %>%
      filter(variable_name_processed_viz %in% selected_variable_viz_bra) %>%
      pull(variable_name_processed)
    
    # filter data  ----
    
    
    # region level ----
    if (input$entity_level_bra == "reg") {
      
      data_filtered_bra = census_geo_bra %>%
        select("reg_name", selected_variable_bra)
      
      geo_name_bra = data_filtered_bra$reg_name
      
    }
    
    
    # state level ----
    if (input$entity_level_bra == "state") {
      
      
      if(input$state_name_bra == "All"){
        data_filtered_bra = census_geo_bra %>% 
          # filter(reg_name == input$region_name_bra) %>% 
          select("reg_name","state_name", selected_variable_bra)
        geo_name_bra = data_filtered_bra$state_name
      } else {
        data_filtered_bra = census_geo_bra %>% 
          filter(reg_name == input$region_name_bra,
                 state_name == input$state_name_bra) %>% 
          select("reg_name","state_name", selected_variable_bra)
        geo_name_bra = data_filtered_bra$state_name
      }
      
    }
    
    # mesoreg level ----
    if (input$entity_level_bra == "mesoreg") {
      
      
      if(input$state_name_bra == "All"){
        data_filtered_bra = census_geo_bra %>%
          # filter(reg_name == input$region_name_bra) %>%
          select("reg_name","state_name", "mesoreg_name",selected_variable_bra)
        geo_name_bra = data_filtered_bra$mesoreg_name
      } else {
        data_filtered_bra = census_geo_bra %>%
          filter(reg_name == input$region_name_bra,
                 state_name == input$state_name_bra) %>%
          select("reg_name","state_name",  "mesoreg_name",selected_variable_bra)
        geo_name_bra = data_filtered_bra$mesoreg_name
      }
      
    }
    
    # microreg level ----
    if (input$entity_level_bra == "microreg") {
      
      
      if(input$state_name_bra == "All"){
        data_filtered_bra = census_geo_bra %>%
          # filter(reg_name == input$region_name_bra) %>%
          select("reg_name","state_name", "microreg_name",selected_variable_bra)
        geo_name_bra = data_filtered_bra$mesoreg_name
      } else {
        data_filtered_bra = census_geo_bra %>%
          filter(reg_name == input$region_name_bra,
                 state_name == input$state_name_bra) %>%
          select("reg_name","state_name",  "microreg_name",selected_variable_bra)
        geo_name_bra = data_filtered_bra$mesoreg_name
      }
      
    }
    
    # municipality level ----
    if (input$entity_level_bra == "municipality") {
      
      
      if(input$state_name_bra == "All"){
        data_filtered_bra = census_geo_bra %>% 
          filter(reg_name == input$region_name_bra) %>% 
          select("reg_name","state_name", "municipality_name",selected_variable_bra)
        geo_name_bra = data_filtered_bra$municipality_name
      } else {
        data_filtered_bra = census_geo_bra %>% 
          filter(reg_name == input$region_name_bra,
                 state_name == input$state_name_bra) %>% 
          select("reg_name","state_name",  "municipality_name",selected_variable_bra)
        geo_name_bra = data_filtered_bra$municipality_name
      }
      
    }
    
    # weighting_area level ----
    if (input$entity_level_bra == "weighting_area") {
      
      
      if(input$state_name_bra == "All"){
        data_filtered_bra = census_geo_bra %>% 
          # filter(reg_name == input$region_name_bra) %>% 
          select("reg_name","state_name","mesoreg_name","microreg_name","municipality_name", "weighting_area_id",selected_variable_bra)
        geo_name_bra = data_filtered_bra$weighting_area_id
      } else {
        data_filtered_bra = census_geo_bra %>% 
          filter(reg_name == input$region_name_bra,
                 state_name == input$state_name_bra) %>% 
          select("reg_name","state_name","mesoreg_name","microreg_name","municipality_name", "weighting_area_id",selected_variable_bra)
        geo_name_bra = data_filtered_bra$weighting_area_id
      }
      
    }
    
    
    # table ----
    
    data_filtered_table_bra = data_filtered_bra %>% 
      as.data.frame() %>% 
      select(-geometry) %>% 
      rename(any_of(field_rename))
    
    # change variable names
    col_variable_idx_bra = which(names(data_filtered_table_bra) %in% selected_variable_bra)
    colnames(data_filtered_table_bra)[col_variable_idx_bra] = selected_variable_viz_bra
    
    # plot table
    output$table_bra <- DT::renderDataTable(DT::datatable(
      data_filtered_table_bra,
      filter = 'top',
      options = list(paging = TRUE,
                     pageLength = 10,
                     scrollX = TRUE,
                     scrollY = TRUE,
                     autoWidth = TRUE,
                     server = FALSE)
    ))
    
    
    # output data to download ----
    output$download_tabular_data_bra <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table_bra, file)
      }
    )
    
    
    
    # base map  ----
    m_bra = leaflet(data_filtered_bra) %>%
      addTiles() %>%
      fitBounds(~as.numeric(st_bbox(data_filtered_bra)[1]),
                ~as.numeric(st_bbox(data_filtered_bra)[2]),
                ~as.numeric(st_bbox(data_filtered_bra)[3]),
                ~as.numeric(st_bbox(data_filtered_bra)[4])) %>%
      addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite")
    
    
    # plot census map layers ----
    layer_map_bra = c()
    
    for(i in 1:length(selected_variable_viz_bra)){
      
      selected_variable_map_bra = selected_variable_viz_bra[i]
      
      selected_variable_bra = census_variables_definition_bra %>%
        filter(variable_name_processed_viz %in% selected_variable_map_bra) %>%
        pull(variable_name_processed)
      
      
      census_variable_values_bra = data_filtered_bra %>%
        as.data.frame() %>%
        pull(selected_variable_bra)
      
      # define pal
      pal_census_bra <- colorNumeric("RdYlBu",
                                     census_variable_values_bra,
                                     na.color = "transparent",
                                     reverse = TRUE)
      
      
      # define labels information
      labels_census_bra <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                   "Census variable", selected_variable_map_bra,
                                   "Value", census_variable_values_bra,
                                   "Name", geo_name_bra) %>%
        lapply(htmltools::HTML)
      
      m_bra = m_bra %>%
        addPolygons(data = data_filtered_bra[,selected_variable_bra],
                    group = selected_variable_map_bra,
                    fillColor = ~pal_census_bra(census_variable_values_bra),
                    weight = 0.1,
                    opacity = 1,
                    color = "grey",
                    fillOpacity = 0.9,
                    label = labels_census_bra,
                    highlightOptions = highlightOptions(color = "black", weight = 2,
                                                        bringToFront = FALSE),
                    labelOptions = labelOptions(
                      style = list("font-weight" = "normal", padding = "3px 6px"),
                      textsize = "15px",
                      direction = "auto"))
      
      m_bra = m_bra %>%
        addLegend(pal = pal_census_bra,
                  values = census_variable_values_bra,
                  opacity = 0.9,
                  title = selected_variable_map_bra,
                  group = selected_variable_map_bra,
                  position = "bottomright",
                  labFormat = labelFormat(suffix = ""))
      
      
      layer_map_bra = c(layer_map_bra,selected_variable_map_bra)
      
      m_bra = m_bra %>%
        # Layers control ----
      addLayersControl(
        overlayGroups = layer_map_bra,
        baseGroups = c("OSM","Toner Lite", "CartoDB"),
        options = layersControlOptions(collapsed = FALSE)
      )
      
    }
    
    # render map
    output$census_map_bra <- renderLeaflet({
      m_bra %>% 
        hideGroup(layer_map_bra[-length(layer_map_bra)])
      
    })
    
    
    # download geospatial data ----
    output$download_geo_data_bra <- downloadHandler(
      filename = function() {
        paste("data-geo-", Sys.Date(), ".geojson", sep="")
      },
      content = function(file) {
        st_write(data_filtered_bra, file, driver = "GeoJSON")
      }
    )
    
    
    ################################################
    # India  -----
    ################################################
    
    # get selected year ----
    selected_year_india = input$year_india
    
    
    # get selected level ----
    selected_level_india = input$entity_level_india
    
    # get selected region
    selected_state_india = input$state_name_india
    state_code_india = geo_levels_names_ind_v2 %>%
      filter(state_name == selected_state_india) %>%
      distinct(state_id) %>%
      as.character()
    print(state_code_india)
    
    # read data ----
    
    data_path_india = paste(s3_path,
                            "data/",env,"/","india","/census_geo/2011/",
                            selected_level_india,
                            "/",
                            state_code_india,
                            "/census_geo.geojson",
                            sep = "")
    
    census_geo_india = st_read(data_path_india)
    
    print("census_geo_india")
    print(head(census_geo_india))
    
    # select census variable ----
    
    selected_variable_viz_india = input$variable_india
    
    selected_variable_india = census_variables_definition_ind %>% 
      filter(variable_name_processed_viz %in% selected_variable_viz_india) %>% 
      pull(variable_name_processed)
    
    
    # filter data  ----
    
    
    # state level ----
    if (input$entity_level_india == "state") {
      
      data_filtered_india = census_geo_india %>%
        select("state_name", selected_variable_india)
      
      geo_name_india = data_filtered_india$state_name
      
    }
    
    # district level ----
    
    if (input$entity_level_india == "district") {
      if(input$district_name_india == "All"){
        data_filtered_india = census_geo_india %>% 
          select("state_name","district_name", selected_variable_india)
        geo_name_india = data_filtered_india$district_name
      } else {
        data_filtered_india = census_geo_india %>% 
          filter(state_name == input$state_name_india,
                 district_name == input$district_name_india) %>%
          # filter(state_name == input$state_name_india) %>% 
          select("state_name","district_name", selected_variable_india)
        geo_name_india = data_filtered_india$district_name
      }
    }
    
    # sub-district level ----
    
    if (input$entity_level_india == "sub-district") {
      if(input$district_name_india == "All"){
        data_filtered_india = census_geo_india %>% 
          select("state_name","district_name","sub.district_name", selected_variable_india)
        geo_name_india = data_filtered_india$sub.district_name
      } else {
        data_filtered_india = census_geo_india %>% 
          filter(state_name == input$state_name_india,
                 district_name == input$district_name_india) %>%
          select("state_name","district_name","sub.district_name", selected_variable_india)
        geo_name_india = data_filtered_india$sub.district_name
      }
    }
    
    # city level ----
    
    if (input$entity_level_india == "city") {
      if(input$district_name_india == "All"){
        data_filtered_india = census_geo_india %>% 
          select("state_name",
                 "district_name","sub.district_name", selected_variable_india)
        geo_name_india = data_filtered_india$sub.district_name
      } else {
        data_filtered_india = census_geo_india %>% 
          filter(state_name == input$state_name_india,
                 district_name == input$district_name_india) %>%
          select("state_name","district_name","sub.district_name", selected_variable_india)
        geo_name_india = data_filtered_india$sub.district_name
      }
    }
    
    
    # table ----
    
    data_filtered_table_india = data_filtered_india %>% 
      as.data.frame() %>% 
      select(-geometry) %>% 
      rename(any_of(field_rename))
    
    # change variable names
    col_variable_idx_india = which(names(data_filtered_table_india) %in% selected_variable_india)
    colnames(data_filtered_table_india)[col_variable_idx_india] = selected_variable_viz_india
    
    # plot table
    output$table_india <- DT::renderDataTable(DT::datatable(
      data_filtered_table_india,
      filter = 'top',
      options = list(paging = TRUE,
                     pageLength = 10,
                     scrollX = TRUE,
                     scrollY = TRUE,
                     autoWidth = TRUE,
                     server = FALSE)
    ))
    
    # output tabular data to download ----
    output$download_tabular_data_india <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table_india, file)
      }
    )
    
    # base map  ----
    m_india = leaflet(data_filtered_india) %>%
      addTiles() %>%
      fitBounds(~as.numeric(st_bbox(data_filtered_india)[1]),
                ~as.numeric(st_bbox(data_filtered_india)[2]),
                ~as.numeric(st_bbox(data_filtered_india)[3]),
                ~as.numeric(st_bbox(data_filtered_india)[4])) %>%
      addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite")
    
    
    # plot census map layers ----
    layer_map_india = c()
    
    for(i in 1:length(selected_variable_viz_india)){
      
      selected_variable_map_india = selected_variable_viz_india[i]
      
      selected_variable_india = census_variables_definition_ind %>%
        filter(variable_name_processed_viz %in% selected_variable_map_india) %>%
        pull(variable_name_processed)
      
      
      census_variable_values_india = data_filtered_india %>%
        as.data.frame() %>%
        pull(selected_variable_india)
      
      # define pal
      pal_census_india <- colorNumeric("RdYlBu",
                                       census_variable_values_india,
                                       na.color = "transparent",
                                       reverse = TRUE)
      
      
      # define labels information
      labels_census_india <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                     "Census variable", selected_variable_map_india,
                                     "Value", census_variable_values_india,
                                     "Name", geo_name_india) %>%
        lapply(htmltools::HTML)
      
      m_india = m_india %>%
        addPolygons(data = data_filtered_india[,selected_variable_india],
                    group = selected_variable_map_india,
                    fillColor = ~pal_census_india(census_variable_values_india),
                    weight = 0.1,
                    opacity = 1,
                    color = "grey",
                    fillOpacity = 0.9,
                    label = labels_census_india,
                    highlightOptions = highlightOptions(color = "black", weight = 2,
                                                        bringToFront = FALSE),
                    labelOptions = labelOptions(
                      style = list("font-weight" = "normal", padding = "3px 6px"),
                      textsize = "15px",
                      direction = "auto"))
      
      m_india = m_india %>%
        addLegend(pal = pal_census_india,
                  values = census_variable_values_india,
                  opacity = 0.9,
                  title = selected_variable_map_india,
                  group = selected_variable_map_india,
                  position = "bottomright",
                  labFormat = labelFormat(suffix = ""))
      
      
      layer_map_india = c(layer_map_india,selected_variable_map_india)
      
      m_india = m_india %>%
        # Layers control ----
      addLayersControl(
        overlayGroups = layer_map_india,
        baseGroups = c("OSM","Toner Lite", "CartoDB"),
        options = layersControlOptions(collapsed = FALSE)
      )
      
    }
    
    # render map
    output$census_map_india <- renderLeaflet({
      m_india %>%
        hideGroup(layer_map_india[-length(layer_map_india)])
      
    })
    
    
    # download geospatial data ----
    output$download_geo_data_india <- downloadHandler(
      filename = function() {
        paste("data-geo-", Sys.Date(), ".geojson", sep="")
      },
      content = function(file) {
        st_write(data_filtered_india, file, driver = "GeoJSON")
      }
    )
    
    
    ################################################
    # India  dev -----
    ################################################
    
    # get selected year ----
    selected_year_india_dev = input$year_india_dev
    
    
    # get selected level ----
    selected_level_india_dev = input$entity_level_india_dev
    
    # get selected region
    selected_state_india_dev = input$state_name_india_dev
    state_code_india_dev = geo_levels_names_ind_dev %>%
      filter(state_name == selected_state_india_dev) %>%
      distinct(state_id) %>%
      as.character()
    print(state_code_india_dev)
    
    # read data ----
    
    data_path_india_dev = paste(s3_path,
                                "data/",env,"/","india_2","/census_geo/2011/",
                                selected_level_india_dev,
                                "/",
                                state_code_india_dev,
                                "/census_geo.geojson",
                                sep = "")
    
    census_geo_india_dev = st_read(data_path_india_dev)
    
    
    # select census variable ----
    
    selected_variable_viz_india_dev = input$variable_india_dev
    
    selected_variable_india_dev = census_variables_definition_ind_dev %>% 
      filter(variable_name_processed_viz %in% selected_variable_viz_india_dev) %>% 
      pull(variable_name_processed)
    
    
    # filter data  ----
    
    
    # state level ----
    if (input$entity_level_india_dev == "state") {
      
      data_filtered_india_dev = census_geo_india_dev %>%
        select("state_name", 
               selected_variable_india_dev)
      
      geo_name_india_dev = data_filtered_india_dev$state_name
      
      
    }
    
    # district level ----
    
    if (input$entity_level_india_dev == "district") {
      if(input$district_name_india_dev == "All"){
        data_filtered_india_dev = census_geo_india_dev %>% 
          select("state_name",
                 "district_name", 
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$district_name
      } else {
        data_filtered_india_dev = census_geo_india_dev %>% 
          filter(state_name == input$state_name_india_dev,
                 district_name == input$district_name_india_dev) %>%
          select("state_name",
                 "district_name",
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$district_name
      }
    }
    
    # sub-district level ----
    
    if (input$entity_level_india_dev == "subdistrict") {
      if(input$district_name_india_dev == "All"){
        data_filtered_india_dev = census_geo_india_dev %>% 
          select("state_name",
                 "district_name",
                 "subdistrict_name", 
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$subdistrict_name
      } else {
        data_filtered_india_dev = census_geo_india_dev %>% 
          filter(state_name == input$state_name_india_dev,
                 district_name == input$district_name_india_dev) %>%
          select("state_name",
                 "district_name",
                 "subdistrict_name", 
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$subdistrict_name
      }
    }
    
    # city level ----
    
    if (input$entity_level_india_dev == "city") {
      if(input$district_name_india_dev == "All"){
        data_filtered_india_dev = census_geo_india_dev %>% 
          select("state_name",
                 "district_name",
                 "subdistrict_name", 
                 "townvill_name",
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$townvill_name
      } else {
        data_filtered_india_dev = census_geo_india_dev %>% 
          filter(state_name == input$state_name_india_dev,
                 district_name == input$district_name_india_dev) %>%
          select("state_name",
                 "district_name",
                 "subdistrict_name", 
                 "townvill_name",
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$townvill_name
      }
    }
    
    # city level ----
    
    if (input$entity_level_india_dev == "ward") {
      if(input$district_name_india_dev == "All"){
        data_filtered_india_dev = census_geo_india_dev %>% 
          select("state_name",
                 "district_name",
                 "subdistrict_name", 
                 "townvill_name",
                 "ward_id",
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$ward_id
      } else {
        data_filtered_india_dev = census_geo_india_dev %>% 
          filter(state_name == input$state_name_india_dev,
                 district_name == input$district_name_india_dev) %>%
          select("state_name",
                 "district_name",
                 "subdistrict_name", 
                 "townvill_name",
                 "ward_id",
                 selected_variable_india_dev)
        geo_name_india_dev = data_filtered_india_dev$ward_id
      }
    }
    
    # table ----
    
    data_filtered_table_india_dev = data_filtered_india_dev %>% 
      as.data.frame() %>% 
      select(-geometry) %>% 
      rename(any_of(field_rename))
    
    print(head(data_filtered_table_india_dev))
    
    # change variable names
    col_variable_idx_india_dev = which(names(data_filtered_table_india_dev) %in% selected_variable_india_dev)
    colnames(data_filtered_table_india_dev)[col_variable_idx_india_dev] = selected_variable_viz_india_dev
    
    print(head(data_filtered_table_india_dev))
    
    # plot table
    output$table_india_dev <- DT::renderDataTable(DT::datatable(
      data_filtered_table_india_dev,
      filter = 'top',
      options = list(paging = TRUE,
                     pageLength = 10,
                     scrollX = TRUE,
                     scrollY = TRUE,
                     autoWidth = TRUE,
                     server = FALSE)
    ))
    
    # output tabular data to download ----
    output$download_tabular_data_india_dev <- downloadHandler(
      filename = function() {
        paste("data-", Sys.Date(), ".csv", sep="")
      },
      content = function(file) {
        write.csv(data_filtered_table_india_dev, file)
      }
    )
    
    # base map  ----
    m_india_dev = leaflet(data_filtered_india_dev) %>%
      addTiles() %>%
      fitBounds(~as.numeric(st_bbox(data_filtered_india_dev)[1]),
                ~as.numeric(st_bbox(data_filtered_india_dev)[2]),
                ~as.numeric(st_bbox(data_filtered_india_dev)[3]),
                ~as.numeric(st_bbox(data_filtered_india_dev)[4])) %>%
      # addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      # addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>% 
      addProviderTiles(providers$Esri.WorldGrayCanvas, group = "Esri World Gray") %>% 
      addProviderTiles(providers$Esri.WorldImagery, group = "Esri World Imagery") 
    
    
    
    
    # plot census map layers ----
    layer_map_india_dev = c()
    
    for(i in 1:length(selected_variable_viz_india_dev)){
      
      selected_variable_map_india_dev = selected_variable_viz_india_dev[i]
      
      selected_variable_india_dev = census_variables_definition_ind_dev %>%
        filter(variable_name_processed_viz %in% selected_variable_map_india_dev) %>%
        pull(variable_name_processed)
      
      
      census_variable_values_india_dev = data_filtered_india_dev %>%
        as.data.frame() %>%
        pull(selected_variable_india_dev)
      
      # define pal
      pal_census_india_dev <- colorNumeric("RdYlBu",
                                           census_variable_values_india_dev,
                                           na.color = "transparent",
                                           reverse = TRUE)
      
      
      # define labels information
      labels_census_india_dev <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                         "Census variable", selected_variable_map_india_dev,
                                         "Value", census_variable_values_india_dev,
                                         "Name", geo_name_india_dev) %>%
        lapply(htmltools::HTML)
      
      
      m_india_dev = m_india_dev %>%
        addPolygons(data = data_filtered_india_dev[,selected_variable_india_dev],
                    group = selected_variable_map_india_dev,
                    fillColor = ~pal_census_india_dev(census_variable_values_india_dev),
                    weight = 0.1,
                    opacity = 1,
                    color = "grey",
                    fillOpacity = 0.9,
                    label = labels_census_india_dev,
                    highlightOptions = highlightOptions(color = "black", weight = 2,
                                                        bringToFront = FALSE),
                    labelOptions = labelOptions(
                      style = list("font-weight" = "normal", padding = "3px 6px"),
                      textsize = "15px",
                      direction = "auto"))
      
      m_india_dev = m_india_dev %>%
        addLegend(pal = pal_census_india_dev,
                  values = census_variable_values_india_dev,
                  opacity = 0.9,
                  title = selected_variable_map_india_dev,
                  group = selected_variable_map_india_dev,
                  position = "bottomright",
                  labFormat = labelFormat(suffix = ""))
      
      
      layer_map_india_dev = c(layer_map_india_dev,
                              selected_variable_map_india_dev)
      
      m_india_dev = m_india_dev %>%
        # Layers control ----
      addLayersControl(
        overlayGroups = layer_map_india_dev,
        baseGroups = c( "Esri World Gray","Esri World Imagery"),
        options = layersControlOptions(collapsed = FALSE)
      )
      
    }
    
    # render map
    output$census_map_india_dev <- renderLeaflet({
      m_india_dev %>%
        hideGroup(layer_map_india_dev[-length(layer_map_india_dev)])
      
    })
    
    
    # download geospatial data ----
    output$download_geo_data_india_dev <- downloadHandler(
      filename = function() {
        paste("data-geo-", Sys.Date(), ".geojson", sep="")
      },
      content = function(file) {
        st_write(data_filtered_india_dev, file, driver = "GeoJSON")
      }
    )
    
  })
  
  
}

# Run the application 
shinyApp(ui = ui, 
         server = server)
