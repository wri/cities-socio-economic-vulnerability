
library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)
library(leaflet)
library(leaflet.extras)
library(sf)
library(DT)
library(shinycssloaders)
# library(bslib)






s3_path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/"


# Mexico data ----

env = "dev"
selected_year = "2020"
country = "mexico"
country = "mexico_2"

# read census variables definition 

# mexico
# census_variables_definition_mex = read.csv(paste(s3_path, "data/", env, "/",country,"/census/",selected_year,"/census_variables_definition.csv",sep = ""))
census_variables_definition_mex = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/census/census_variables_definition_v2.csv")
census_variables_group_mex = unique(census_variables_definition_mex$variable_category)


# geographical level names 

# Mexico ----
geo_levels_names_mex = data.table::fread(paste(s3_path, "data/",env,"/",country,"/boundaries/",selected_year,"/geo_levels_names.csv",sep = ""),
                                         sep = ",",
                                         header = TRUE,
                                         colClasses = c('state_name'='character',
                                                        'state_code'='character',
                                                        'municipality_name'='character',
                                                        'locality_name'='character'))
geo_levels_names_mex = as.data.frame(geo_levels_names_mex)


# Brazil data ----


# read census variables definition 

census_variables_definition_bra = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/brazil_2/census/2010/census_variable_definition.csv")
census_variables_group_bra = unique(census_variables_definition_bra$variable_category)


# geographical level names 


geo_levels_names_bra= data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/brazil_2/boundaries/2010/geo_levels_names.csv",
                                        sep = ",",
                                        header = TRUE,
                                        encoding = "Latin-1",
                                        colClasses = c('uf_code'='character',#'state_id'='character',
                                                       'uf_name'='character',#'state_name'='character',
                                                       'reg_code'='character',#'reg_id'='character',
                                                       'reg_name'='character',
                                                       'mesoreg_id'='character',
                                                       'mesoreg_name'='character',
                                                       'microreg_id'='character',
                                                       'microreg_name'='character',
                                                       'mun_id'='character',#'municipality_id'='character',
                                                       'mun_name'='character'#'municipality_name'='character'
                                        ))

geo_levels_names_bra = as.data.frame(geo_levels_names_bra)

geo_levels_names_bra = geo_levels_names_bra %>% 
  add_row(uf_code = "All",#state_id = "All",
          uf_name = "All", #state_name = "All",
          reg_code= "All",#reg_id= "All",
          reg_name = "All",
          mesoreg_id = "All",
          mesoreg_name = "All",
          microreg_id = "All",
          microreg_name = "All",
          mun_id = "All",#municipality_id = "All",
          mun_name = "All" #municipality_name = "All"
  )


# India data ----

# india dev
census_variables_definition_ind = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/india_2/census/2011/census_variables_definition.csv")
census_variables_group_ind = unique(census_variables_definition_ind$variable_category)

geo_levels_names_ind = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/india_2/boundaries/2011/geo_levels_names_v2.csv",
                                         sep = ",",
                                         header = TRUE,
                                         colClasses = c('state_name'='character',
                                                        'state_id'='character',
                                                        'district_name'='character',
                                                        'district_id'='character',
                                                        'subdistrict_name'='character',
                                                        'subdistrict_id'='character'))


geo_levels_names_ind = as.data.frame(geo_levels_names_ind)

geo_levels_names_ind$state_id = str_pad(geo_levels_names_ind$state_id, 2, pad = "0")

geo_levels_names_ind = geo_levels_names_ind %>% 
  add_row(state_id = "All",
          state_name = "All",
          district_id= "All",
          district_name = "All",
          subdistrict_id = "All",
          subdistrict_name = "All")

print(unique(geo_levels_names_ind$state_name))

# colombia data ----


# colombia
# census_variables_definition_col = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_2/census/2018/census_variable_definition.csv")
census_variables_definition_col = read.csv("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_3/census/census_variable_definition.csv")

census_variables_group_col = unique(census_variables_definition_col$variable_category)

geo_levels_names_col= data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_3/boundaries/geo_levels_names.csv",
                                        sep = ",",
                                        header = TRUE,
                                        encoding = "Latin-1",
                                        colClasses = c('mun_name'='character',
                                                       'mun_id'='character',
                                                       'dept_name'='character',
                                                       'dept_code'='character'))

# geo_levels_names_col= data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_2/boundaries/2018/geo_levels_names.csv",
#                                         sep = ",",
#                                         header = TRUE,
#                                         encoding = "Latin-1",
#                                         colClasses = c('mun_name'='character',
#                                                        'mun_id'='character',
#                                                        'dept_name'='character',
#                                                        'dept_code'='character'))


geo_levels_names_col = as.data.frame(geo_levels_names_col)

geo_levels_names_col = geo_levels_names_col %>% 
  add_row(dept_code = "All",
          dept_name = "All",
          mun_id= "All",
          mun_name = "All")

# filed rename for tables ----

field_rename <- c(State = "state_name", 
                  Municipality = "municipality_name", 
                  Locality = "locality_name",
                  Department = "department_name",
                  Sector = "sect_urb_id",
                  Section = "sect_urb_id",
                  Block = "block_id",
                  Ageb = "ageb_id",
                  District = "district_name",
                  Ward = "ward_name",
                  Region = "reg_name",
                  SubDistrict = "sub.district_name",
                  SubDistrict = "subdistrict_name",
                  City = "townvill_name")




# Define UI for application 
ui <- navbarPage(title = "Socio-economic Data Dashboard", #page_sidebar
                 sidebarPanel(
                   width = 3,
                   # gap = 1,
                   # #title = "Select filters",
                   # select entity level ----
                   selectizeInput(inputId = "country",
                                  label = "Country:",
                                  choices =  c("Mexico",
                                               "Brazil",
                                               "India",
                                               "Colombia") ,
                                  selected = "Mexico",
                                  multiple = FALSE),
                   # mexico -----
                   conditionalPanel(
                     condition = "input.country == 'Mexico'",
                     # select entity level ----
                     selectizeInput(inputId = "entity_level",
                                    label = "Geographical level:",
                                    choices =  c("state","municipality","locality", "ageb", "block") ,
                                    selected = "state",
                                    multiple = FALSE),
                     # select state ----
                     selectizeInput(inputId = "state_name",
                                    label = "State:",
                                    choices = unique(geo_levels_names_mex$state_name),
                                    selected = "All",
                                    multiple = FALSE),
                     # select Municpality ----
                     selectizeInput(inputId = "municipality_name",
                                    label = "Municpality:",
                                    choices =  NULL,
                                    multiple = FALSE),
                     # select Locality ----
                     selectizeInput(inputId = "locality_name",
                                    label = "Locality:",
                                    choices =  NULL,
                                    multiple = FALSE),
                     # select group of variable 
                     selectizeInput(inputId = "variable_group",
                                    label = "Census variable theme:",
                                    choices = census_variables_group_mex,
                                    selected = census_variables_group_mex[1],
                                    multiple = TRUE),
                     # select variable  
                     selectizeInput(inputId = "variable",
                                    label = "Census variable:",
                                    choices = census_variables_definition_mex$variable_name_processed_viz,
                                    selected = census_variables_definition_mex$variable_name_processed_viz[1],
                                    multiple = TRUE),
                     # select year ----
                     selectizeInput(inputId = "year",
                                    label = "Year:",
                                    choices = c("2020", "2010"),
                                    selected = "2020",
                                    multiple = FALSE),
                   ),
                   
                   # brazil -----
                   conditionalPanel(
                     condition = "input.country == 'Brazil'",
                     # select entity level 
                     selectizeInput(inputId = "entity_level_bra",
                                    label = "Geographical level:",
                                    # choices =  c("reg","uf", "mesoreg","microreg","mun","wa","ct") ,
                                    # selected = "reg",
                                    choices =  c("Region","State", "Meso-region","Micro-region","Municipality","Weighting area","Census tract") ,
                                    selected = "Region",
                                    multiple = FALSE),
                     # select region 
                     selectizeInput(inputId = "region_name_bra",
                                    label = "Region:",
                                    choices = unique(geo_levels_names_bra$reg_name),
                                    selected ="All", 
                                    multiple = FALSE),
                     # select state 
                     selectizeInput(inputId = "state_name_bra",
                                    label = "State:",
                                    choices =  NULL,
                                    multiple = FALSE),
                     # select year 
                     selectizeInput(inputId = "year_bra",
                                    label = "Year:",
                                    choices = c("2010"),
                                    selected = "2010",
                                    multiple = FALSE),
                     # select group of variable 
                     selectizeInput(inputId = "variable_group_bra",
                                    label = "Census variable theme:",
                                    choices = census_variables_group_bra,
                                    selected = census_variables_group_bra[1],
                                    multiple = TRUE),
                     # select variable  
                     selectizeInput(inputId = "variable_bra",
                                    label = "Census variable:",
                                    choices = census_variables_definition_bra$variable_name_processed_viz,
                                    selected = census_variables_definition_bra$variable_name_processed_viz[1],
                                    multiple = TRUE)
                   ),
                   # India -----
                   conditionalPanel(
                     condition = "input.country == 'India'",
                     # select entity level 
                     selectizeInput(inputId = "entity_level_ind",
                                    label = "Geographical level:",
                                    choices =  c("state","district", "subdistrict","city","ward") ,
                                    selected = "state",
                                    multiple = FALSE),
                     # select state 
                     selectizeInput(inputId = "state_name_ind",
                                    label = "State:",
                                    choices = unique(geo_levels_names_ind$state_name),
                                    selected ="All", 
                                    multiple = FALSE),
                     # select district 
                     selectizeInput(inputId = "district_name_ind",
                                    label = "District:",
                                    choices =  NULL,
                                    multiple = FALSE),
                     # select year 
                     selectizeInput(inputId = "year_ind",
                                    label = "Year:",
                                    choices = c("2011"),
                                    selected = "2011",
                                    multiple = FALSE),
                     # select group of variable 
                     selectizeInput(inputId = "variable_group_ind",
                                    label = "Census variable theme:",
                                    choices = census_variables_group_ind,
                                    selected = census_variables_group_ind[1],
                                    multiple = TRUE),
                     # select variable  
                     selectizeInput(inputId = "variable_ind",
                                    label = "Census variable:",
                                    choices = census_variables_definition_ind$variable_name_processed_viz,
                                    selected = census_variables_definition_ind$variable_name_processed_viz[1],
                                    multiple = TRUE)
                   ),
                   # Colombia -----
                   conditionalPanel(
                     condition = "input.country == 'Colombia'",
                     # select entity level 
                     selectizeInput(inputId = "entity_level_col",
                                    label = "Geographical level:",
                                    choices =  c("dept","mun", "urban_sect","urban_secc","block") ,
                                    selected = "dept",
                                    multiple = FALSE),
                     # select dept 
                     selectizeInput(inputId = "department_name_col",
                                    label = "dept:",
                                    choices = unique(geo_levels_names_col$dept_name),
                                    selected = "All", #"All Atlántico
                                    multiple = FALSE),
                     # select mun 
                     selectizeInput(inputId = "municipality_name_col",
                                    label = "mun:",
                                    choices =  NULL,
                                    multiple = FALSE),
                     # select year 
                     selectizeInput(inputId = "year_col",
                                    label = "Year:",
                                    choices = c("2018"),
                                    selected = "2018",
                                    multiple = FALSE),
                     # select group of variable 
                     selectizeInput(inputId = "variable_group_col",
                                    label = "Census variable theme:",
                                    choices = census_variables_group_col,
                                    selected = census_variables_group_col[1],
                                    multiple = TRUE),
                     # select variable  
                     selectizeInput(inputId = "variable_col",
                                    label = "Census variable:",
                                    choices = census_variables_definition_col$variable_name_processed_viz,
                                    selected = census_variables_definition_col$variable_name_processed_viz[1],
                                    multiple = TRUE)
                   ),
                 ),
                 mainPanel(
                   
                   tabsetPanel(type = "tabs",
                               id = "tabs",
                               ### Map plot
                               tabPanel("Map",
                                        withSpinner(leafletOutput("census_map", height = 600)),
                                        downloadButton(outputId = "download_geo_data", 
                                                       label = "Download Geospatial data")),
                               ### table plot
                               tabPanel("Table",
                                        withSpinner(DT::dataTableOutput("table")),
                                        downloadButton(outputId = "download_tabular_data", 
                                                       label = "Download tabular data"))
                   )
                 )
)




# Define server -----
server <- function(input, output, session) {
  
  
  # Mexico -----
  
  # Update municipality list based on selected state 
  observeEvent(input$state_name,{
    updateSelectInput(session,
                      'municipality_name',
                      choices=c("All", unique(geo_levels_names_mex[geo_levels_names_mex$state_name==input$state_name, "municipality_name"])),
                      selected = "All",
    )
  })
  
  # Update locality list based on selected state 
  observeEvent(input$state_name,{
    updateSelectInput(session,
                      'locality_name',
                      choices=c("All",
                                unique(geo_levels_names_mex[geo_levels_names_mex$state_name==input$state_name, "locality_name"])),
                      selected = "All",
    )
  })
  
  # Update locality list based on selected municipality
  observeEvent(input$municipality_name,{
    updateSelectInput(session,
                      'locality_name',
                      choices=c("All",
                                unique(geo_levels_names_mex[geo_levels_names_mex$state_name==input$state_name & geo_levels_names_mex$municipality_name==input$municipality_name, "locality_name"])),
                      selected = "All",
    )
  })
  
  # Update variable list based on selected group of variables
  observeEvent(input$variable_group,{
    updateSelectInput(session,
                      'variable',
                      choices= unique(census_variables_definition_mex[census_variables_definition_mex$variable_category %in% input$variable_group, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_mex[census_variables_definition_mex$variable_category %in% input$variable_group, "variable_name_processed_viz"])[1],
    )
  })
  
  
  # Brazil -----
  
  # Update state list based on selected region
  observeEvent(input$region_name_bra,{
    updateSelectInput(session,
                      'state_name_bra',
                      choices=c("All", unique(geo_levels_names_bra[geo_levels_names_bra$reg_name==input$region_name_bra, "uf_name"])),
                      selected = "All"
                      
    )
    
  })
  
  
  # Update variable list based on selected group of variabless 
  observeEvent(input$variable_group_bra,{
    updateSelectInput(session,
                      'variable_bra',
                      choices= unique(census_variables_definition_bra[census_variables_definition_bra$variable_category %in% input$variable_group_bra, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_bra[census_variables_definition_bra$variable_category %in% input$variable_group_bra, "variable_name_processed_viz"])[1],
    )
  })
  
  
  # India -----
  
  # Update district list based on selected state
  observeEvent(input$state_name_ind,{
    updateSelectInput(session,
                      'district_name_ind',
                      choices=c("All", unique(geo_levels_names_ind[geo_levels_names_ind$state_name==input$state_name_ind, "district_name"])),
                      selected = "All"
                      
    )
    
  })
  
  
  # Update variable list based on selected group of variabless 
  observeEvent(input$variable_group_ind,{
    updateSelectInput(session,
                      'variable_ind',
                      choices= unique(census_variables_definition_ind[census_variables_definition_ind$variable_category %in% input$variable_group_ind, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_ind[census_variables_definition_ind$variable_category %in% input$variable_group_ind, "variable_name_processed_viz"])[1],
    )
  })
  
  
  # Colombia ----
  
  # Update municipality list based on selected state ----
  observeEvent(input$department_name_col,{
    updateSelectInput(session,
                      'municipality_name_col',
                      choices=c("All", unique(geo_levels_names_col[geo_levels_names_col$dept_name==input$department_name_col, "mun_name"])),
                      selected = "All",
    )
  })
  
  # Update variable list based on selected group of variables ----
  observeEvent(input$variable_group_col,{
    updateSelectInput(session,
                      'variable_col',
                      choices= unique(census_variables_definition_col[census_variables_definition_col$variable_category %in% input$variable_group_col, "variable_name_processed_viz"]),
                      selected = unique(census_variables_definition_col[census_variables_definition_col$variable_category %in% input$variable_group_col, "variable_name_processed_viz"])[1],
    )
  })
  
  
  
  observe({
    
    
    
    input$active_tab  
    # get selected year ----
    selected_country = input$country
    
    if (selected_country == "Mexico") {
      
      selected_year = input$year
      
      
      # get selected level ----
      selected_level = input$entity_level
      
      # get selected state ----
      selected_state = input$state_name
      print(selected_state)
      
      # get selected state code ----
      state_code = geo_levels_names_mex %>% 
        filter(state_name == selected_state) %>% 
        distinct(state_code) %>% 
        as.character()
      print(state_code)
      
      
      data_path = paste(s3_path,
                        "data/",env,"/",country,"/census_geo/",selected_year,"/",
                        selected_level,
                        "/",
                        state_code,
                        "/census_geo.geojson",
                        sep = "")
      
      census_geo = st_read(data_path)
      
      selected_variable_viz = input$variable
      
      selected_variable = census_variables_definition_mex %>% 
        filter(variable_name_processed_viz %in% selected_variable_viz) %>% 
        pull(variable_name_processed)
      
      if (input$entity_level == "state") {
        
        data_filtered = census_geo %>% 
          select("state_name", selected_variable) 
        
        geo_name = data_filtered$state_name
        
        
      }
      
      if (input$entity_level == "municipality") {
        
        
        if(input$municipality_name == "All"){
          data_filtered = census_geo %>% 
            # filter(state_name == input$state_name) %>% 
            select("state_name","municipality_name", selected_variable)
          geo_name = data_filtered$municipality_name
        } else {
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name) %>% 
            select("state_name","municipality_name", selected_variable)
          geo_name = data_filtered$municipality_name
        }
        
      }
      
      if (input$entity_level == "locality") {
        
        if(input$municipality_name == "All" & input$locality_name == "All"){
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name) %>% 
            select("state_name","municipality_name","locality_name", selected_variable)
          geo_name = data_filtered$locality_name
        } else if (input$municipality_name != "All" & input$locality_name == "All"){
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name) %>% 
            select("state_name","municipality_name","locality_name", selected_variable)
          geo_name = data_filtered$locality_name
        } else if (input$municipality_name != "All" & input$locality_name != "All"){
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name,
                   locality_name == input$locality_name) %>% 
            select("state_name","municipality_name","locality_name", selected_variable)
          geo_name = data_filtered$locality_name
        } 
      }
      
      if (input$entity_level == "ageb") {
        
        if(input$municipality_name == "All" & input$locality_name == "All"){
          
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name) %>% 
            select("state_name","municipality_name","locality_name","ageb_id", selected_variable) 
          
          geo_name = data_filtered$ageb_id
          
        } else if (input$municipality_name != "All" & input$locality_name == "All"){
          
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name) %>% 
            select("state_name","municipality_name","locality_name","ageb_id", selected_variable) 
          
          geo_name = data_filtered$ageb_id
          
        } else if (input$municipality_name != "All" & input$locality_name != "All"){
          
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name,
                   locality_name == input$locality_name) %>% 
            select("state_name","municipality_name","locality_name","ageb_id", selected_variable) 
          
          geo_name = data_filtered$ageb_id
        } 
      }
      
      if (input$entity_level == "block") {
        
        if(input$municipality_name == "All" & input$locality_name == "All"){
          
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name) %>% 
            select("state_name","municipality_name","locality_name", "block_id",selected_variable) 
          
          geo_name = data_filtered$block_id
          
        } else if (input$municipality_name != "All" & input$locality_name == "All"){
          
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name) %>% 
            select("state_name","municipality_name","locality_name","block_id", selected_variable)
          
          geo_name = data_filtered$block_id
          
        } else if (input$municipality_name != "All" & input$locality_name != "All"){
          
          data_filtered = census_geo %>% 
            filter(state_name == input$state_name,
                   municipality_name == input$municipality_name,
                   locality_name == input$locality_name) %>% 
            select("state_name","municipality_name","locality_name","block_id",  selected_variable)
          
          geo_name = data_filtered$block_id
        } 
      }
      
      
      # table -----
      
      data_filtered_table = data_filtered %>% 
        as.data.frame() %>% 
        select(-geometry) %>% 
        rename(any_of(field_rename))
      
      # change variable names
      col_variable_idx = which(names(data_filtered_table) %in% selected_variable)
      colnames(data_filtered_table)[col_variable_idx] = selected_variable_viz
      
      # plot table
      output$table <- DT::renderDataTable(DT::datatable(
        data_filtered_table,
        filter = 'top',
        options = list(paging = TRUE,    
                       pageLength = 10,  
                       scrollX = TRUE,   
                       scrollY = TRUE,   
                       autoWidth = TRUE, 
                       server = FALSE)
      ))
      
      # output data to download ----
      output$download_tabular_data <- downloadHandler(
        filename = function() {
          # paste("data-", Sys.Date(), ".csv", sep="")
          paste("country:Mexico_",
                'year:',selected_year,
                "_level:",selected_level,
                "_state:",selected_state,
                "_fromat:tabular.csv", 
                sep="")
        },
        content = function(file) {
          write.csv(data_filtered_table, file)
        }
      )
      
      
      
      # map ----
      
      
      # base map 
      m = leaflet(data_filtered) %>% 
        addTiles() %>% 
        addProviderTiles(providers$CartoDB.Positron, group = "CartoDB.Positron") %>%
        fitBounds(~as.numeric(st_bbox(census_geo)[1]),
                  ~as.numeric(st_bbox(census_geo)[2]),
                  ~as.numeric(st_bbox(census_geo)[3]),
                  ~as.numeric(st_bbox(census_geo)[4]))
      # addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      # addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") 
      
      
      # plot census map layers
      layer_map = c()
      
      for(i in 1:length(selected_variable_viz)){
        
        selected_variable_map = selected_variable_viz[i]
        print(i) 
        print(selected_variable_map)
        
        selected_variable = census_variables_definition_mex %>% 
          filter(variable_name_processed_viz %in% selected_variable_map) %>% 
          pull(variable_name_processed)
        print(selected_variable)
        
        
        census_variable_values = data_filtered %>%
          as.data.frame() %>%
          pull(selected_variable)
        
        # define pal
        
        
        if(selected_variable_map %in% c("Marginalization level",
                                        "Urban social inclusion group, national level",
                                        "Urban social inclusion group, city level")){
          pal_census <- colorFactor(palette = c("blue","green","yellow","orange","red"), 
                                    levels = c("Very high","High","Medium","Low","Very low"),
                                    na.color = "transparent",
                                    revers = FALSE)
        } else if(selected_variable_map == "Marginalization index"){
          pal_census<- colorNumeric("RdYlBu",
                                    census_variable_values,
                                    na.color = "transparent",
                                    reverse = FALSE)
        } else{
          pal_census<- colorNumeric("RdYlBu",
                                    census_variable_values,
                                    na.color = "transparent",
                                    reverse = TRUE)
        }
        
        
        # define labels information
        labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                "Census variable", selected_variable_map,
                                "Value", census_variable_values,
                                "Name", geo_name) %>%
          lapply(htmltools::HTML)
        
        m = m %>%
          addPolygons(data = data_filtered[,selected_variable],
                      group = selected_variable_map,
                      fillColor = ~pal_census(census_variable_values),
                      weight = 0.1,
                      opacity = 1,
                      color = "grey",
                      fillOpacity = 0.9,
                      label = labels_cesus,
                      highlightOptions = highlightOptions(color = "black", weight = 2,
                                                          bringToFront = FALSE),
                      labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 6px"),
                        textsize = "15px",
                        direction = "auto")) 
        
        
        if(selected_variable_map %in% c("Marginalization level",
                                        "Urban social inclusion group, national level",
                                        "Urban social inclusion group, city level")){
          m = m %>%
            addLegend(colors =  c("blue",
                                  "green",
                                  "yellow",
                                  "orange",
                                  "red"),
                      labels = c("Very High",
                                 "High",
                                 "Medium",
                                 "Low",
                                 "Very Low"),
                      opacity = 0.9,
                      title = selected_variable_map,
                      group = selected_variable_map,
                      position = "bottomright",
                      labFormat = labelFormat(suffix = ""))
        } else{
          m = m %>%
            addLegend(pal = pal_census,
                      values = census_variable_values,
                      opacity = 0.9,
                      title = selected_variable_map,
                      group = selected_variable_map,
                      position = "bottomright",
                      labFormat = labelFormat(suffix = ""))
        }
        
        layer_map = c(layer_map,selected_variable_map)
        
        m = m %>%
          # Layers control ----
        addLayersControl(
          overlayGroups = layer_map,
          baseGroups = c("OSM","Toner Lite", "CartoDB"),
          options = layersControlOptions(collapsed = FALSE)
        ) 
        
      }
      
      # render map
      output$census_map <- renderLeaflet({
        m %>% 
          hideGroup(layer_map[-length(layer_map)]) 
        
      })
      
      # download geospatial data 
      output$download_geo_data <- downloadHandler(
        filename = function() {
          paste("country:MEX_",
                'year:',selected_year,
                "_level:",selected_level,
                "_state:",selected_state,
                "_fromat:geo.geojson",
                sep="")
        },
        content = function(file) {
          st_write(census_geo, file, driver = "GeoJSON") 
        }
      )
      
    }
    
    else if (selected_country == "Brazil") {
      
      selected_year_bra = input$year_bra
      
      
      
      # get selected level ----
      if(input$entity_level_bra == "Region"){
        selected_level_bra = "reg"
      } else if(input$entity_level_bra == "State"){
        selected_level_bra = "uf"
      } else if(input$entity_level_bra == "Meso-region"){
        selected_level_bra = "mesoreg"
      } else if(input$entity_level_bra == "Micro-region"){
        selected_level_bra = "microreg"
      } else if(input$entity_level_bra == "Municipality"){
        selected_level_bra = "mun"
      } else if(input$entity_level_bra == "Weighting area"){
        selected_level_bra = "wa"
      } else if(input$entity_level_bra == "Census tract"){
        selected_level_bra = "ct"
      }
      
      # get selected level ----
      # selected_level_bra = input$entity_level_bra
      
      # get selected state ----
      selected_region_bra = input$region_name_bra
      print(selected_region_bra)
      
      # get selected region  code ----
      region_code_bra = geo_levels_names_bra %>%
        filter(reg_name == selected_region_bra) %>%
        distinct(reg_code) %>%
        as.character()
      print(paste("bra: ", region_code_bra))
      
      
      # read data
      data_path_bra = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/brazil_2/census_geo/",
                            selected_year_bra,
                            "/",
                            selected_level_bra,
                            "/",
                            region_code_bra,
                            "/census_geo.geojson",
                            sep = "")
      
      census_geo_bra = st_read(data_path_bra)
      
      print(data_path_bra)
      
      # select census variable 
      
      selected_variable_viz_bra = input$variable_bra
      
      
      selected_variable_bra = census_variables_definition_bra %>% 
        filter(variable_name_processed_viz %in% selected_variable_viz_bra) %>% 
        pull(variable_name_processed)
      
      print(paste("selected_variable_bra",selected_variable_bra))
      
      
      # filter region level
      if (input$entity_level_bra == "Region") {
        
        data_filtered_bra = census_geo_bra %>%
          select("reg_name", selected_variable_bra)
        
        geo_name_bra = data_filtered_bra$reg_name
        
        print(head(data_filtered_bra))
        
      }
      
      # filter uf level 
      if (input$entity_level_bra == "State") {
        
        
        
        if(input$state_name_bra == "All"){
          data_filtered_bra = census_geo_bra %>% 
            select("reg_name","uf_name", selected_variable_bra)
          geo_name_bra = data_filtered_bra$uf_name
          print(head(data_filtered_bra))
          
        } else {
          data_filtered_bra = census_geo_bra %>% 
            # filter(reg_name == input$region_name_bra,
            #        uf_name == input$state_name_br) %>% 
            filter(uf_name == input$state_name_bra) %>% 
            select("reg_name","uf_name", selected_variable_bra)
          geo_name_bra = data_filtered_bra$uf_name
          print(head(data_filtered_bra))
          
        }
        
      }
      
      
      # mesoreg level 
      if (input$entity_level_bra == "Meso-region") {
        
        
        if(input$state_name_bra == "All"){
          data_filtered_bra = census_geo_bra %>%
            select("reg_name","uf_name", "mesoreg_name",selected_variable_bra)
          geo_name_bra = data_filtered_bra$mesoreg_name
        } else {
          data_filtered_bra = census_geo_bra %>%
            filter(reg_name == input$region_name_bra,
                   uf_name == input$state_name_bra) %>%
            select("reg_name","uf_name",  "mesoreg_name",selected_variable_bra)
          geo_name_bra = data_filtered_bra$mesoreg_name
        }
        
      }
      
      # microreg level 
      if (input$entity_level_bra == "Micro-region") {
        
        
        if(input$state_name_bra == "All"){
          data_filtered_bra = census_geo_bra %>%
            select("reg_name","uf_name", "microreg_name",selected_variable_bra)
          geo_name_bra = data_filtered_bra$microreg_name
        } else {
          data_filtered_bra = census_geo_bra %>%
            filter(reg_name == input$region_name_bra,
                   uf_name == input$state_name_bra) %>%
            select("reg_name","uf_name",  "microreg_name",selected_variable_bra)
          geo_name_bra = data_filtered_bra$microreg_name
        }
        
      }
      
      # municipality level
      if (input$entity_level_bra == "Municipality") {
        
        
        if(input$state_name_bra == "All"){
          data_filtered_bra = census_geo_bra %>% 
            filter(reg_name == input$region_name_bra) %>% 
            select("reg_name","uf_name", "mun_name",selected_variable_bra)
          geo_name_bra = data_filtered_bra$mun_name
        } else {
          data_filtered_bra = census_geo_bra %>% 
            filter(reg_name == input$region_name_bra,
                   uf_name == input$state_name_bra) %>% 
            select("reg_name","uf_name",  "mun_name",selected_variable_bra)
          geo_name_bra = data_filtered_bra$mun_name
        }
        
      }
      
      # weighting_area level
      if (input$entity_level_bra == "Weighting area") {
        
        
        if(input$state_name_bra == "All"){
          data_filtered_bra = census_geo_bra %>% 
            select("reg_name","uf_name","mesoreg_name","microreg_name","mun_name", "wa_id",selected_variable_bra)
          geo_name_bra = data_filtered_bra$wa_id
        } else {
          data_filtered_bra = census_geo_bra %>% 
            filter(reg_name == input$region_name_bra,
                   uf_name == input$state_name_bra) %>% 
            select("reg_name","uf_name","mesoreg_name","microreg_name","mun_name", "wa_id",selected_variable_bra)
          geo_name_bra = data_filtered_bra$wa_id
        }
        
      }
      
      # census tract level
      if (input$entity_level_bra == "Census tract") {
        
        
        if(input$state_name_bra == "All"){
          data_filtered_bra = census_geo_bra %>% 
            select("reg_name","uf_name","mesoreg_name","microreg_name","mun_name", "tract_id",selected_variable_bra)
          geo_name_bra = data_filtered_bra$tract_id
        } else {
          data_filtered_bra = census_geo_bra %>% 
            filter(reg_name == input$region_name_bra,
                   uf_name == input$state_name_bra) %>% 
            select("reg_name","uf_name","mesoreg_name","microreg_name","mun_name", "tract_id",selected_variable_bra)
          geo_name_bra = data_filtered_bra$tract_id
        }
        
      }
      
      # table
      
      data_filtered_table_bra = data_filtered_bra %>% 
        as.data.frame() %>% 
        select(-geometry) %>% 
        rename(any_of(field_rename))
      
      # change variable names
      col_variable_idx_bra = which(names(data_filtered_table_bra) %in% selected_variable_bra)
      colnames(data_filtered_table_bra)[col_variable_idx_bra] = selected_variable_viz_bra
      
      # plot table
      output$table <- DT::renderDataTable(DT::datatable(
        data_filtered_table_bra,
        filter = 'top',
        options = list(paging = TRUE,
                       pageLength = 10,
                       scrollX = TRUE,
                       scrollY = TRUE,
                       autoWidth = TRUE,
                       server = FALSE)
      ))
      
      # output data to download ----
      output$download_tabular_data <- downloadHandler(
        filename = function() {
          paste("country:BRA_",
                'year:',selected_year_bra,
                "_level:",selected_level_bra,
                "_region:",region_code_bra,
                "_fromat:tabular.csv", 
                sep="")
          
        },
        content = function(file) {
          write.csv(data_filtered_table_bra, file)
        }
      )
      
      
      
      # map ----
      
      
      # base map 
      m_bra = leaflet(data_filtered_bra) %>% 
        addTiles() %>% 
        addProviderTiles(providers$CartoDB.Positron, group = "CartoDB.Positron") %>%
        fitBounds(~as.numeric(st_bbox(census_geo_bra)[1]),
                  ~as.numeric(st_bbox(census_geo_bra)[2]),
                  ~as.numeric(st_bbox(census_geo_bra)[3]),
                  ~as.numeric(st_bbox(census_geo_bra)[4]))
      # addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      # addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") 
      
      
      # plot census map layers
      layer_map_bra = c()
      
      print(paste("selected_variable_viz_bra", selected_variable_viz_bra))
      
      for(i in 1:length(selected_variable_viz_bra)){
        
        selected_variable_map_bra = selected_variable_viz_bra[i]
        print(paste("selected_variable_map_bra", i)) 
        print(selected_variable_map_bra)
        
        selected_variable_bra = census_variables_definition_bra %>%
          filter(variable_name_processed_viz %in% selected_variable_map_bra) %>%
          pull(variable_name_processed)
        print(selected_variable_bra)
        
        census_variable_values_bra = data_filtered_bra %>%
          as.data.frame() %>%
          pull(selected_variable_bra)
        
        
        # define pal
        pal_census_bra <- colorNumeric("RdYlBu",
                                       census_variable_values_bra,
                                       na.color = "transparent",
                                       reverse = TRUE)
        
        
        
        # define labels information
        labels_census_bra <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                     "Census variable", selected_variable_map_bra,
                                     "Value", census_variable_values_bra,
                                     "Name", geo_name_bra) %>%
          lapply(htmltools::HTML)
        
        m_bra = m_bra %>%
          addPolygons(data = data_filtered_bra[,selected_variable_bra],
                      group = selected_variable_map_bra,
                      fillColor = ~pal_census_bra(census_variable_values_bra),
                      weight = 0.1,
                      opacity = 1,
                      color = "grey",
                      fillOpacity = 0.9,
                      label = labels_census_bra,
                      highlightOptions = highlightOptions(color = "black", weight = 2,
                                                          bringToFront = FALSE),
                      labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 6px"),
                        textsize = "15px",
                        direction = "auto"))
        
        m_bra = m_bra %>%
          addLegend(pal = pal_census_bra,
                    values = census_variable_values_bra,
                    opacity = 0.9,
                    title = selected_variable_map_bra,
                    group = selected_variable_map_bra,
                    position = "bottomright",
                    labFormat = labelFormat(suffix = ""))
        
        layer_map_bra = c(layer_map_bra,selected_variable_map_bra)
        
        m_bra = m_bra %>%
          # Layers control ----
        addLayersControl(
          overlayGroups = layer_map_bra,
          baseGroups = c("OSM","Toner Lite", "CartoDB"),
          options = layersControlOptions(collapsed = FALSE)
        ) 
        
      }
      
      # render map
      output$census_map <- renderLeaflet({
        m_bra %>% 
          hideGroup(layer_map_bra[-length(layer_map_bra)]) 
        
      })
      
      # download geospatial data ----
      output$download_geo_data <- downloadHandler(
        filename = function() {
          paste("country:BRA_",
                'year:',selected_year_bra,
                "_level:",selected_level_bra,
                "_region:",region_code_bra,
                "_fromat:geo.geojson", 
                sep="")
        },
        content = function(file) {
          st_write(census_geo_bra, file, driver = "GeoJSON")
        }
      )
      
      
    }
    
    else if (selected_country == "India") {
      
      selected_year_ind = input$year_ind
      
      
      # get selected level ----
      selected_level_ind = input$entity_level_ind
      
      # get selected state ----
      selected_state_ind = input$state_name_ind
      
      state_code_ind = geo_levels_names_ind %>%
        filter(state_name == selected_state_ind) %>%
        distinct(state_id) %>%
        as.character()
      print(state_code_ind)
      
      
      # read data
      data_path_ind = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/india_2/census_geo/",
                            selected_year_ind,
                            "/",
                            selected_level_ind,
                            "/",
                            state_code_ind,
                            "/census_geo.geojson",
                            sep = "")
      
      census_geo_ind = st_read(data_path_ind)
      
      
      # select census variable 
      
      selected_variable_viz_ind = input$variable_ind
      
      
      selected_variable_ind = census_variables_definition_ind %>% 
        filter(variable_name_processed_viz %in% selected_variable_viz_ind) %>% 
        pull(variable_name_processed)
      
      print(paste("selected_variable_ind",selected_variable_ind))
      
      
      # state
      if (input$entity_level_ind == "state") {
        
        data_filtered_ind = census_geo_ind %>%
          select("state_name", 
                 selected_variable_ind)
        
        geo_name_ind = data_filtered_ind$state_name
        
        print(head(data_filtered_ind))
        
      }
      
      # district level ----
      
      if (input$entity_level_ind == "district") {
        if(input$district_name_ind == "All"){
          data_filtered_ind = census_geo_ind %>% 
            select("state_name",
                   "district_name", 
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$district_name
        } else {
          data_filtered_ind = census_geo_ind %>% 
            filter(state_name == input$state_name_ind,
                   district_name == input$district_name_ind) %>%
            select("state_name",
                   "district_name",
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$district_name
        }
      }
      
      # sub-district level ----
      
      if (input$entity_level_ind == "subdistrict") {
        if(input$district_name_ind == "All"){
          data_filtered_ind = census_geo_ind %>% 
            select("state_name",
                   "district_name",
                   "subdistrict_name", 
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$subdistrict_name
        } else {
          data_filtered_ind = census_geo_ind %>% 
            filter(state_name == input$state_name_ind,
                   district_name == input$district_name_ind) %>%
            select("state_name",
                   "district_name",
                   "subdistrict_name", 
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$subdistrict_name
        }
      }
      
      # city level ----
      
      if (input$entity_level_ind == "city") {
        if(input$district_name_ind == "All"){
          data_filtered_ind = census_geo_ind %>% 
            select("state_name",
                   "district_name",
                   "subdistrict_name", 
                   "townvill_name",
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$townvill_name
        } else {
          data_filtered_ind = census_geo_ind %>% 
            filter(state_name == input$state_name_ind,
                   district_name == input$district_name_ind) %>%
            select("state_name",
                   "district_name",
                   "subdistrict_name", 
                   "townvill_name",
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$townvill_name
        }
      }
      
      # ward level ----
      
      if (input$entity_level_ind == "ward") {
        if(input$district_name_ind == "All"){
          data_filtered_ind = census_geo_ind %>% 
            select("state_name",
                   "district_name",
                   "subdistrict_name", 
                   # "townvill_name",
                   "ward_id",
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$ward_id
        } else {
          data_filtered_ind = census_geo_ind %>% 
            filter(state_name == input$state_name_ind,
                   district_name == input$district_name_ind) %>%
            select("state_name",
                   "district_name",
                   "subdistrict_name", 
                   # "townvill_name",
                   "ward_id",
                   selected_variable_ind)
          geo_name_ind = data_filtered_ind$ward_id
        }
        
        data_filtered_ind_no_geom = data_filtered_ind %>% 
          st_set_geometry(NULL)
      }
      
      # table
      
      data_filtered_table_ind = data_filtered_ind %>%
        drop_na(selected_variable_ind) %>% 
        as.data.frame() %>% 
        select(-geometry) %>% 
        rename(any_of(field_rename))
      
      # change variable names
      col_variable_idx_ind = which(names(data_filtered_table_ind) %in% selected_variable_ind)
      colnames(data_filtered_table_ind)[col_variable_idx_ind] = selected_variable_viz_ind
      
      # plot table
      output$table <- DT::renderDataTable(DT::datatable(
        data_filtered_table_ind,
        filter = 'top',
        options = list(paging = TRUE,
                       pageLength = 10,
                       scrollX = TRUE,
                       scrollY = TRUE,
                       autoWidth = TRUE,
                       server = FALSE)
      ))
      
      # output data to download ----
      output$download_tabular_data <- downloadHandler(
        filename = function() {
          paste("country:IND_",
                'year:',selected_year_ind,
                "_level:",selected_level_ind,
                "_region:",region_code_ind,
                "_fromat:tabular.csv", 
                sep="")
          
        },
        content = function(file) {
          write.csv(data_filtered_table_ind, file)
        }
      )
      
      
      
      # map ----
      
      
      # base map 
      m_ind = leaflet(data_filtered_ind) %>% 
        addTiles() %>% 
        addProviderTiles(providers$CartoDB.Positron, group = "CartoDB.Positron") %>%
        fitBounds(~as.numeric(st_bbox(census_geo_ind)[1]),
                  ~as.numeric(st_bbox(census_geo_ind)[2]),
                  ~as.numeric(st_bbox(census_geo_ind)[3]),
                  ~as.numeric(st_bbox(census_geo_ind)[4]))
      # addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      # addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") 
      
      
      # plot census map layers
      layer_map_ind = c()
      
      for(i in 1:length(selected_variable_viz_ind)){
        
        selected_variable_map_ind = selected_variable_viz_ind[i]
        print(paste("selected_variable_map_ind", i)) 
        print(selected_variable_map_ind)
        
        selected_variable_ind = census_variables_definition_ind %>%
          filter(variable_name_processed_viz %in% selected_variable_map_ind) %>%
          pull(variable_name_processed)
        print(selected_variable_ind)
        
        census_variable_values_ind = data_filtered_ind %>%
          as.data.frame() %>%
          pull(selected_variable_ind)
        
        
        # define pal
        pal_census_ind <- colorNumeric("RdYlBu",
                                       census_variable_values_ind,
                                       na.color = "transparent",
                                       reverse = TRUE)
        
        
        
        # define labels information
        labels_census_ind <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                     "Census variable", selected_variable_map_ind,
                                     "Value", census_variable_values_ind,
                                     "Name", geo_name_ind) %>%
          lapply(htmltools::HTML)
        
        m_ind = m_ind %>%
          addPolygons(data = data_filtered_ind[,selected_variable_ind],
                      group = selected_variable_map_ind,
                      fillColor = ~pal_census_ind(census_variable_values_ind),
                      weight = 0.1,
                      opacity = 1,
                      color = "grey",
                      fillOpacity = 0.9,
                      label = labels_census_ind,
                      highlightOptions = highlightOptions(color = "black", weight = 2,
                                                          bringToFront = FALSE),
                      labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 6px"),
                        textsize = "15px",
                        direction = "auto"))
        
        m_ind = m_ind %>%
          addLegend(pal = pal_census_ind,
                    values = census_variable_values_ind,
                    opacity = 0.9,
                    title = selected_variable_map_ind,
                    group = selected_variable_map_ind,
                    position = "bottomright",
                    labFormat = labelFormat(suffix = ""))
        
        layer_map_ind = c(layer_map_ind,selected_variable_map_ind)
        
        m_ind = m_ind %>%
          # Layers control ----
        addLayersControl(
          overlayGroups = layer_map_ind,
          baseGroups = c("OSM","Toner Lite", "CartoDB"),
          options = layersControlOptions(collapsed = FALSE)
        ) 
        
      }
      
      # render map
      output$census_map <- renderLeaflet({
        m_ind %>% 
          hideGroup(layer_map_ind[-length(layer_map_ind)]) 
        
      })
      
      # download geospatial data ----
      output$download_geo_data <- downloadHandler(
        filename = function() {
          paste("country:BRA_",
                'year:',selected_year_ind,
                "_level:",selected_level_ind,
                "_region:",region_code_ind,
                "_fromat:geo.geojson", 
                sep="")
        },
        content = function(file) {
          st_write(census_geo_ind, file, driver = "GeoJSON")
        }
      )
      
      
    }
    
    else if (selected_country == "Colombia") {
      
      # get selected year ----
      selected_year_col = input$year_col
      
      
      # get selected level ----
      selected_level_col = input$entity_level_col
      
      # get selected department ----
      selected_department_col = input$department_name_col
      print(selected_department_col)
      
      # get selected department code ----
      department_code = geo_levels_names_col %>%
        filter(dept_name == selected_department_col) %>%
        distinct(dept_code) %>%
        as.character()
      print(department_code)
      
      
      # read data
      
      # data_path_col = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_2/census_geo/",
      #                       selected_year_col,
      #                       "/",
      #                       selected_level_col,
      #                       "/",
      #                       department_code,
      #                       "/census_geo.geojson",
      #                       sep = "")
      data_path_col = paste("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_3/census_geo/",
                            # selected_year_col,
                            # "/",
                            selected_level_col,
                            "/",
                            department_code,
                            "/census_geo.geojson",
                            sep = "")
      
      census_geo_col = st_read(data_path_col)
      print(head(census_geo_col))
      
      
      # select census variable 
      
      selected_variable_viz_col = input$variable_col
      
      selected_variable_col = census_variables_definition_col %>%
        filter(variable_name_processed_viz %in% selected_variable_viz_col) %>%
        pull(variable_name_processed)
      
      
      # department level
      if (input$entity_level_col == "dept") {
        
        data_filtered_col = census_geo_col %>%
          select("dept_name", selected_variable_col)
        
        geo_name_col = data_filtered_col$dept_name
        
        
        
      }
      
      
      # municipality level
      if (input$entity_level_col == "mun") {
        
        
        if(input$municipality_name_col == "All"){
          
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col) %>% 
            select("dept_name","mun_name", selected_variable_col)
          geo_name_col = data_filtered_col$mun_name
        } else {
          
          
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col,
                   mun_name == input$municipality_name_col) %>% 
            select("dept_name","mun_name", selected_variable_col)
          geo_name_col = data_filtered_col$mun_name
        }
        
      }
      
      
      
      
      # urban sector level
      if (input$entity_level_col == "urban_sect") {
        
        
        if(input$municipality_name_col == "All"){
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col) %>% 
            select("dept_name","mun_name", "sect_urb_id",selected_variable_col)
          geo_name_col = data_filtered_col$sect_urb_id
        } else {
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col,
                   mun_name == input$municipality_name_col) %>% 
            select("dept_name","mun_name", "sect_urb_id",selected_variable_col)
          geo_name_col = data_filtered_col$sect_urb_id
        }
        
      }
      
      # urban section level
      if (input$entity_level_col == "urban_secc") {
        
        
        if(input$municipality_name_col == "All"){
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col) %>% 
            select("dept_name","mun_name", "sect_urb_id","secc_urb_id",selected_variable_col)
          geo_name_col = data_filtered_col$secc_urb_id
        } else {
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col,
                   mun_name == input$municipality_name_col) %>% 
            select("dept_name","mun_name", "sect_urb_id","secc_urb_id",selected_variable_col)
          geo_name_col = data_filtered_col$secc_urb_id
        }
        
      }
      
      # Block level
      if (input$entity_level_col == "block") {
        
        
        if(input$municipality_name_col == "All"){
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col) %>% 
            select("dept_name","mun_name", "sect_urb_id","secc_urb_id","block_id",selected_variable_col)
          geo_name_col = data_filtered_col$block_id
        } else {
          data_filtered_col = census_geo_col %>% 
            filter(dept_name == input$department_name_col,
                   mun_name == input$municipality_name_col) %>% 
            select("dept_name","mun_name", "sect_urb_id","secc_urb_id","block_id",selected_variable_col)
          geo_name_col = data_filtered_col$block_id
        }
        
      }
      
      # table
      
      data_filtered_table_col = data_filtered_col %>%
        as.data.frame() %>%
        select(-geometry) %>% 
        rename(any_of(field_rename))
      
      # change variable names
      col_variable_idx_col = which(names(data_filtered_table_col) %in% selected_variable_col)
      colnames(data_filtered_table_col)[col_variable_idx_col] = selected_variable_viz_col
      
      
      print(data_filtered_table_col)
      
      # plot table
      output$table <- DT::renderDataTable(DT::datatable(
        data_filtered_table_col,
        filter = 'top',
        options = list(paging = TRUE,
                       pageLength = 10,
                       scrollX = TRUE,
                       scrollY = TRUE,
                       autoWidth = TRUE,
                       server = FALSE)
      ))
      
      # output data to download ----
      output$download_tabular_data <- downloadHandler(
        filename = function() {
          paste("country:COL_",
                'year:',selected_year_col,
                "_level:",selected_level_col,
                "_department:",department_code,
                "_fromat:tabular.csv", 
                sep="")
        },
        content = function(file) {
          write.csv(data_filtered_table_col, file)
        }
      )
      
      
      
      # map ----
      
      
      # base map 
      m_col = leaflet(data_filtered_col) %>% 
        addTiles() %>% 
        addProviderTiles(providers$CartoDB.Positron, group = "CartoDB.Positron") %>%
        fitBounds(~as.numeric(st_bbox(census_geo_col)[1]),
                  ~as.numeric(st_bbox(census_geo_col)[2]),
                  ~as.numeric(st_bbox(census_geo_col)[3]),
                  ~as.numeric(st_bbox(census_geo_col)[4]))
      # addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
      # addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
      # addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") 
      
      
      # plot census map layers
      layer_map_col = c()
      
      for(i in 1:length(selected_variable_viz_col)){
        
        selected_variable_map_col = selected_variable_viz_col[i]
        
        selected_variable_col = census_variables_definition_col %>% 
          filter(variable_name_processed_viz %in% selected_variable_map_col) %>% 
          pull(variable_name_processed)
        
        print(paste("selected_variable_col: ", selected_variable_col))
        
        
        census_variable_values_col = data_filtered_col %>%
          as.data.frame() %>%
          pull(selected_variable_col)
        
        # define pal
        pal_census_col<- colorNumeric("RdYlBu",
                                      census_variable_values_col,
                                      na.color = "transparent",
                                      reverse = TRUE)
        
        
        # define labels information
        labels_census_col <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s",
                                     "Census variable", selected_variable_map_col,
                                     "Value", census_variable_values_col,
                                     "Name", geo_name_col) %>%
          lapply(htmltools::HTML)
        
        m_col = m_col %>%
          addPolygons(data = data_filtered_col[,selected_variable_col],
                      group = selected_variable_map_col,
                      fillColor = ~pal_census_col(census_variable_values_col),
                      weight = 0.1,
                      opacity = 1,
                      color = "grey",
                      fillOpacity = 0.9,
                      #label = labels_census_col,
                      highlightOptions = highlightOptions(color = "black", weight = 2,
                                                          bringToFront = FALSE),
                      labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 6px"),
                        textsize = "15px",
                        direction = "auto"))
        
        m_col = m_col %>%
          addLegend(pal = pal_census_col,
                    values = census_variable_values_col,
                    opacity = 0.9,
                    title = selected_variable_map_col,
                    group = selected_variable_map_col,
                    position = "bottomright",
                    labFormat = labelFormat(suffix = ""))
        
        
        layer_map_col = c(layer_map_col,selected_variable_map_col)
        
        m_col = m_col %>%
          # Layers control ----
        addLayersControl(
          overlayGroups = layer_map_col,
          baseGroups = c("OSM","Toner Lite", "CartoDB"),
          options = layersControlOptions(collapsed = FALSE)
        )
        
      }
      
      # render map
      output$census_map <- renderLeaflet({
        m_col %>% 
          hideGroup(layer_map_col[-length(layer_map_col)]) 
        
      })
      
      # download geospatial data ----
      output$download_geo_data <- downloadHandler(
        filename = function() {
          paste("country:COL_",
                'year:',selected_year_col,
                "_level:",selected_level_col,
                "_dept:",department_code,
                "_fromat:geo.geojson", 
                sep="")
        },
        content = function(file) {
          st_write(data_filtered_col, file, driver = "GeoJSON")
        }
      )
      
      
    }
    
    
    
  })
  
}





# Run the application 
shinyApp(ui = ui, 
         server = server)