# data downloading and converted to csv taken from:@rafpereirabr, Brazilian_Census [https://github.com/rafapereirabr/Brazilian_Census]

# dwg ---------------------------------------------------------------------
## set up ------------------------------------------------------------------
rm(list=ls())
library(data.table)
library(dplyr)
library(tidyverse)
library(tidyr)
library(sf)
# aws keys
Sys.setenv(
  "AWS_ACCESS_KEY_ID" = "KEY_ID",
  "AWS_SECRET_ACCESS_KEY" = "SECRET_ACCESS_KEY",
  "AWS_DEFAULT_REGION" = "REGION")

## data ---------------------------------------------------------------------
dwg = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/brazil/original/dwg_full.csv")
dwg = filter(dwg, dwg$V4001==1) # Keep just permanent occupied dwellings 
dwg = dwg %>% drop_na(V6203)
## recoding ------------------------------------------------------------
# ownership
dwg$d_owned <- ifelse(dwg$V0201 %in% c(1, 2), 1, 0)

dwg$d_rented <- ifelse(dwg$V0201 == 3, 1, 0)

dwg$d_loaned <- ifelse(dwg$V0201 %in% c(4, 5), 1, 0)

dwg$d_other <- ifelse(dwg$V0201 == 6, 1, 0)

# walls material
dwg$d_nwalls <- ifelse(dwg$V0202 == 9, 1, 0)
dwg$d_walls_masonry <- ifelse(dwg$V0202 %in% c(1, 2), 1, 
                              ifelse(dwg$V0202 == 9, NA, 0))
dwg$d_walls_wood <- ifelse(dwg$V0202 %in% c(3, 6), 1, 
                           ifelse(dwg$V0202 == 9, NA, 0))
dwg$d_walls_rearth <- ifelse(dwg$V0202 %in% c(4, 5), 1, 
                             ifelse(dwg$V0202 == 9, NA, 0))
dwg$d_walls_straw <- ifelse(dwg$V0202 == 7, 1, 
                            ifelse(dwg$V0202 == 9, NA, 0))
dwg$d_walls_other <- ifelse(dwg$V0202 == 8, 1, 
                            ifelse(dwg$V0202 == 9, NA, 0))

# room
dwg$d_1rm <- ifelse(dwg$V0203 == 1, 1, 0)
dwg$d_2rms <- ifelse(dwg$V0203 == 2, 1, 0)
dwg$d_3mrms <- ifelse(dwg$V0203 >= 3, 1, 0)

# bedroom
dwg$d_1bedrm <- ifelse(dwg$V0204 == 1, 1, 0)
dwg$d_2mbedrms <- ifelse(dwg$V0204 >= 2, 1, 0)

# basic services
dwg$d_ntoil <- ifelse(dwg$V0205 == 0, 1, 0)

## sewage
dwg$d_ss_sewage <- ifelse(is.na(dwg$V0207), NA, 0)
dwg$d_ss_sewage <- ifelse(dwg$V0207 == 1, 1, dwg$d_ss_sewage)
dwg$d_ss_pit <- ifelse(is.na(dwg$V0207), NA, ifelse(dwg$V0207 %in% c(2,3), 1, 0))
dwg$d_ss_ditch <- ifelse(is.na(dwg$V0207), NA, ifelse(dwg$V0207 == 4, 1, 0))
dwg$d_ss_river <- ifelse(is.na(dwg$V0207), NA, ifelse(dwg$V0207 == 5, 1, 0))
dwg$d_ss_other <- ifelse(is.na(dwg$V0207), NA, ifelse(dwg$V0207 == 6, 1, 0))

## water
dwg$d_water_network <- ifelse(dwg$V0208==1, 1, 0)
dwg$d_water_well_in <- ifelse(dwg$V0208==2, 1, 0)
dwg$d_water_well_out <- ifelse(dwg$V0208==3, 1, 0)
dwg$d_water_wtruck <- ifelse(dwg$V0208==4, 1, 0)
dwg$d_water_rain <- ifelse(dwg$V0208 %in% c(5,6), 1, 0)
dwg$d_water_river <- ifelse(dwg$V0208==7, 1,0)
dwg$d_water_other <- ifelse(dwg$V0208>7, 1,0)
dwg$d_npwater <- ifelse(dwg$V0209==3, 1,0)

## garbage
dwg$d_garbage_clngsvcs <- ifelse(dwg$V0210 %in% c(1,2), 1, 0)
dwg$d_garbage_burnt <- ifelse(dwg$V0210==3, 1, 0)
dwg$d_garbage_buried <- ifelse(dwg$V0210==4, 1, 0)
dwg$d_garbage_throwed <- ifelse(dwg$V0210 %in% c(5,6), 1, 0)
dwg$d_garbage_other <- ifelse(dwg$V0210==7, 1, 0)

## electricity
dwg$d_nelect = 0
dwg$d_nelect[is.na(dwg$V0211)] <- NA
dwg$d_nelect[dwg$V0211==3] <- 1

## goods
dwg$d_ntv <- ifelse(dwg$V0214==2, 1, 0)
dwg$d_nwm <- ifelse(dwg$V0215 == 2, 1, 0)
dwg$d_nrefri <- ifelse(dwg$V0216 == 2, 1, 0)
dwg$d_ncp <- ifelse(dwg$V0217 == 2, 1, 0)
dwg$d_ncmp <- ifelse(dwg$V0219 == 2, 1, 0)
dwg$d_ninet <- ifelse(is.na(dwg$V0220), NA, ifelse(dwg$V0220 == 2, 1, 0))
dwg$d_nmtrcl <- ifelse(dwg$V0221 == 2, 1, 0)
dwg$d_ncar <- ifelse(dwg$V0222 == 2, 1, 0)


# Subset
dwg = dwg %>% dplyr::select(V0001, V0002, V0011, V0300, V0010, V1001, V1002, V1003, V1004, V1006,V1005,
                           d_owned, d_rented, d_loaned, d_other,
                           V2011, d_nwalls, d_walls_masonry, d_walls_wood, d_walls_rearth, d_walls_straw, d_walls_other,
                           d_1rm, d_2rms, d_3mrms, V6203, d_1bedrm, d_2mbedrms, V6204, 
                           d_ntoil, 
                           d_ss_sewage, d_ss_pit, d_ss_ditch, d_ss_river, d_ss_other,
                           d_water_network, d_water_well_in, d_water_well_out, d_water_wtruck, d_water_rain,d_water_river,
                           d_water_other, d_npwater, 
                           d_garbage_clngsvcs, d_garbage_burnt, d_garbage_buried,d_garbage_throwed,d_garbage_other,
                           d_nelect,
                           d_ntv, d_nwm, d_nrefri, d_ncp, d_ncmp, d_ninet, d_nmtrcl, d_ncar,
                           V6529, V6531)

fwrite(dwg, "aws/data/raw/brazil/dwg_full_r.csv", row.names = FALSE)

put_object(file = "aws/data/raw/brazil/dwg_full_r.csv",
           object = "data/raw/brazil/dwg_full_r.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

# pop ---------------------------------------------------------------------
## set up ------------------------------------------------------------------
rm(list=ls())
library(data.table)
library(dplyr)
library(tidyverse)
library(tidyr)
library(sf)
# aws keys
Sys.setenv(
  "AWS_ACCESS_KEY_ID" = "AKIA4GK7IHHCZFNTZ6VQ",
  "AWS_SECRET_ACCESS_KEY" = "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",
  "AWS_DEFAULT_REGION" = "eu-west-3")

## data --------------------------------------------------------------------
dwg = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/brazil/original/pop_full.csv")

pop = pop %>% dplyr::select(V0001, V0002, V0011, V1001, V1002, V1003, V1004, V1005, V1006, V0010, 
                            V0601, V6036,  V0606, V0614, V0615, V0616, V0617, V6900,V0628, V0627, V6910)

## Recoding ----------------------------------------------------------------
# basics
pop$p_tot_m <- ifelse(pop$V0601 == 1, 1, 0)
pop$p_tot_f <- ifelse(pop$V0601 == 2, 1, 0)
# age
pop$p_0to2 <- ifelse(pop$V6036 >= 0 & pop$V6036 <= 2, 1, 0)
pop$p_0to2_f <- ifelse(pop$V6036 >= 0 & pop$V6036 <= 2 & pop$V0601 == 2, 1, 0)
pop$p_0to2_m <- ifelse(pop$V6036 >= 0 & pop$V6036 <= 2 & pop$V0601 == 1, 1, 0)

pop$p_3to5 <- ifelse(pop$V6036 >= 3 & pop$V6036 <= 5, 1, 0)
pop$p_3to5_f <- ifelse(pop$V6036 >= 3 & pop$V6036 <= 5 & pop$V0601 == 2, 1, 0)
pop$p_3to5_m <- ifelse(pop$V6036 >= 3 & pop$V6036 <= 5 & pop$V0601 == 1, 1, 0)

pop$p_6to11 <- ifelse(pop$V6036 >= 6 & pop$V6036 <= 11, 1, 0)
pop$p_6to11_f <- ifelse(pop$V6036 >= 6 & pop$V6036 <= 11 & pop$V0601 == 2, 1, 0)
pop$p_6to11_m <- ifelse(pop$V6036 >= 6 & pop$V6036 <= 11 & pop$V0601 == 1, 1, 0)

pop$p_12to14 <- ifelse(pop$V6036 >= 12 & pop$V6036 <= 14, 1, 0)
pop$p_12to14_f <- ifelse(pop$V6036 >= 12 & pop$V6036 <= 14 & pop$V0601 == 2, 1, 0)
pop$p_12to14_m <- ifelse(pop$V6036 >= 12 & pop$V6036 <= 14 & pop$V0601 == 1, 1, 0)

pop$p_15to17 <- ifelse(pop$V6036 >= 15 & pop$V6036 <= 17, 1, 0)
pop$p_15to17_f <- ifelse(pop$V6036 >= 15 & pop$V6036 <= 17 & pop$V0601 == 2, 1, 0)
pop$p_15to17_m <- ifelse(pop$V6036 >= 15 & pop$V6036 <= 17 & pop$V0601 == 1, 1, 0)

pop$p_18to24 = ifelse(pop$V6036 >= 18 & pop$V6036 <= 24, 1, 0)
pop$p_18to24_f = ifelse(pop$V6036 >= 18 & pop$V6036 <= 24 & pop$V0601 == 2, 1, 0)
pop$p_18to24_m = ifelse(pop$V6036 >= 18 & pop$V6036 <= 24 & pop$V0601 == 1, 1, 0)

pop$p_25to64 = ifelse(pop$V6036 >= 25 & pop$V6036 <= 64, 1, 0)
pop$p_25to64_f = ifelse(pop$V6036 >= 25 & pop$V6036 <= 64 & pop$V0601 == 2, 1, 0)
pop$p_25to64_m = ifelse(pop$V6036 >= 25 & pop$V6036 <= 64 & pop$V0601 == 1, 1, 0)

pop$p_65m = ifelse(pop$V6036 >= 65, 1, 0)
pop$p_65m_f = ifelse(pop$V6036 >= 65 & pop$V0601 == 2, 1, 0)
pop$p_65m_m = ifelse(pop$V6036 >= 65 & pop$V0601 == 1, 1, 0)

## dependency rate
### total
pop$p_tdr = ifelse(pop$V6036>=15 & pop$V6036<=64, 0, 1)
### children
pop$p_chddr = ifelse(pop$V6036>=15 & pop$V6036<=64, 0, 
                     ifelse(pop$V6036>=65, NA, 1))
### old age
pop$p_olddr = ifelse(pop$V6036>=15 & pop$V6036<=64, 0, 
                     ifelse(pop$V6036>=65, 1, NA))
# skin
pop$p_wht = ifelse(pop$V0606 == 1, 1, 0)
pop$p_black = ifelse(pop$V0606 == 2, 1, 0)
pop$p_yellow = ifelse(pop$V0606 == 3, 1, 0)
pop$p_brown = ifelse(pop$V0606 == 4, 1, 0)
pop$p_indig = ifelse(pop$V0606 == 5, 1, 0)

# disabilities
pop$p_disab = ifelse(pop$V0614==4 | pop$V0615==4 | pop$V0616==4 | pop$V0617==2, 0,
              ifelse(pop$V0614==9 | pop$V0615==9 | pop$V0616==9 | pop$V0617==9, NA, 1))
pop$p_disab_mtr = ifelse(pop$V0616 == 4, 0, ifelse(pop$V0616 == 9, NA, 1))
pop$p_disab_vis = ifelse(pop$V0614 == 4, 0, ifelse(pop$V0614 == 9, NA, 1))

# literacy
pop$p_ilit = ifelse(pop$V0627 == 1, 0, 1)
pop$p_ilit_m = ifelse(pop$V0601 == 2, NA, pop$p_ilit)
pop$p_ilit_f = ifelse(pop$V0601 == 1, NA, pop$p_ilit)

# school assistance
age_ranges <- list(
  list(pop_var = "p_6to11", v0628_cutoff = 2),
  list(pop_var = "p_12to14", v0628_cutoff = 2),
  list(pop_var = "p_15to17", v0628_cutoff = 2),
  list(pop_var = "p_18to24", v0628_cutoff = 2)
)

for (age_range in age_ranges) {
  pop_var <- age_range$pop_var
  v0628_cutoff <- age_range$v0628_cutoff
  
  pop[[paste0(pop_var, "nas")]] <- NA
  pop[[paste0(pop_var, "nas")]][pop[[pop_var]] == 1 & pop$V0628 <= v0628_cutoff] <- 0
  pop[[paste0(pop_var, "nas")]][pop[[pop_var]] == 1 & pop$V0628 > v0628_cutoff] <- 1
  
  pop[[paste0(pop_var, "nas_m")]] <- pop[[paste0(pop_var, "nas")]]
  pop[[paste0(pop_var, "nas_m")]][pop$V0601 == 2] <- NA
  
  pop[[paste0(pop_var, "nas_f")]] <- pop[[paste0(pop_var, "nas")]]
  pop[[paste0(pop_var, "nas_f")]][pop$V0601 == 1] <- NA
}

# employment
pop$p_emp = ifelse(pop$V6910 == 2, 0, pop$V6910)
pop$p_emp_f = ifelse(pop$V0601 == 1, NA, pop$p_emp)
pop$p_emp_m = ifelse(pop$V0601 == 2, NA, pop$p_emp)
pop$p_unem = ifelse(pop$V6910 == 1, 0, ifelse(pop$V6910 == 2, 1, pop$V6910))
pop$p_unem_f = ifelse(pop$V0601 == 1, NA, pop$p_unem)
pop$p_unem_m = ifelse(pop$V0601 == 2, NA, pop$p_unem)
pop$p_econia = ifelse(pop$V6900 == 1, 0, ifelse(pop$V6900 == 2, 1, NA))
pop$p_econia_f = ifelse(pop$V0601 == 1, NA, pop$p_econia)
pop$p_econia_m = ifelse(pop$V0601 == 2, NA, pop$p_econia)
pop$p_econa = ifelse(pop$V6900 == 2, 0, pop$V6900)
pop$p_econa_f = ifelse(pop$V0601 == 1, 0, pop$p_econa)
pop$p_econa_m = ifelse(pop$V0601 == 2, 0, pop$p_econa)

pop = pop %>% dplyr::select(V0001, V0002, V0011, V0010, V1001, V1002, V1003, V1004, V1006,V1005, V6910, V0601, V6900,
                            p_tot_m, p_tot_f, 
                            p_0to2, p_0to2_f,p_0to2_m,
                            p_3to5, p_3to5_f,  p_3to5_m, 
                            p_6to11,p_6to11_f, p_6to11_m, 
                            p_12to14, p_12to14_f, p_12to14_m, 
                            p_15to17, p_15to17_f, p_15to17_m,
                            p_18to24, p_18to24_f, p_18to24_m, 
                            p_25to64, p_25to64_f, p_25to64_m, 
                            p_65m, p_65m_f, p_65m_m,
                            p_tdr, p_chddr, p_olddr, 
                            p_wht, p_black, p_yellow, p_brown, 
                            p_indig, 
                            p_disab, p_disab_mtr, p_disab_vis, 
                            p_ilit, p_ilit_f, p_ilit_m, 
                            p_6to11nas, p_6to11nas_f, p_6to11nas_m, 
                            p_12to14nas, p_12to14nas_f, p_12to14nas_m,
                            p_15to17nas, p_15to17nas_f, p_15to17nas_m,
                            p_18to24nas, p_18to24nas_f, p_18to24nas_m,
                            p_emp,p_emp_f, p_emp_m, 
                            p_unem, p_unem_f, p_unem_m, 
                            p_econia, p_econia_m, p_econia_f, 
                            p_econa, p_econa_f, p_econa_m
)

fwrite(dwg, "aws/data/raw/brazil/pop_full_r.csv", row.names = FALSE)

put_object(file = "aws/data/raw/brazil/pop_full_r.csv",
           object = "data/raw/brazil/pop_full_r.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
