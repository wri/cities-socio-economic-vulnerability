################################################################################################
# This script generates a csv file containing the different combination of states/municipalities/localities
# This file is used for populating the state/municipality/ocality names in the dashboard  based on user' selection
# input: 
#     - boundaries data stored as geojson files in aws s3 bucket
# output: 
#     - geo_levels_names data stored as csv files in aws s3 bucket
################################################################################################

library(aws.s3)
library(sf)
library(tidyverse)

#vinamra
###################################
# Mexico 2010
###################################

# define year, environment, country, s3 path

env = "dev"
year = "2010"
country = "mexico"

s3_path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/"


# boundaries: state ----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/boundaries/",year,
                  "/01_state_2010.geojson",
                  sep = "")

boundaries_state = st_read(data_path)

boundaries_state_df = boundaries_state %>% 
  as.data.frame() %>% 
  select(-geometry)

# boundaries: municipality -----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/boundaries/",year,
                  "/02_mun_2010.geojson",
                  sep = "")

boundaries_municipality = st_read(data_path)

boundaries_municipality_df = boundaries_municipality %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  unite(municipality_id,
        c(CVE_ENT,CVE_MUN), 
        sep = "")


# boundaries: locality ----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/boundaries/",year,
                  "/03_loc_2010.geojson",
                  sep = "")

boundaries_locality = st_read(data_path)

boundaries_locality_df = boundaries_locality %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  unite(municipality_id,
        c(CVE_ENT,CVE_MUN), 
        sep = "",
        remove = FALSE) %>% 
  unite(locality_id,
        c(CVE_ENT,CVE_MUN,CVE_LOC), 
        sep = "",
        remove = FALSE)

# join and create geo_levels_names ----


geo_levels_names = boundaries_locality_df %>% 
  left_join(boundaries_municipality_df[,c("municipality_id","NOM_MUN")], by = "municipality_id") %>% 
  left_join(boundaries_state_df[,c("CVE_ENT","NOM_ENT")], by = "CVE_ENT") %>% 
  select(state_name = NOM_ENT,
         state_code = CVE_ENT,
         municipality_name = NOM_MUN,
         municipality_id,
         locality_name = NOM_LOC,
         locality_id)

# add rows for selecting all entities

geo_levels_names = geo_levels_names %>% 
  add_row(state_name = "Aguascalientes",
          state_code = "01",
          municipality_name ="All",
          locality_name = "All") %>% 
  add_row(state_name = "All",
          state_code = "All",
          municipality_name ="All",
          locality_name = "All")

# store output local ----

write.csv(geo_levels_names,
          paste("./data/",country,"/boundaries/",year,"/geo_levels_names.csv", sep =""))


# upload to s3 ----

dir_path = getwd()

file_path = paste(dir_path,
                    "/data/mexico/boundaries/2010/geo_levels_names.csv",
                    sep = "")

object_path = paste("data/",env,"/",country,"/boundaries/",year,"/geo_levels_names.csv",sep = "")

put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


###################################
# Mexico 2020
###################################

# define year, environment, country, s3 path

env = "dev"
year = "2020"
country = "mexico"

s3_path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/"


# boundaries: state ----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/boundaries/",year,
                  "/boundary_01_state.geojson",
                  sep = "")

boundaries_state = st_read(data_path)

boundaries_state_df = boundaries_state %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  select(state_id =CVE_ENT,
         state_name = NOMGEO)

# boundaries: municipality -----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/boundaries/",year,
                  "/boundary_02_municipality_simplified.geojson",
                  sep = "")

boundaries_municipality = st_read(data_path)

boundaries_municipality_df = boundaries_municipality %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  unite(municipality_id,
        c(CVE_ENT,CVE_MUN), 
        sep = "") %>% 
  select(municipality_id,
         municipality_name = NOMGEO)


# boundaries: locality ----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/boundaries/",year,
                  "/boundary_03_locality_simplified.geojson",
                  sep = "")

boundaries_locality = st_read(data_path)

boundaries_locality_df = boundaries_locality %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  unite(municipality_id,
        c(CVE_ENT,CVE_MUN), 
        sep = "",
        remove = FALSE) %>% 
  unite(locality_id,
        c(CVE_ENT,CVE_MUN,CVE_LOC), 
        sep = "",
        remove = FALSE) %>% 
  select(locality_id,
         locality_name = NOMGEO,
         municipality_id,
         state_id = CVE_ENT)

# join and create geo_levels_names ----


geo_levels_names = boundaries_locality_df %>% 
  left_join(boundaries_municipality_df, by = "municipality_id") %>% 
  left_join(boundaries_state_df, by = "state_id") 


# add rows for selecting all entities

geo_levels_names = geo_levels_names %>% 
  add_row(state_name = "Aguascalientes",
          state_code = "01",
          municipality_name ="All",
          locality_name = "All") %>% 
  add_row(state_name = "All",
          state_code = "All",
          municipality_name ="All",
          locality_name = "All")

# store output local ----

write.csv(geo_levels_names,
          paste("./data/",env,"/",country,"/boundaries/",year,"/geo_levels_names.csv", sep =""))


# upload to s3 ----

dir_path = getwd()

file_path = paste(dir_path,
                  paste("/data/",env,"/",country,"/boundaries/",year,"/geo_levels_names.csv", sep =""),
                  sep = "")

object_path = paste("data/","raw","/",country,"/boundaries/",year,"/geo_levels_names.csv",sep = "")

put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

