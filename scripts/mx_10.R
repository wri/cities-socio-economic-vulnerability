# Set up ------------------------------------------------------------------
# Libraries
rm(list=ls())
library(tidyverse)
library(dplyr)
library(data.table)
library(purrr)
library(aws.s3)
library(sf)

# aws keys
Sys.setenv("AWS_ACCESS_KEY_ID" = "",
           "AWS_SECRET_ACCESS_KEY" = "",
           "AWS_DEFAULT_REGION" = "")

bucket_name <- "cities-socio-economic-vulnerability"

# 1. raw data  --------------------------------------------------------------------
df <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/census/2010/mx_10_raw.csv",
                        encoding = "UTF-8", header = TRUE) %>% rename_all(tolower)

# Generate geo_ids
df <- df %>% 
  mutate(state_code = str_pad(entidad, 2, pad = '0'),
         municipality_code = str_pad(mun, 3, pad = '0'),
         locality_code = str_pad(loc, 4, pad = '0'),
         ageb_code = str_pad(ageb, 4, pad = '0'),
         block_code = str_pad(mza, 3, pad = '0'))

# Keep just variables that are going to be needed
df <- df %>% 
  select(# Geoids and names
         state_code, nom_ent, municipality_code, nom_mun, locality_code, nom_loc, ageb_code, block_code, 
         # Dwellings
         vivtot, vivpar_hab, vph_1cuart, vph_2cuart, vph_3ymasc, pro_ocup_c, vph_1dor, 
         vph_2ymasd, vph_pisoti, vph_excsa, vph_drenaj, vph_aguadv, vph_c_elec, 
         vph_inter, vph_pc, vph_cel, vph_tv, vph_autom, vph_refri, vph_lavad, vph_snbien, 
         # Population
         pobtot, pobmas, pobfem, p_0a2,
         p_0a2_f, p_0a2_m, p_3a5, p_3a5_m, p_3a5_f, p_6a11, p_6a11_f, p_6a11_m,
         p_12a14, p_12a14_f, p_12a14_m, p_15a17, p_15a17_f, p_15a17_m,
         p_15ymas_f, p_15ymas_m, p_15ymas_f, p_18a24, p_18a24_f, p_18a24_m,
         p_60ymas, p_60ymas_f, p_60ymas_m, pob0_14, pob65_mas, pob15_64,
         prom_hnv, p_12ymas_f, pder_ss, p15ym_an, p15ym_an_f, p15ym_an_m,
         p6a11_noa, p6a11_noaf, p6a11_noam, p12a14noa, p12a14noaf, p12a14noam,
         p15a17a, p15a17a_f, p15a17a_m, p18a24a, p18a24a_f, p18a24a_m,
         graproes, p_15ymas, graproes_f, p_15ymas_f, graproes_m, p_15ymas_m,
         pocupada, pocupada_f, pocupada_m, pdesocup, pdesocup_f, pdesocup_m,
         pe_inac, pe_inac_f, pe_inac_m, tothog, hogjef_f, hogjef_m, 
         p3ym_hli, p3ym_hli_f, p3ym_hli_m,
         pcon_lim, pclim_mot, pclim_vis)

# Convert to numeric
df <- df %>% 
  dplyr::mutate(across(c(9:98),as.numeric))
# 2. processing  -------------------------------------------------------------------------
## National  ------------------------------------------
census_mexico_national_2010 <- filter(df,municipality_code =="000") # state totals

census_mexico_national_2010 <- census_mexico_national_2010 %>%  dplyr::summarize(
  # Params
  year = "2010",
  entity_level = "national",
  state_code = NA,
  state_name = NA,
  municipality_code = NA, 
  municipality_name = NA,
  municipality_id = NA,
  locality_code = NA, 
  locality_name = NA,
  locality_id = NA,
  ageb_code = NA,
  ageb_id = NA,
  block_code = NA, 
  block_id = NA,
  # Dwellings
  d_tot = sum(vivpar_hab), 
  d_1rm = sum(vph_1cuart),
  ## Size
  d_prop_1rm = sum(vph_1cuart) / sum(vivpar_hab) * 100,
  d_2rms = sum(vph_2cuart),
  d_prop_2rms = sum(vph_2cuart) / sum(vivpar_hab) * 100,
  d_3mrms = sum(vph_3ymasc),
  d_prop_3mrms = sum(vph_3ymasc) / sum(vivpar_hab) * 100,
  d_mean_occup_r = weighted.mean(pro_ocup_c, vivtot),
  d_1bedrm = sum(vph_1dor),
  d_prop_1bedrm = sum(vph_1dor) / sum(vivpar_hab) * 100,
  d_2mbedrms = sum(vph_2ymasd),
  d_prop_2mbedrms  = sum(vph_2ymasd) / sum(vivpar_hab) * 100,
  ## Quality
  d_dirtfloor = sum(vph_pisoti),
  d_prop_dirtfloor = sum(vph_pisoti) / sum(vivpar_hab) * 100,
  d_ntoil = sum(vivpar_hab) - sum(vph_excsa),
  d_prop_ntoil = (1 - (sum(vph_excsa) / sum(vivpar_hab))) * 100, 
  ## Basic services
  d_ndrng = sum(vivpar_hab) - sum(vph_drenaj),
  d_prop_ndrng = (1-(sum(vph_drenaj) / sum(vivpar_hab))) * 100,
  d_npwater = sum(vivpar_hab) - sum(vph_aguadv),
  d_prop_npwater = (1-(sum(vph_aguadv) / sum(vivpar_hab))) * 100,
  d_nelect = sum(vivpar_hab) - sum(vph_c_elec),
  d_prop_nelect = (1-(sum(vph_c_elec) / sum(vivpar_hab))) * 100,
  d_ninet = sum(vivpar_hab) - sum(vph_inter),
  d_prop_ninet = (1 - (sum(vph_inter) / sum(vivpar_hab))) * 100, 
  ## Appliances and other goods
  d_ncmp = sum(vivpar_hab) - sum(vph_pc),
  d_prop_ncmp =  (1 - (sum(vph_pc) / sum(vivpar_hab))) * 100, 
  d_ncp = sum(vivpar_hab) - sum(vph_cel),
  d_prop_ncp =  (1 - (sum(vph_cel)/sum(vivpar_hab))) * 100,
  d_ntv = sum(vivpar_hab) - sum(vph_tv),
  d_prop_ntv = (1 - (sum(vph_tv)/sum(vivpar_hab))) * 100,
  d_ncar = sum(vivpar_hab) -  sum(vph_autom),
  d_prop_ncar = (1 - (sum(vph_autom)/sum(vivpar_hab))) * 100,
  d_nrefri = sum(vivpar_hab) -  sum(vph_refri),
  d_prop_nrefri = (1 - (sum(vph_refri)/sum(vivpar_hab))) * 100,
  d_nwm = sum(vivpar_hab) - sum(vph_lavad),
  d_prop_nwm  = (1 - (sum(vph_lavad)/sum(vivpar_hab))) * 100,
  d_ngoods = sum(vph_snbien), 
  d_prop_ngoods = sum(vph_snbien) / sum(vivpar_hab) * 100, 
  # Households
  hh_tot = sum(tothog),
  hh_f = sum(hogjef_f),
  hh_prop_f = sum(hogjef_f) / sum(tothog) * 100,
  hh_m = sum(hogjef_m),
  hh_prop_m = sum(hogjef_m) / sum(tothog) * 100,
  # Population
  p_tot = sum(pobtot),
  p_tot_m = sum(pobmas),
  p_tot_f = sum(pobfem),
  prop_m_f = sum(pobmas) / sum(pobfem) * 100,  
  ## Age
  p_0to2 = sum(p_0a2),
  p_0to2_f = sum(p_0a2_f),
  p_0to2_m = sum(p_0a2_m),
  p_3to5 = sum(p_3a5),
  p_3to5_f = sum(p_3a5_f),
  p_3to5_m = sum(p_3a5_m),
  p_6to11 = sum(p_6a11),
  p_6to11_f = sum(p_6a11_f),
  p_6to11_m = sum(p_6a11_m),
  p_12to14 = sum(p_12a14),
  p_12to14_f = sum(p_12a14_f),
  p_12to14_m = sum(p_12a14_m),
  p_15to17 = sum(p_15a17),
  p_15to17_f = sum(p_15a17_f),
  p_15to17_m = sum(p_15a17_m),
  p_18to24 = sum(p_18a24),
  p_18to24_f = sum(p_18a24_f),
  p_18to24_m = sum(p_18a24_m),
  p_25to59 = sum(p_tot) - sum(p_0a2) - sum(p_3a5) - sum(p_6a11) - sum(p_12a14) - sum(p_15a17) - sum(p_18a24) - sum(p_60ymas),
  p_25to59_f = sum(p_tot_f) - sum(p_0a2_f) - sum(p_3a5_f) - sum(p_6a11_f) - sum(p_12a14_f) - sum(p_15a17_f) - sum(p_18a24_f) - sum(p_60ymas_f),
  p_25to59_m = sum(p_tot_m) - sum(p_0a2_m) - sum(p_3a5_m) - sum(p_6a11_m) - sum(p_12a14_m) - sum(p_15a17_m) - sum(p_18a24_m) - sum(p_60ymas_m), 
  p_60m = sum(p_60ymas),
  p_60m_f = sum(p_60ymas_f),
  p_60m_m = sum(p_60ymas_m),
  p_prop_tdr = (sum(pob0_14) + sum(pob65_mas)) / sum(pob15_64) * 100,
  p_prop_chddr = sum(pob0_14) / sum(pob15_64) * 100,
  p_prop_olddr = sum(pob65_mas) / sum(pob15_64) * 100,
  p_mean_chdba = weighted.mean(prom_hnv, p_12ymas_f),
  ## Health 
  p_nhealth = sum(pobtot) - sum(pder_ss),
  p_prop_nhealth = (1- (sum(pobtot) /sum(pder_ss))) * 100,
  ## Education
  p_ilit = sum(p15ym_an),
  p_prop_ilit = sum(p15ym_an) / sum(p_15ymas) * 100,
  p_ilit_f = sum(p15ym_an_f),
  p_prop_ilit_f = sum(p15ym_an_f) / sum(p_15ymas_f)* 100,
  p_ilit_m = sum(p15ym_an_m),
  p_prop_ilit_m = sum(p15ym_an_m) / sum(p_15ymas_m)* 100,
  p_6to11nas = sum(p6a11_noa),
  p_prop_6to11nas = sum(p6a11_noa) / sum(p_6a11) * 100,
  p_6to11nas_f = sum(p6a11_noaf),
  p_prop_6to11nas_f = sum(p6a11_noaf) / sum(p_6a11_f) * 100,
  p_6to11nas_m = sum(p6a11_noam),
  p_prop_6to11nas_m = sum(p6a11_noam) / sum(p_6a11_m) * 100,
  p_12to14nas = sum(p12a14noa),
  p_prop_12to14nas = sum(p12a14noa) / sum(p_12a14) * 100,
  p_12to14nas_f = sum(p12a14noaf),
  p_prop_12to14nas_f = sum(p12a14noaf) / sum(p_12a14_f) * 100,
  p_12to14nas_m = sum(p12a14noam),
  p_prop_12to14nas_m = sum(p12a14noam) / sum(p_12a14_m) * 100,
  p_15to17nas = sum(p_15a17) - sum(p15a17a),
  p_prop_15to17nas = (1 - (sum(p15a17a) / sum(p_15a17))) * 100,
  p_15to17nas_f = sum(p_15a17_f) - sum(p15a17a_f),
  p_prop_15to17nas_f = (1 - (sum(p15a17a_f) / sum(p_15a17_f))) * 100,
  p_15to17nas_m = sum(p_15a17_m) - sum(p15a17a_m),
  p_prop_15to17nas_m = (1 - (sum(p15a17a_m) / sum(p_15a17_m))) * 100,
  p_18to24nas = sum(p_18a24) - sum(p18a24a), 
  p_prop_18to24nas = (1 - (sum(p18a24a) / sum(p_18a24))) * 100,
  p_18to24nas_f = sum(p_18a24_f) - sum(p18a24a_f), 
  p_prop_18to24nas_f = (1 - (sum(p18a24a_f) / sum(p_18a24_f))) * 100,
  p_18to24nas_m = sum(p_18a24_m) - sum(p18a24a_m), 
  p_prop_18to24nas_m = (1 - (sum(p18a24a_m) / sum(p_18a24_m))) * 100,
  p_mean_yredu = weighted.mean(graproes, p_15ymas),
  p_mean_yredu_f = weighted.mean(graproes_f, p_15ymas_f),
  p_mean_yredu_m = weighted.mean(graproes_m, p_15ymas_m),
  ## Employment
  p_emp = sum(pocupada),
  p_emp_f = sum(pocupada_f),
  p_emp_m = sum(pocupada_m),
  p_unem = sum(pdesocup),
  p_unem_f = sum(pdesocup_f),
  p_unem_m = sum(pdesocup_m), 
  p_prop_emp = sum(pocupada) / (sum(pocupada) + sum(pdesocup)) * 100,
  p_prop_emp_f = sum(pocupada_f) / (sum(pocupada_f) + sum(pdesocup_f)) * 100,
  p_prop_emp_m= sum(pocupada_m) / (sum(pocupada_m) + sum(pdesocup_m)) * 100,
  p_econia = sum(pe_inac), 
  p_econia_f = sum(pe_inac_f),
  p_econia_m = sum(pe_inac_m),
  ## Indigenous language
  p_langindig = sum(p3ym_hli),
  p_langindig_f = sum(p3ym_hli_f),
  p_langindig_m = sum(p3ym_hli_m),
  ## Disabities
  p_disab = sum(pcon_lim), 
  p_disab_mtr = sum(pclim_mot),
  p_disab_vis = sum(pclim_vis) 
)

## Other levels ------------------------------------------------------------
df$nom_loc2 = df$nom_loc
df$cve_loc = paste(df$state_code, df$municipality_code, df$locality_code, sep="") %>% as.character()

df = df %>%
  naniar::replace_with_na(replace = list(nom_loc2 = c("Total de la localidad urbana", "Total AGEB urbana")))

df$nom_loc2 <- ave(df$nom_loc2, df$cve_loc, FUN=function(x)unique(x[!is.na(x)]))

df <- df %>% dplyr::mutate(state_name = nom_ent,
                           municipality_name = nom_mun,
                           locality_name = nom_loc2)%>% 
  add_column(year = "2010",
             entity_level = NA,
             municipality_id = NA,
             locality_id = NA,
             ageb_id = NA,
             block_id = NA
  )

# Variable_name_processed
df <- df %>% dplyr::mutate(
  d_tot = vivpar_hab, 
  
  d_1rm = vph_1cuart,
  d_prop_1rm = vph_1cuart / vivpar_hab * 100,
  
  d_2rms = vph_2cuart,
  d_prop_2rms = vph_2cuart / vivpar_hab * 100,
  
  d_3mrms = vph_3ymasc,
  d_prop_3mrms = vph_3ymasc / vivpar_hab * 100,
  
  d_mean_occup_r = pro_ocup_c,
  
  d_1bedrm = vph_1dor,
  d_prop_1bedrm = vph_1dor / vivpar_hab * 100,
  
  d_2mbedrms = vph_2ymasd,
  d_prop_2mbedrms = vph_2ymasd / vivpar_hab * 100,
  
  d_dirtfloor = vph_pisoti,
  d_prop_dirtfloor = vph_pisoti / vivpar_hab * 100,
  
  d_ntoil =  vivpar_hab - vph_excsa,
  d_prop_ntoil = (1 - (vph_excsa / vivpar_hab)) * 100,   
  
  d_ndrng = vivpar_hab - vph_drenaj,
  d_prop_ndrng = (1 - (vivpar_hab / vivpar_hab)) * 100,
  
  d_npwater = vivpar_hab - vph_aguadv,
  d_prop_npwater = (1 - (vph_aguadv / vivpar_hab)) * 100,
  
  d_nelect = vivpar_hab - vph_c_elec,
  d_prop_nelect = (1-(vph_c_elec / vivpar_hab)) * 100,
  
  d_ninet = vivpar_hab - vph_inter,
  d_prop_ninet = (1 - (vph_inter/vivpar_hab)) * 100,
  
  d_ncmp = vivpar_hab - vph_pc, 
  d_prop_ncmp =  (1 - (vph_pc/vivpar_hab)) * 100,
  
  d_ncp = vivpar_hab - vph_cel, 
  d_prop_ncp =  (1 - (vph_cel/vivpar_hab)) * 100,
  
  d_ntv = vivpar_hab - vph_tv, 
  d_prop_ntv = (1 - (vph_tv/vivpar_hab)) * 100,
  
  d_ncar = vivpar_hab - vph_autom, 
  d_prop_ncar = (1 - (vph_autom/vivpar_hab)) * 100,
  
  d_nrefri = vivpar_hab - vph_refri, 
  d_prop_nrefri = (1 - (vph_refri/vivpar_hab)) * 100,
  
  d_nwm = vivpar_hab - vph_lavad,
  d_prop_nwm = (1 - (vph_lavad/vivpar_hab)) * 100,
  
  d_ngoods = vph_snbien, 
  d_prop_ngoods = vph_snbien / vivpar_hab * 100, 
  
  hh_tot = tothog,
  hh_f = hogjef_f,
  hh_prop_f = hogjef_f / tothog * 100,
  hh_m = hogjef_m,
  hh_prop_m = hogjef_m / tothog * 100,
  
  p_tot = pobtot, 
  p_tot_m = pobmas, 
  p_tot_f = pobfem, 
  prop_m_f = pobmas/pobfem * 100, 
  p_0to2 = p_0a2, 
  p_0to2_f = p_0a2_f, 
  p_0to2_m = p_0a2_m, 
  p_3to5 = p_3a5 , 
  p_3to5_f = p_3a5_f, 
  p_3to5_m = p_3a5_m, 
  p_6to11 = p_6a11, 
  p_6to11_f = p_6a11_f, 
  p_6to11_m = p_6a11_m, 
  p_12to14 = p_12a14, 
  p_12to14_f = p_12a14_f, 
  p_12to14_m = p_12a14_m, 
  p_15to17 = p_15a17, 
  p_15to17_f = p_15a17_f, 
  p_15to17_m = p_15a17_m, 
  p_18to24 = p_18a24, 
  p_18to24_f = p_18a24_f, 
  p_18to24_m = p_18a24_m, 
  p_25to59 = p_tot - p_0a2 - p_3a5 - p_6a11 - p_12a14 - p_15a17 - p_18a24 - p_60ymas,
  p_25to59_f = p_tot_f - p_0a2_f - p_3a5_f - p_6a11_f - p_12a14_f - p_15a17_f - p_18a24_f - p_60ymas_f,
  p_25to59_m = p_tot_m - p_0a2_m - p_3a5_m - p_6a11_m - p_12a14_m - p_15a17_m - p_18a24_m - p_60ymas_m,     
  p_60m = p_60ymas, 
  p_60m_f = p_60ymas_f, 
  p_60m_m = p_60ymas_m, 
  p_prop_tdr = (pob0_14 + pob65_mas) / pob15_64 * 100,
  p_prop_chddr = pob0_14 / pob15_64 * 100,
  p_prop_olddr = pob65_mas / pob15_64 * 100,
  p_mean_chdba = prom_hnv,
  
  p_nhealth = pobtot - pder_ss,
  p_prop_nhealth = (1 - (pder_ss / pobtot)) * 100,
  
  p_ilit = p15ym_an,
  p_prop_ilit = p15ym_an / p_15ymas * 100,
  p_ilit_f = p15ym_an_f,
  p_prop_ilit_f = p15ym_an_f / p_15ymas_f * 100,
  p_ilit_m = p15ym_an_m,
  p_prop_ilit_m = p15ym_an_m / p_15ymas_m * 100,
  
  p_6to11nas = p6a11_noa,
  p_prop_6to11nas = p6a11_noa / p_6a11 * 100,
  p_6to11nas_f = p6a11_noaf,
  p_prop_6to11nas_f =  p6a11_noaf / p_6a11_f * 100,
  p_6to11nas_m = p6a11_noam,
  p_prop_6to11nas_m =  p6a11_noam / p_6a11_m * 100,      
  
  p_12to14nas = p12a14noa,
  p_prop_12to14nas = p12a14noa / p_12a14 * 100,
  p_12to14nas_f = p12a14noaf,
  p_prop_12to14nas_f = p12a14noaf / p_12a14_f * 100, 
  p_12to14nas_m = p12a14noam,
  p_prop_12to14nas_m = p12a14noam / p_12a14_m * 100,
  
  p_15to17nas = p_15a17 - p15a17a, 
  p_prop_15to17nas = (1 - (p15a17a / p_15a17)) * 100,
  p_15to17nas_f = p_15a17_f - p15a17a_f,
  p_prop_15to17nas_f = (1 - (p15a17a_f / p_15a17_f)) * 100,
  p_15to17nas_m = p_15a17_m - p15a17a_m,
  p_prop_15to17nas_m = (1 - (p15a17a_m / p_15a17_m)) * 100,
  p_18to24nas = p_18a24 - p18a24a, 
  p_prop_18to24nas = (1 - (p18a24a / p_18a24)) * 100,
  p_18to24nas_f = p_18a24_f - p18a24a_f,
  p_prop_18to24nas_f = (1 - (p18a24a_f / p_18a24_f)) * 100,
  p_18to24nas_m = p_18a24_m - p18a24a_m,
  p_prop_18to24nas_m = (1 - (p18a24a_m / p_18a24_m)) * 100,
  
  p_mean_yredu =  graproes,
  p_mean_yredu_f = graproes_f,
  p_mean_yredu_m = graproes_m,
  
  p_emp = pocupada,
  p_emp_f = pocupada_f,
  p_emp_m = pocupada_m,
  
  p_unem = pdesocup,
  p_unem_f = pdesocup_f,
  p_unem_m = pdesocup_m, 
  p_prop_emp = pocupada / (pocupada + pdesocup) * 100,
  p_prop_emp_f = pocupada_f / (pocupada_f + pdesocup_f) * 100,
  p_prop_emp_m = pocupada_m / (pocupada_m + pdesocup_m) * 100,
  p_econia = pe_inac, 
  p_econia_f = pe_inac_f,
  p_econia_m = pe_inac_m,
  
  p_langindig = p3ym_hli,
  p_langindig_f = p3ym_hli_f,
  p_langindig_m = p3ym_hli_m,
  p_disab = pcon_lim, 
  p_disab_mtr = pclim_mot,
  p_disab_vis = pclim_vis) 
# Keep just processed vars
df <- df %>% 
  select(year, entity_level, 
         state_code, state_name, municipality_code, municipality_name, locality_code, locality_name, ageb_code, block_code,
         d_tot,              d_1rm,             
         d_prop_1rm,         d_2rms,             d_prop_2rms,        d_3mrms,           
         d_prop_3mrms,       d_mean_occup_r,     d_1bedrm,           d_prop_1bedrm,     
         d_2mbedrms,         d_prop_2mbedrms,    d_dirtfloor,        d_prop_dirtfloor,  
         d_ntoil,            d_prop_ntoil,       d_ndrng,            d_prop_ndrng,      
         d_npwater,          d_prop_npwater,     d_nelect,           d_prop_nelect,     
         d_ninet,            d_prop_ninet,       d_ncmp,             d_prop_ncmp,       
         d_ncp,              d_prop_ncp,         d_ntv,              d_prop_ntv,        
         d_ncar,             d_prop_ncar,        d_nrefri,           d_prop_nrefri,     
         d_nwm,              d_prop_nwm,         d_ngoods,           d_prop_ngoods,     
         hh_tot,             hh_f,               hh_prop_f,          hh_m,              
         hh_prop_m,          p_tot,              p_tot_m,            p_tot_f,           
         prop_m_f,           p_0to2,             p_0to2_f,           p_0to2_m,          
         p_3to5,             p_3to5_f,           p_3to5_m,           p_6to11,           
         p_6to11_f,          p_6to11_m,          p_12to14,           p_12to14_f,        
         p_12to14_m,         p_15to17,           p_15to17_f,         p_15to17_m,        
         p_18to24,           p_18to24_f,         p_18to24_m,         p_25to59,          
         p_25to59_f,         p_25to59_m,         p_60m,              p_60m_f,           
         p_60m_m,            p_prop_tdr,         p_prop_chddr,       p_prop_olddr,      
         p_mean_chdba,       p_nhealth,          p_prop_nhealth,     p_ilit,            
         p_prop_ilit,        p_ilit_f,           p_prop_ilit_f,      p_ilit_m,          
         p_prop_ilit_m,      p_6to11nas,         p_prop_6to11nas,    p_6to11nas_f,      
         p_prop_6to11nas_f,  p_6to11nas_m,       p_prop_6to11nas_m,  p_12to14nas,       
         p_prop_12to14nas,   p_12to14nas_f,      p_prop_12to14nas_f, p_12to14nas_m,     
         p_prop_12to14nas_m, p_15to17nas,        p_prop_15to17nas,   p_15to17nas_f,     
         p_prop_15to17nas_f, p_15to17nas_m,      p_prop_15to17nas_m, p_18to24nas,       
         p_prop_18to24nas,   p_18to24nas_f,      p_prop_18to24nas_f, p_18to24nas_m,     
         p_prop_18to24nas_m, p_mean_yredu,       p_mean_yredu_f,     p_mean_yredu_m,    
         p_emp,              p_emp_f,            p_emp_m,            p_unem,            
         p_unem_f,           p_unem_m,           p_prop_emp,         p_prop_emp_f,      
         p_prop_emp_m,       p_econia,           p_econia_f,         p_econia_m,        
         p_langindig,        p_langindig_f,      p_langindig_m,      p_disab,           
         p_disab_mtr,        p_disab_vis
         
  )

# 3. save -----------------------------------------------------------------
## national -----------------------------------------------------------------
### census
fwrite(census_mexico_national_2010, 
       "aws/data/dev/mexico/census/2010/census_mexico_national_2010.csv",
       row.names = FALSE
)

put_object(file = "aws/data/dev/mexico/census/2010/census_mexico_national_2010.csv",
           object = "data/dev/mexico_2/census/2010/census_mexico_national_2010.csv", 
           bucket = bucket_name,
           acl = "public-read")

### census_geo
b_national <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico/boundaries/2010/00_mexico_2010.geojson")
b_national <- select(b_national, geometry)
b_national$state_code <- NA
census_geo <- full_join(census_mexico_national_2010, b_national)

st_write(census_geo,
         "aws/data/dev/mexico/census_geo/2010/national/census_geo.geojson",
         update = TRUE)

put_object(file = "aws/data/dev/mexico/census_geo/2010/national/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/2010/national/census_geo.geojson", 
           bucket = bucket_name,
           acl = "public-read",
           multipart = TRUE)

## state -----------------------------------------------------------------
census_mexico_state_2010 <- filter(df, municipality_code == "000")

census_mexico_state_2010 = census_mexico_state_2010 %>%
  mutate(
    entity_level = "state",
    municipality_code = NA, 
    municipality_name = NA,
    municipality_id = NA,
    locality_code = NA, 
    locality_name = NA,
    locality_id = NA,
    ageb_code = NA, 
    ageb_id = NA,
    block_code = NA,
    block_id = NA
  )

mi_state = data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2010/im/im_10_state.csv")

mi_state$state_code <- str_pad(mi_state$state_code, 2, pad = '0')

# keep index and vars which are not publicly available
mi_state = select(mi_state,
                  state_code, mi_nat_s, mi_nat_group
)

census_mexico_state_2010 <- merge(census_mexico_state_2010, mi_state, by = "state_code")
fwrite(census_mexico_state_2010, "aws/data/dev/mexico/census/2010/census_mexico_state_2010.csv",
       row.names = FALSE
)

put_object(file = "aws/data/dev/mexico/census/2010/census_mexico_state_2010.csv",
           object = "data/dev/mexico_2/census/2010/census_mexico_state_2010.csv", 
           bucket = bucket_name,
           acl = "public-read")

### census_geo
geo_state <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2010/01_state_2010.geojson")
geo_state <- select(geo_state,
                    CVE_ENT, geometry
)
names(geo_state) <- c("state_code", "geometry")

census_state_geo <-  full_join(census_mexico_state_2010, geo_state, by = "state_code")

state_list = unique(census_mexico_state_2010$state_name)
state_codes = unique(census_mexico_state_2010$state_code)

# create geojson files for each state
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  # filter state
  census_state_geo_state = census_state_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./aws/data/dev/mexico/census_geo/2010/state/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_state_geo_2010.geojson",
                    sep = "/")
  st_write(census_state_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2010/state/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = bucket_name,
             acl = "public-read",
             multipart = TRUE)
  
}
st_write(census_state_geo,
         "aws/data/dev/mexico/census_geo/2010/state/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "aws/data/dev/mexico/census_geo/2010/state/All/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/state/All/census_geo.geojson", 
           bucket = bucket_name,
           acl = "public-read")

## municipality ----------------------------------------------------------
census_mexico_municipality_2010 <- filter(df, municipality_code != "000" & locality_code == "0000")

census_mexico_municipality_2010 = census_mexico_municipality_2010 %>%
  mutate(
    entity_level = "Municipality",
    locality_code = NA, 
    locality_name = NA,
    locality_id = NA,
    ageb_code = NA, 
    ageb_id = NA,
    block_code = NA,
    block_id = NA)

census_mexico_municipality_2010$municipality_id= paste0(
  formatC(census_mexico_municipality_2010$state_code,width=2, flag="0"), 
  formatC(census_mexico_municipality_2010$municipality_code,width=3, flag="0"))

mi_municipality <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2010/im/im_10_municipality.csv")

mi_municipality$municipality_id= paste0(
  formatC(mi_municipality$state_code,width=2, flag="0"), 
  formatC(mi_municipality$municipality_code,width=3, flag="0"))

mi_municipality <- select(mi_municipality,
                          municipality_id,
                          mi_nat_s, mi_nat_group)

census_mexico_municipality_2010 <- merge(census_mexico_municipality_2010, mi_municipality, by="municipality_id")
fwrite(census_mexico_municipality_2010, "aws/data/dev/mexico/census/2010/census_mexico_municipality_2010.csv",
       row.names = FALSE
)

put_object(file = "aws/data/dev/mexico/census/2010/census_mexico_municipality_2010.csv",
           object = "data/dev/mexico_2/census/census_mexico_municipality_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

### census_geo
geo_municipality <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2010/02_mun_2010.geojson")

geo_municipality$municipality_code <- paste0(formatC(geo_municipality$CVE_ENT, width=2, flag="0"), 
                                             formatC(geo_municipality$CVE_MUN, width=3, flag="0"))
  
geo_municipality <- select(geo_municipality,
                           municipality_code,geometry)

census_municipality_geo <-  full_join(census_mexico_municipality_2010, geo_municipality, by = "municipality_code")


dir.create("aws/data/dev/mexico/census_geo/2010/municipality/All", recursive = TRUE)

st_write(census_municipality_geo,
         "aws/data/dev/mexico/census_geo/2010/municipality/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "aws/data/dev/mexico/census_geo/2010/municipality/All/census_geo.geojson",
           object = "data/dev/mexico/census_geo/2010/municipality/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

#### create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_municipality_geo_state = census_municipality_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./aws/data/dev/mexico/census_geo/2010/municipality/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_geo.geojson",
                    sep = "/")
  st_write(census_municipality_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2010/municipality/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)}

## locality ----------------------------------------------------------
census_mexico_locality_2010 <- filter(df, locality_code != "0000"  & ageb_code == "0000")

census_mexico_locality_2010 = census_mexico_locality_2010 %>%
  mutate(
    entity_level = "locality",
    ageb_code = NA, 
    ageb_id = NA,
    block_code = NA,
    block_id = NA)

census_mexico_locality_2010$locality_id= paste0(
  formatC(census_mexico_locality_2010$state_code,width=2, flag="0"), 
  formatC(census_mexico_locality_2010$municipality_code,width=3, flag="0"),
  formatC(census_mexico_locality_2010$locality_code,width=4, flag="0")
)

mi_locality <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2010/im/im_10_locality.csv")

mi_locality$locality_id= paste0(
  formatC(mi_locality$state_code,width=2, flag="0"), 
  formatC(mi_locality$municipality_code,width=3, flag="0"),
  formatC(mi_locality$locality_code,width=4, flag="0")
)

mi_locality <- select(mi_locality,
                      locality_id,
                      mi_nat_s, mi_nat_group)

census_mexico_locality_2010 <- merge(census_mexico_locality_2010, mi_locality, by="locality_id")

fwrite(census_mexico_locality_2010, "aws/data/dev/mexico/census/2010/census_mexico_locality_2010.csv",
       row.names = FALSE
)

put_object(file = "aws/data/dev/mexico/census/2010/census_mexico_locality_2010.csv",
           object = "data/dev/mexico_2/census/census_mexico_locality_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

### census_geo
geo_locality <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2010/03_loc_2010.geojson")

geo_locality <- select(geo_locality,
                       cveloc,geometry
)
names(geo_locality) <- c("locality_id","geometry")


census_locality_geo <-  full_join(census_mexico_locality_2010, geo_locality, by = "locality_id")

dir.create("aws/data/dev/mexico/census_geo/2010/locality/All", recursive = TRUE)


st_write(census_locality_geo,
         "aws/data/dev/mexico/census_geo/2010/locality/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "aws/data/dev/mexico/census_geo/2010/locality/All/census_geo.geojson",
           object = "data/dev/mexico/census_geo/2010/locality/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

#### create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_locality_geo_state = census_locality_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./aws/data/dev/mexico/census_geo/2010/locality/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_geo.geojson",
                    sep = "/")
  st_write(census_locality_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2010/locality/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)}

## AGEB ----------------------------------------------------------
census_mexico_ageb_2010 <- filter(df, ageb_code != "0000" & block_code == "000")

census_mexico_ageb_2010 = census_mexico_ageb_2010 %>%
  mutate(
    entity_level = "ageb",
    block_code = NA,
    block_id = NA)

census_mexico_ageb_2010$ageb_id= paste0(
  formatC(census_mexico_ageb_2010$state_code,width=2, flag="0"), 
  formatC(census_mexico_ageb_2010$municipality_code,width=3, flag="0"),
  formatC(census_mexico_ageb_2010$locality_code,width=4, flag="0"),
  formatC(census_mexico_ageb_2010$ageb_code,width=4, flag="0")
)

### indices
mi_ageb <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2010/im/im_10_ageb.csv")

mi_ageb$ageb_id= paste0(
  formatC(mi_ageb$state_code,width=2, flag="0"), 
  formatC(mi_ageb$municipality_code,width=3, flag="0"),
  formatC(mi_ageb$locality_code,width=4, flag="0"),
  formatC(mi_ageb$ageb_code,width=4, flag="0")  
)

mi_ageb <- select(mi_ageb,
                  ageb_id,
                  mi_nat_s, mi_nat_group)

idu <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2010/idu/idu_10.csv")

idu$block_id = str_pad(idu$block_id, 16, pad="0")  
idu$ageb_id = substr(idu$block_id, 1,13)

idu_ageb <- select(idu,
                   sun_name, sun_id, ageb_id,
                   siu_level_city, siu_level_national
                   )
idu_ageb <- idu_ageb[!duplicated(idu_ageb$ageb_id),]

indices_ageb <- full_join(mi_ageb, idu_ageb, by="ageb_id")
census_mexico_ageb_2010 <- full_join(census_mexico_ageb_2010, indices_ageb, by="ageb_id")
census_mexico_ageb_2010 <- census_mexico_ageb_2010[!duplicated(census_mexico_ageb_2010$ageb_id),]


fwrite(census_mexico_ageb_2010, "aws/data/dev/mexico/census/2010/census_mexico_ageb_2010.csv",
       row.names = FALSE
)

put_object(file = "aws/data/dev/mexico/census/2010/census_mexico_ageb_2010.csv",
           object = "data/dev/mexico_2/census/census_mexico_ageb_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

geo_ageb <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2010/04_ageb_urb_2010.geojson")

geo_ageb <- select(geo_ageb,
                   CVEGEO, geometry
                   )
names(geo_ageb) <- c("ageb_id", "geometry")

census_ageb_geo <-  full_join(census_mexico_ageb_2010, geo_ageb, by = "ageb_id")

dir.create("aws/data/dev/mexico/census_geo/2010/ageb/All", recursive = TRUE)


st_write(census_ageb_geo,
         "aws/data/dev/mexico/census_geo/2010/ageb/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "aws/data/dev/mexico/census_geo/2010/ageb/All/census_geo.geojson",
           object = "data/dev/mexico/census_geo/2010/ageb/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

#### create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_ageb_geo_state = census_ageb_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./aws/data/dev/mexico/census_geo/2010/ageb/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_geo.geojson",
                    sep = "/")
  st_write(census_ageb_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2010/ageb/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)}


## block ----------------------------------------------------------
census_mexico_block_2010 <- filter(df, block_code != "000")

census_mexico_block_2010 = census_mexico_block_2010 %>%
  mutate(
    entity_level = "block")

census_mexico_block_2010$block_id= paste0(
  formatC(census_mexico_block_2010$state_code,width=2, flag="0"), 
  formatC(census_mexico_block_2010$municipality_code,width=3, flag="0"),
  formatC(census_mexico_block_2010$locality_code,width=4, flag="0"),
  formatC(census_mexico_block_2010$ageb_code,width=4, flag="0"),
  formatC(census_mexico_block_2010$block_code,width=3, flag="0")
)


census_mexico_block_2010 <- full_join(census_mexico_block_2010, idu, by = "block_id")
census_mexico_block_2010 <- census_mexico_block_2010[!duplicated(census_mexico_block_2010$block_id),]


fwrite(census_mexico_block_2010, "aws/data/dev/mexico/census/2010/census_mexico_block_2010.csv",
       row.names = FALSE
)

put_object(file = "aws/data/dev/mexico/census/2010/census_mexico_block_2010.csv",
           object = "data/dev/mexico_2/census/census_mexico_block_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

### census_geo
geo_block <- st_read("hhttps://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2010/05_block_urb_2010.geojson")

geo_block <- select(geo_block,
                    cveloc,geometry
)
names(geo_block) <- c("block_id","geometry")


census_block_geo <-  full_join(census_mexico_block_2010, geo_block, by = "block_id")

dir.create("aws/data/dev/mexico/census_geo/2010/block/All", recursive = TRUE)


st_write(census_block_geo,
         "aws/data/dev/mexico/census_geo/2010/block/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "aws/data/dev/mexico/census_geo/2010/block/All/census_geo.geojson",
           object = "data/dev/mexico/census_geo/2010/block/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

#### create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_block_geo_state = census_block_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./aws/data/dev/mexico/census_geo/2010/block/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_geo.geojson",
                    sep = "/")
  st_write(census_block_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2010/block/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)}
