rm(list = ls())
options(scipen = 999)
# set up ------------------------------------------------------------------
library(tidyverse)
library(data.table)
library(dplyr)
library(readr)
library(tidyr)
library(fs)
library(purrr)
library(readr)
library(survey)
library(srvyr)
library(rlang)
library(parallel)
library(foreach)
library(doParallel)
# Detect the number of cores available
num_cores <- detectCores() - 1  # Leaving one core free

# Create a cluster
cl <- makeCluster(num_cores)
registerDoParallel(cl)

mapping <- fread("01_data/01_raw/boundaries/geo_levels_names.csv", encoding="Latin-1")
mapping$mun_code <- substr(mapping$mun_id, 3,7)
mapping$mun_code <- as.integer(mapping$mun_code)

# dwg ---------------------------------------------------------------------
input_folder <- "01_data/02_proc/01_recoded/dwg"
# output
dir.create("01_data/02_proc/02_indicators/dwg", showWarnings = FALSE, recursive = TRUE)
output_folder <- "01_data/02_proc/02_indicators/dwg"

dwg_vars <- c("urban", "rural",
              "owned", "rented", "loaned", "other",
              "walls_masonry", "walls_wood", "walls_rearth", "walls_straw", "walls_other", "nwalls",
              "1rm", "2rms", "3mrms", "1bedrm", "2mbedrms",
              "novc", "bthrm", "toilet", "obdhnb",
              "ss_sewage", "ss_pit", "ss_ditch", "ss_river", "ss_other",
              "water_netwk", "water_well", "water_truck", "water_rain", "water_river", "water_other",
              "garbage_clngsvcs", "garbage_burnt", "garbage_buried", "garbage_throwed", "garbage_other",
              "elect", "inet", "tv", "wm", "refri", "cp", "cmp", "mtrcl", "car")

# Define your custom summary function
dwg_summ <- function(data, group_var) {
  data %>%
    as_survey_design(weights = weight) %>% 
    group_by(across(all_of(c(group_var)))) %>%
    summarize(
      across(all_of(dwg_vars), 
             ~ survey_total(., vartype = "cv", na.rm = TRUE), 
             .names = "d_{.col}"),
      d_dwg = survey_total(vartype = "cv", na.rm = TRUE),
      across(all_of(dwg_vars), 
             ~ survey_mean(., vartype = "cv", na.rm = TRUE), 
             .names = "d_prop_{.col}"),
      d_mean_bedrm_occup = survey_mean(rm_occup, vartype = "cv", na.rm = TRUE),
      d_mean_income = survey_mean(income, vartype = "cv", na.rm = TRUE),
      d_mean_pcincome = survey_mean(pcincome, vartype = "cv", na.rm = TRUE),
      d_mean_rm_occup = survey_mean(rm_occup, vartype = "cv", na.rm = TRUE),
      d_mean_rv = survey_mean(rv, vartype = "cv", na.rm = TRUE)
    )
}

dwg_summ_2 <- function(data, geo_levels, group_var) {
  data %>%
    as_survey_design(weights = weight) %>% 
    group_by(across(all_of(c(geo_levels, group_var)))) %>%
    summarize(
      across(all_of(dwg_vars), 
             ~ survey_total(., vartype = "cv", na.rm = TRUE), 
             .names = "d_{.col}"),
      d_dwg = survey_total(vartype = "cv", na.rm = TRUE),
      across(all_of(dwg_vars), 
             ~ survey_mean(., vartype = "cv", na.rm = TRUE), 
             .names = "d_prop_{.col}"),
      d_mean_bedrm_occup = survey_mean(rm_occup, vartype = "cv", na.rm = TRUE),
      d_mean_income = survey_mean(income, vartype = "cv", na.rm = TRUE),
      d_mean_pcincome = survey_mean(pcincome, vartype = "cv", na.rm = TRUE),
      d_mean_rm_occup = survey_mean(rm_occup, vartype = "cv", na.rm = TRUE),
      d_mean_rv = survey_mean(rv, vartype = "cv", na.rm = TRUE)
    )
}
# Define the directory containing the folders
main_directory <- "01_data/02_proc/01_recoded/dwg"

# List all uf_code folders
reg_folders <- list.dirs(main_directory, recursive = FALSE)

# Export necessary custom functions and variables to the cluster
clusterExport(cl, varlist = c("dwg_summ", "dwg_summ_2", "as_survey_design", "survey_total", "survey_mean"))  # Add other custom functions if needed

# Load required libraries on the cluster nodes
clusterEvalQ(cl, {
  library(data.table)
  library(dplyr)
})

# Define the function
process_dwg <- function(results_list) {
  # Bind rows from the results list
  dwg_ind <- bind_rows(results_list)
  
  # Identify columns to modify
  columns_to_modify <- names(dwg_ind)[grepl("^d_", names(dwg_ind )) & !grepl("_cv$", names(dwg_ind ))]
  
  # Apply the condition and remove _cv columns
  dwg_ind  <- dwg_ind  %>%
    mutate(across(all_of(columns_to_modify), ~ ifelse(get(paste0(cur_column(), "_cv")) > 0.3, NA, .))) %>%
    select(-ends_with("_cv"))
  return(dwg_ind )
}

## reg ----------------------------------------------------------------
results_list <- list() # Initialize the results list

# Parallel loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the dwg_summ_wa function to the combined data
  result <- dwg_summ(combined_data, group_var = "reg_code")
  
  # Return the result for the current folder
  return(result)
}

dwg_ind <- process_dwg(results_list)

# Save the final result to a CSV file
fwrite(dwg_ind , "01_data/02_proc/02_indicators/dwg/dwg_reg.csv", row.names = FALSE)

## uf -------------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the dwg_summ_2 function to the combined data
  result <- dwg_summ_2(combined_data, geo_levels = c("reg_code"), group_var = "uf_code")
  
  # Return the result for the current folder
  return(result)
}

dwg_ind <- process_dwg(results_list)

# Save the final result to a CSV file
fwrite(dwg_ind, "01_data/02_proc/02_indicators/dwg/dwg_uf.csv", row.names = FALSE)
## mesoreg -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the dwg_summ_2 function to the combined data
  result <- dwg_summ_2(combined_data, geo_levels = c("reg_code", "uf_code"), group_var = "mesoreg_code")
  
  # Return the result for the current folder
  return(result)
}

dwg_ind <- process_dwg(results_list)

# Save the final result to a CSV file
fwrite(dwg_ind, "01_data/02_proc/02_indicators/dwg/dwg_mesoreg.csv", row.names = FALSE)

## microreg -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the dwg_summ_2 function to the combined data
  result <- dwg_summ_2(combined_data, geo_levels = c("reg_code", "uf_code", "mesoreg_code"), group_var = "microreg_code")
  
  # Return the result for the current folder
  return(result)
}

dwg_ind <- process_dwg(results_list)

# Save the final result to a CSV file
fwrite(dwg_ind, "01_data/02_proc/02_indicators/dwg/dwg_microreg.csv", row.names = FALSE)

## metro -------------------------------------------------------------------
# Parallel loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Merge with the mapping file to add mun_id and metro_name
  combined_data <- left_join(combined_data, mapping, by = c("uf_code", "mun_code"))
  
  # Apply the dwg_summ_2 function to the combined data
  result <- dwg_summ_2(combined_data, geo_levels = c("metro_name", "mun_id"), group_var = "metro_name")
  
  # Return the result for the current folder
  return(result)
}
dwg_ind <- process_dwg(results_list)
fwrite(dwg_ind, "01_data/02_proc/02_indicators/dwg/dwg_metro.csv", row.names = FALSE)

## mun -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the dwg_summ_2 function to the combined data
  result <- dwg_summ_2(combined_data, geo_levels = c("reg_code", "uf_code", "mesoreg_code", "microreg_code"), group_var = "mun_code")
  
  # Return the result for the current folder
  return(result)
}

dwg_ind <- process_dwg(results_list)

# Save the final result to a CSV file
fwrite(dwg_ind, "01_data/02_proc/02_indicators/dwg/dwg_mun.csv", row.names = FALSE)

## wa -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the dwg_summ_2 function to the combined data
  result <- dwg_summ_2(combined_data, geo_levels = c("reg_code", "uf_code", "mesoreg_code", "microreg_code", "mun_code"), group_var = "wa_id")
  
  # Return the result for the current folder
  return(result)
}

dwg_ind <- process_dwg(results_list)

# Save the final result to a CSV file
fwrite(dwg_ind, "01_data/02_proc/02_indicators/dwg/dwg_wa.csv", row.names = FALSE)


# pop ---------------------------------------------------------------------
dir.create("01_data/02_proc/02_indicators/pop", showWarnings = FALSE, recursive = TRUE)

pop_vars <- c("tot_m", "tot_f",
              "0to5", "0to5_f", "0to5_m",
              "6to11", "6to11_f", "6to11_m",
              "12to17", "12to17_f", "12to17_m",
              "18to24", "18to24_f", "18to24_m",
              "25to64", "25to64_f", "25to64_m",
              "65m", "65m_f", "65m_m",
              "tdr", "chddr", "olddr",
              "wht", "wht_f", "wht_m",
              "black", "black_f", "black_m",
              "yellow", "yellow_f", "yellow_m",
              "brown", "brown_f", "brown_m",
              "indig", "indig_f", "indig_m",
              "disab_vis", "disab_vis_f", "disab_vis_m",
              "disab_hear", "disab_hear_f", "disab_hear_m",
              "disab_mtr", "disab_mtr_f", "disab_mtr_m",
              "disab_mntl", "disab_mntl_f", "disab_mntl_m",
              "disab", "disab_f", "disab_m",
              "born_om", "born_om_f", "born_om_m",
              "born_os", "born_os_f", "born_os_m",
              "lit", "lit_f", "lit_m",
              "6to11as", "6to11as_f", "6to11as_m",
              "12to17as", "12to17as_f", "12to17as_m",
              "18to24as", "18to24as", "18to24as_m",
              "emp", "emp_f", "emp_m",
              "unem", "unem_f", "unem_m",
              "econia", "econia_f", "econia_m",
              "econa", "econa_f", "econa_m"
)

input_folder <- "01_data/02_proc/01_recoded/pop"

pop_summ <- function(data) {
  data %>%
    as_survey_design(weights = weight) %>% 
    group_by(across(all_of(c(group_var)))) %>%
    summarize(
      across(all_of(pop_vars), 
             ~ survey_total(., vartype = "cv", na.rm = TRUE), 
             .names = "p_{.col}"),
      d_pop = survey_total(vartype = "cv", na.rm = TRUE),
      across(all_of(pop_vars), 
             ~ survey_mean(., vartype = "cv", na.rm = TRUE), 
             .names = "p_prop_{.col}")
    )
}

pop_summ_2 <- function(data) {
  data %>%
    as_survey_design(weights = weight) %>% 
    group_by(across(all_of(c(geo_levels, group_var)))) %>%
    summarize(
      across(all_of(pop_vars), 
             ~ survey_total(., vartype = "cv", na.rm = TRUE), 
             .names = "p_{.col}"),
      d_pop = survey_total(vartype = "cv", na.rm = TRUE),
      across(all_of(pop_vars), 
             ~ survey_mean(., vartype = "cv", na.rm = TRUE), 
             .names = "p_prop_{.col}")
    )
}

# Define the directory containing the folders
main_directory <- "01_data/02_proc/01_recoded/pop"

# List all uf_code folders
reg_folders <- list.dirs(main_directory, recursive = FALSE)

# Export necessary custom functions and variables to the cluster
clusterExport(cl, varlist = c("pop_summ", "pop_summ_2", "as_survey_design", "survey_total", "survey_mean"))  # Add other custom functions if needed

# Load required libraries on the cluster nodes
clusterEvalQ(cl, {
  library(data.table)
  library(dplyr)
})

# Define the function
process_pop <- function(results_list) {
  # Bind rows from the results list
  pop_ind <- bind_rows(results_list)
  
  # Identify columns to modify
  columns_to_modify <- names(pop_ind)[grepl("^d_", names(pop_ind )) & !grepl("_cv$", names(pop_ind ))]
  
  # Apply the condition and remove _cv columns
  pop_ind  <- pop_ind  %>%
    mutate(across(all_of(columns_to_modify), ~ ifelse(get(paste0(cur_column(), "_cv")) > 0.3, NA, .))) %>%
    select(-ends_with("_cv"))
  return(pop_ind )
}


## reg ----------------------------------------------------------------
results_list <- list() # Initialize the results list

# Parallel loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the pop_summ_wa function to the combined data
  result <- pop_summ(combined_data, group_var = "reg_code")
  
  # Return the result for the current folder
  return(result)
}

pop_ind <- process_pop(results_list)

# Save the final result to a CSV file
fwrite(pop_ind , "01_data/02_proc/02_indicators/pop/pop_reg.csv", row.names = FALSE)

## uf -------------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the pop_summ_2 function to the combined data
  result <- pop_summ_2(combined_data, geo_levels = c("reg_code"), group_var = "uf_code")
  
  # Return the result for the current folder
  return(result)
}

pop_ind <- process_pop(results_list)

# Save the final result to a CSV file
fwrite(pop_ind, "01_data/02_proc/02_indicators/pop/pop_uf.csv", row.names = FALSE)

## mesoreg -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the pop_summ_2 function to the combined data
  result <- pop_summ_2(combined_data, geo_levels = c("reg_code", "uf_code"), group_var = "mesoreg_code")
  
  # Return the result for the current folder
  return(result)
}

pop_ind <- process_pop(results_list)

# Save the final result to a CSV file
fwrite(pop_ind, "01_data/02_proc/02_indicators/pop/pop_mesoreg.csv", row.names = FALSE)

## microreg -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the pop_summ_2 function to the combined data
  result <- pop_summ_2(combined_data, geo_levels = c("reg_code", "uf_code", "mesoreg_code"), group_var = "microreg_code")
  
  # Return the result for the current folder
  return(result)
}

pop_ind <- process_pop(results_list)

# Save the final result to a CSV file
fwrite(pop_ind, "01_data/02_proc/02_indicators/pop/pop_microreg.csv", row.names = FALSE)

## metro -------------------------------------------------------------------
# Parallel loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Merge with the mapping file to add mun_id and metro_name
  combined_data <- left_join(combined_data, mapping, by = c("uf_code", "mun_code"))
  
  # Apply the pop_summ_2 function to the combined data
  result <- pop_summ_2(combined_data, geo_levels = c("metro_name", "mun_id"), group_var = "metro_name")
  
  # Return the result for the current folder
  return(result)
}
pop_ind <- process_pop(results_list)
fwrite(pop_ind, "01_data/02_proc/02_indicators/pop/pop_metro.csv", row.names = FALSE)

## mun -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the pop_summ_2 function to the combined data
  result <- pop_summ_2(combined_data, geo_levels = c("reg_code", "uf_code", "mesoreg_code", "microreg_code"), group_var = "mun_code")
  
  # Return the result for the current folder
  return(result)
}

pop_ind <- process_pop(results_list)

# Save the final result to a CSV file
fwrite(pop_ind, "01_data/02_proc/02_indicators/pop/pop_mun.csv", row.names = FALSE)

## wa -----------------------------------------------------------------
# Initialize an empty list to store results
results_list <- list()

# Loop over each reg_code folder
results_list <- foreach(reg_folder = reg_folders, .packages = c("data.table", "dplyr")) %dopar% {
  # List all CSV files in the current reg_code folder
  csv_files <- list.files(reg_folder, pattern = "*.csv", full.names = TRUE)
  
  # Read and combine all CSV files in the current folder
  combined_data <- bind_rows(lapply(csv_files, fread))
  
  # Apply the pop_summ_2 function to the combined data
  result <- pop_summ_2(combined_data, geo_levels = c("reg_code", "uf_code", "mesoreg_code", "microreg_code", "mun_code"), group_var = "wa_id")
  
  # Return the result for the current folder
  return(result)
}

pop_ind <- process_pop(results_list)

# Save the final result to a CSV file
fwrite(pop_ind, "01_data/02_proc/02_indicators/pop/pop_wa.csv", row.names = FALSE)

