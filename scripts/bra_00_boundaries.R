# set up ------------------------------------------------------------------
# Clear environment
rm(list = ls())

# Load necessary libraries
library(dplyr)
library(geobr)
library(sf)
library(lwgeom)
library(readxl)

ids <- read_excel("00_doc/Documentacao/Documentação/Divisão Territorial do Brasil/Unidades da Federação, Mesorregiões, microrregiões e municípios 2010_modif.xls")

setwd("01_data/01_raw/boundaries/")

# downloading -------------------------------------------------------------
nat <- read_country(year=2010) |> 
    st_write("nat.geojson")

reg <- read_region(year = 2010) |> 
  setNames(c("reg_code", "reg_name", "geom")) |> 
  st_write("reg.geojson", delete_dsn = TRUE)

uf <- read_state(year=2010) |> 
  setNames(c("uf_code", "uf_name", "reg_code", "reg_name", "geom")) |> 
  st_write("uf.geojson")

uf_codes <- unique(uf$abbrev_state) # get a vector of uf codes to download census tract files

uf <- read_state(year=2010) |> 
  select(-abbrev_state)  
  
mesoreg <- read_meso_region(year=2010) |> 
  select(-abbrev_state) |> 
  setNames(c("uf_code", "uf_name", "mesoreg_id", "mesoreg_name", "geom")) |> 
  st_write("mesoreg.geojson")

microreg <- read_micro_region(year=2010) |> 
  select(-abbrev_state) |> 
  setNames(c("uf_code", "uf_name", "microreg_id", "microreg_name", "geom")) |> 
  st_write("microreg.geojson")

metro <- read_metro_area(year=2010) |> 
  select(-abbrev_state) |> 
  setNames(c("mun_id", "mun_name", "uf_code", "metro_name", "metro_type", "metro_legislation_date", "geom"))|> 
  st_write("metro.geojson")

mun_10 <- read_municipality(year=2010)
mun_20 <- read_municipality(year=2020)
mun <- read_municipality(year=2010) |> 
  select(-abbrev_state) |> 
  setNames(c("mun_id", "mun_name", "uf_code", "geom")) |> 
  st_write("mun.geojson")

wa <- read_weighting_area(year=2010) |> 
  select(-abbrev_state) |> 
  setNames(c("wa_id","mun_id", "mun_name", "uf_code", "reg_code", "reg_name","geom")) |> 
  st_write("wa.geojson")

# geo_levels_names --------------------------------------------------------
# Define a function to process each data frame
process_df <- function(df, select_cols = NULL) {
  df <- df %>%
    st_drop_geometry() %>%
    as.data.frame() %>%
    mutate(across(everything(), as.character))
  
  if (!is.null(select_cols)) {
    df <- df %>% select(all_of(select_cols))
  }
  
  return(df)
}

# Process each data frame
mun_names <- process_df(mun)
uf_names <- process_df(uf)
reg_names <- process_df(reg)
mesoreg_names <- process_df(mesoreg, c("mesoreg_id", "mesoreg_name"))
microreg_names <- process_df(microreg, c("microreg_id", "microreg_name"))
metro_names <- process_df(metro) %>% select(-mun_name)

# Join data frames
names0 <- full_join(ids, mun_names, by = c("uf_code", "mun_id"))
names <- full_join(uf_names, reg_names) %>%
  full_join(names0) %>%
  full_join(mesoreg_names) %>%
  full_join(microreg_names) %>%
  full_join(metro_names)

# Write to CSV
write.csv(names, "geo_levels_names_full.csv", row.names = FALSE, fileEncoding = "latin1")
# census tract ------------------------------------------------------------

# Create directories for census tract data
dir.create("tract_uf/", showWarnings = FALSE)

# Function to process and save census tract data for each state
process_census_tract <- function(state_code) {
  current_state_data <- read_census_tract(
    code_tract = state_code, 
    year = 2010,
    showProgress = FALSE
  ) %>%
    mutate(uf_code = substr(code_subdistrict, 1, 2)) %>%
    select(code_state, code_muni, name_muni, code_tract) %>%
    rename(uf_code = code_state,
           tract_id = code_tract,
           mun_id = code_muni,
           mun_name = name_muni)
  
  st_write(current_state_data, 
           paste0("01_data/01_raw/boundaries/tract_uf/", state_code, ".geojson"), 
           delete_dsn = TRUE)
}

# Process census tract data for each state
lapply(uf_codes, process_census_tract)

# Combine all state GeoJSON files into one
folder_path <- "tract_uf"
geojson_files <- list.files(path = folder_path, pattern = "\\.geojson$", 
                            full.names = TRUE)
tract <- geojson_files %>%
  lapply(st_read) %>%
  bind_rows() %>%
  select(-uf_code, -mun_name)

st_write(tract, "tract.geojson", delete_dsn = TRUE)
