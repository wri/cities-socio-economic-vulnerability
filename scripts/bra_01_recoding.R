rm(list=ls())
library(dplyr)
library(readr)
library(data.table)
# Detect the number of cores available
num_cores <- detectCores() - 1  # Leaving one core free

# Create a cluster
cl <- makeCluster(num_cores)unit 
registerDoParallel(cl)
# Load required libraries on the cluster nodes
clusterEvalQ(cl, {
  library(data.table)
  library(dplyr)
  library(readr)
})
# Dwellings  --------------------------------------------------------------
transform_data <- function(df) {
  df %>%
    filter(
          V4002 %in% c(11, 12, 13, 14, 15)) %>% # Keep dwg that are habitable (Casa, Casa de vila ou em condomínio, Apartamento, Habitação em: casa de cômodos, cortiço ou cabeça de porco, Oca ou maloca)
     mutate(
       # Weight
       weight = V0010,
       # Geoids
       uf_code = V0001,
       mun_code = V0002,
       wa_id = V0011,
       reg_code = V1001,
       mesoreg_code = V1002,
       microreg_code = V1003,
       sector = V1005,
       # Urbanized
       urban = ifelse(is.na(V1006), NA, ifelse(V1006 == 1, 1, 0)),
       rural = ifelse(is.na(V1006), NA, ifelse(V1006 == 2, 1, 0)),
       
       # Income
       income = V6529,
       pcincome = V6531,
       
       # Ownership
       owned = ifelse(V0201 == 1 | V0201 == 2, 1, 0),
       rented = ifelse(V0201 == 3, 1, 0),
       rv = V2011,
       
       loaned = ifelse(V0201 == 4 | V0201 == 5, 1, 0),
       other = ifelse(V0201 == 6, 1, 0),
       
       # Quality
       ## Walls material
       walls_masonry = ifelse(is.na(V0202) | V0202 == 9, NA, ifelse(V0202 == 1 | V0202 == 2, 1, 0)),
       walls_wood = ifelse(is.na(V0202) | V0202 == 9, NA, ifelse(V0202 == 3 | V0202 == 6, 1, 0)),
       walls_rearth = ifelse(is.na(V0202) | V0202 == 9, NA, ifelse(V0202 == 4 | V0202 == 5, 1, 0)),
       walls_straw = ifelse(is.na(V0202) | V0202 == 9, NA, ifelse(V0202 == 7, 1, 0)),
       walls_other = ifelse(is.na(V0202) | V0202 == 9, NA, ifelse(V0202 == 8, 1, 0)),
       nwalls = ifelse(is.na(V0202), NA, ifelse(V0202 == 9, 1, 0)),
       
       ## Rooms and bedrooms
       `1rm` = ifelse(is.na(V0203), NA, ifelse(V0203 == 1, 1, 0)),
       `2rms` = ifelse(is.na(V0203), NA, ifelse(V0203 == 2, 1, 0)),
       `3mrms` = ifelse(is.na(V0203), NA, ifelse(V0203 >= 3, 1, 0)),
       rm_occup = V6203, 
       `1bedrm` = ifelse(is.na(V0204), NA, ifelse(V0204 == 1, 1, 0)),
       `2mbedrms` = ifelse(is.na(V0204), NA, ifelse(V0204 >= 2, 1, 0)),  
       bedrm_occup = V6204,      
       
       ### novc : no overcrowd
       novc = ifelse(is.na(V6204), NA, ifelse(V6204 < 2.5, 1, 0)),
       
       ## Bathrooms  
       bthrm = ifelse(is.na(V0205), NA, ifelse(V0205 > 1, 1, 0)),
       toilet = ifelse(is.na(V0206), NA, ifelse(V0206 == 1, 1, 0)), # This variable has values only if V0205=0
       obdhnb = ifelse(is.na(V0205) | is.na(V0206), NA, ifelse(V0205 == 0 & V0206 == 2, 1, 0)),
       
       # Basic services
       ## Sewage
       ss_sewage = ifelse(is.na(V0207), NA, ifelse(V0207 == 1, 1, 0)),
       ss_pit = ifelse(is.na(V0207), NA, ifelse(V0207 == 2 | V0207 == 3, 1, 0)),
       ss_ditch = ifelse(is.na(V0207), NA, ifelse(V0207 == 4, 1, 0)),
       ss_river = ifelse(is.na(V0207), NA, ifelse(V0207 == 5, 1, 0)),
       ss_other = ifelse(is.na(V0207), NA, ifelse(V0207 == 6, 1, 0)),
       
       ## Water
       water_netwk = ifelse(is.na(V0208), NA, ifelse(V0208 == 1, 1, 0)),
       water_well = ifelse(is.na(V0208), NA, ifelse(V0208 %in% c(2,3), 1, 0)),
       water_truck = ifelse(is.na(V0208), NA, ifelse(V0208 == 4, 1, 0)),
       water_rain = ifelse(is.na(V0208), NA, ifelse(V0208 %in% c(5,6), 1, 0)),                        
       water_river = ifelse(is.na(V0208), NA, ifelse(V0208 == 7, 1, 0)),
       water_other = ifelse(is.na(V0208), NA, ifelse(V0208 > 7, 1, 0)),
       
       ## Garbage
       garbage_clngsvcs = ifelse(is.na(V0210), NA, ifelse(V0210 %in% c(1,2), 1, 0)),
       garbage_burnt = ifelse(is.na(V0210), NA, ifelse(V0210 == 3, 1, 0)),
       garbage_buried = ifelse(is.na(V0210), NA, ifelse(V0210 == 4, 1, 0)),
       garbage_throwed = ifelse(is.na(V0210), NA, ifelse(V0210 %in% c(5,6), 1, 0)),
       garbage_other = ifelse(is.na(V0210), NA, ifelse(V0210 == 7, 1, 0)),
       
       ## Electricity
       elect = ifelse(is.na(V0211), NA, ifelse(V0211 %in% c(1,2), 1, 0)),
       
       ## Internet
       inet = ifelse(is.na(V0220), NA, ifelse(V0220 == 1, 1, 0)),
       
       # Goods
       tv = ifelse(is.na(V0214), NA, ifelse(V0214 == 1, 1, 0)),
       wm = ifelse(is.na(V0215), NA, ifelse(V0215 == 1, 1, 0)),
       refri = ifelse(is.na(V0216), NA, ifelse(V0216 == 1, 1, 0)),
       cp = ifelse(is.na(V0217), NA, ifelse(V0217 == 1, 1, 0)),
       cmp = ifelse(is.na(V0219), NA, ifelse(V0219 == 1, 1, 0)),
       mtrcl = ifelse(is.na(V0221), NA, ifelse(V0221 == 1, 1, 0)),
       car = ifelse(is.na(V0222), NA, ifelse(V0222 == 1, 1, 0))
    ) %>%
    select(
      # Weight
      weight,
      #Geoids
      uf_code, mun_code, wa_id,
      reg_code, mesoreg_code, microreg_code, 
      # Urbanized
      urban, rural,
      # Income
      income, pcincome,
      # Alquiler
      rv,
      # Recoded
      owned, rented, loaned, other,
      walls_masonry, walls_wood, walls_rearth, walls_straw, walls_other, nwalls,
      `1rm`, `2rms`, `3mrms`, rm_occup, `1bedrm`, `2mbedrms`, bedrm_occup,
      novc,
      bthrm, toilet, obdhnb,
      ss_sewage, ss_pit, ss_ditch, ss_river, ss_other,
      water_netwk, water_well, water_truck, water_rain, water_river, water_other,
      garbage_clngsvcs, garbage_burnt, garbage_buried, garbage_throwed, garbage_other,
      elect,
      inet,
      tv, wm, refri, cp, cmp, mtrcl, car)
}


# File paths
input_folder <- "01_data/01_raw/dados_csv2010/dom"
dir.create("01_data/02_proc/01_recoded/dwg/")
output_folder <- "01_data/02_proc/01_recoded/dwg/"

# Get list of uf folders
uf_folders <- list.dirs(input_folder, recursive = FALSE)

# Process each uf folder
for (uf_folder in uf_folders) {
  uf_name <- basename(uf_folder)
  
  # Get list of municipality CSV files
  file_list <- list.files(uf_folder, pattern = "\\.csv$", full.names = TRUE)
  
  # Process each file
  for (file in file_list) {
    df <- fread(file, showProgress = FALSE)
    
    # Extract wa_id from the file name
    wa_id <- tools::file_path_sans_ext(basename(file))
    
    # Transform the data
    df_transformed <- transform_data(df)
    
    # Split the transformed data by wa_id
    wa_id_split <- split(df_transformed, df_transformed$wa_id)
    
    # Process each split by wa_id
    for (wa_id_name in names(wa_id_split)) {
      df_wa_id <- wa_id_split[[wa_id_name]]
      
      # Get unique reg_codes from the transformed data
      reg_codes <- unique(df_wa_id$reg_code)
      
      # Create a folder for each reg_code and save the corresponding files
      for (reg_code in reg_codes) {
        # Define the output directory for the reg_code
        reg_code_folder <- file.path(output_folder, as.character(reg_code))
        if (!dir.exists(reg_code_folder)) {
          dir.create(reg_code_folder, recursive = TRUE)
        }
        
        # Construct the new file name and output path
        new_file_name <- paste0(wa_id_name, ".csv")
        output_file <- file.path(reg_code_folder, new_file_name)
        
        # Save the transformed data to the new folder
        fwrite(df_wa_id, output_file)
      }
    }
  }
}
# pop ---------------------------------------------------------------------
rm(list = ls())
library(dplyr)
library(readr)
library(data.table)

transform_data <- function(df) {
  df %>%
    mutate(
      # Weight
      weight = V0010,
      # Geoids
      uf_code = V0001,
      mun_code = V0002,
      wa_id = V0011,
      reg_code = V1001,
      mesoreg_code = V1002,
      microreg_code = V1003,
      # Urban
      urban = ifelse(is.na(V1006), NA, ifelse(V1006 == 1, 1, 0)),
      rural = ifelse(is.na(V1006), NA, ifelse(V1006 == 2, 1, 0)),
      # Sex
      tot_m = ifelse(V0601 == 1, 1, 0),
      tot_f = ifelse(V0601 == 2, 1, 0),
      
      # Age groups
      `0to5` = ifelse(V6036 >= 0 & V6036 <= 5, 1, 0),
      `0to5_f` = ifelse(`0to5` == 1 & V0601 == 2, 1, 0),
      `0to5_m` = ifelse(`0to5` == 1 & V0601 == 1, 1, 0),
      
      `6to11` = ifelse(V6036 >= 6 & V6036 <= 11, 1, 0),
      `6to11_f` = ifelse(`6to11` == 1 & V0601 == 2, 1, 0),
      `6to11_m` = ifelse(`6to11` == 1 & V0601 == 1, 1, 0),
      
      `12to17` = ifelse(V6036 >= 12 & V6036 <= 17, 1, 0),
      `12to17_f` = ifelse(`12to17` == 1 & V0601 == 2, 1, 0),
      `12to17_m` = ifelse(`12to17` == 1 & V0601 == 1, 1, 0),
      
      `18to24` = ifelse(V6036 >= 18 & V6036 <= 24, 1, 0),
      `18to24_f` = ifelse(`18to24` == 1 & V0601 == 2, 1, 0),
      `18to24_m` = ifelse(`18to24` == 1 & V0601 == 1, 1, 0),
      
      `25to64` = ifelse(V6036 >= 25 & V6036 <= 64, 1, 0),
      `25to64_f` = ifelse(`25to64` == 1 & V0601 == 2, 1, 0),
      `25to64_m` = ifelse(`25to64` == 1 & V0601 == 1, 1, 0),
      
      `65m` = ifelse(V6036 >= 65, 1, 0),
      `65m_f` = ifelse(`65m` == 1 & V0601 == 2, 1, 0),
      `65m_m` = ifelse(`65m` == 1 & V0601 == 1, 1, 0),
      
      tdr = ifelse(V6036 >= 15 & V6036 <= 64, 0, 1),
      chddr = ifelse(V6036 < 15, 1, ifelse(V6036 >= 65, NA, 0)),
      olddr = ifelse(V6036 >= 65, 1, ifelse(V6036 >= 15 & V6036 <= 64, 0, NA)),
      
      # Race
      wht = ifelse(V0606 == 1, 1, 0),
      wht_f = ifelse(V0606 == 1 & V0601 == 2, 1, 0),
      wht_m = ifelse(V0606 == 1 & V0601 == 1, 1, 0),
      
      black = ifelse(V0606 == 2, 1, 0),
      black_f = ifelse(V0606 == 2 & V0601 == 2, 1, 0),
      black_m = ifelse(V0606 == 2 & V0601 == 1, 1, 0),
      
      yellow = ifelse(V0606 == 3, 1, 0),
      yellow_f = ifelse(V0606 == 3 & V0601 == 2, 1, 0),
      yellow_m = ifelse(V0606 == 3 & V0601 == 1, 1, 0),
      
      brown = ifelse(V0606 == 4, 1, 0),
      brown_f = ifelse(V0606 == 4 & V0601 == 2, 1, 0),
      brown_m = ifelse(V0606 == 4 & V0601 == 1, 1, 0),
      
      indig = ifelse(V0606 == 5, 1, 0),
      indig_f = ifelse(V0606 == 5 & V0601 == 2, 1, 0),
      indig_m = ifelse(V0606 == 5 & V0601 == 1, 1, 0),
      
      # Disability
      ## Seeing
      disab_vis = ifelse(is.na(V0614), NA, ifelse(V0614 == 4, 0, 1)),
      disab_vis_f = ifelse(V0601 == 2, ifelse(V0614 == 4, 0, 1), NA),
      disab_vis_m = ifelse(V0601 == 1, ifelse(V0614 == 4, 0, 1), NA),
      
      ## Hearing
      disab_hear = ifelse(is.na(V0615), NA, ifelse(V0615 == 4, 0, 1)),
      disab_hear_f = ifelse(V0601 == 2, ifelse(V0615 == 4, 0, 1), NA),
      disab_hear_m = ifelse(V0601 == 1, ifelse(V0615 == 4, 0, 1), NA),
      
      ## Walking
      disab_mtr = ifelse(is.na(V0616), NA, ifelse(V0616 == 4, 0, 1)),
      disab_mtr_f = ifelse(V0601 == 2, ifelse(V0616 == 4, 0, 1), NA),
      disab_mtr_m = ifelse(V0601 == 1, ifelse(V0616 == 4, 0, 1), NA),
      
      ## Mental
      disab_mntl = ifelse(is.na(V0617), NA, ifelse(V0617 == 2, 0, 1)),
      disab_mntl_f = ifelse(V0601 == 2, ifelse(V0617 == 2, 0, 1), NA),
      disab_mntl_m = ifelse(V0601 == 1, ifelse(V0617 == 2, 0, 1), NA),
      
      ## Any
      disab = ifelse(disab_vis == 1 | disab_hear == 1 | disab_mtr == 1 | disab_mntl == 1, 1, 0),
      disab_f = ifelse(V0601 == 2, ifelse(disab_vis == 1 | disab_hear == 1 | disab_mtr == 1 | disab_mntl == 1, 1, 0), NA),
      disab_m = ifelse(V0601 == 1, ifelse(disab_vis == 1 | disab_hear == 1 | disab_mtr == 1 | disab_mntl == 1, 1, 0), NA),
      
      # Born in other municipality
      born_om = ifelse(is.na(V0618), NA, ifelse(V0618 == 1, 1, 0)),
      born_om_f = ifelse(V0601 == 2, ifelse(V0618 == 1, 1, 0), NA),
      born_om_m = ifelse(V0601 == 1, ifelse(V0618 == 1, 1, 0), NA),
      
      # Born in other uf
      born_os = ifelse(is.na(V0619), NA, ifelse(V0619 == 1, 1, 0)),
      born_os_f = ifelse(V0601 == 2, ifelse(V0619 == 1, 1, 0), NA),
      born_os_m = ifelse(V0601 == 1, ifelse(V0619 == 1, 1, 0), NA),
      
      # Literacy
      lit = ifelse(is.na(V0627), NA, ifelse(V0627 == 1, 1,0)),
      lit_f = ifelse(V0601 == 2, ifelse(V0627 == 1, 1, 0), NA),
      lit_m = ifelse(V0601 == 1, ifelse(V0627 == 1, 1, 0), NA),

      # School attendance
      `6to11as` = ifelse(is.na(V0628) | `6to11` != 1, NA, ifelse(V0628 %in% c(1,2), 1, 0)),
      `6to11as_f` = ifelse(V0601 == 2 & `6to11_f` == 1, ifelse(V0628 %in% c(1,2), 1, 0), NA),
      `6to11as_m` = ifelse(V0601 == 1 & `6to11_m` == 1, ifelse(V0628 %in% c(1,2), 1, 0), NA),
      
      `12to17as` = ifelse(is.na(V0628) | `12to17` != 1, NA, ifelse(V0628 %in% c(1,2), 1, 0)),
      `12to17as_f` = ifelse(V0601 == 2 & `12to17_f` == 1, ifelse(V0628 %in% c(1,2), 1, 0), NA),
      `12to17as_m` = ifelse(V0601 == 1 & `12to17_m` == 1, ifelse(V0628 %in% c(1,2), 1, 0), NA),
      
      `18to24as` = ifelse(is.na(V0628) | `18to24` != 1, NA, ifelse(V0628 %in% c(1,2), 1, 0)),
      `18to24as_f` = ifelse(V0601 == 2 & `18to24_f` == 1, ifelse(V0628 %in% c(1,2), 1, 0), NA),
      `18to24as_m` = ifelse(V0601 == 1 & `18to24_m` == 1, ifelse(V0628 %in% c(1,2), 1, 0), NA),
      
      # Employment
      emp = ifelse(is.na(V6910), NA, ifelse(V6910 == 1, 1, 0)),
      emp_f = ifelse(V0601 == 2, ifelse(V6910 == 1, 1, 0), NA),
      emp_m = ifelse(V0601 == 1, ifelse(V6910 == 1, 1, 0), NA),
      
      unem = ifelse(is.na(V6910), NA, ifelse(V6910 == 2, 1, 0)),
      unem_f = ifelse(V0601 == 2, ifelse(V6910 == 2, 1, 0), NA),
      unem_m = ifelse(V0601 == 1, ifelse(V6910 == 2, 1, 0), NA),
      
      econia = ifelse(is.na(V6900), NA, ifelse(V6900 == 2, 1, 0)),
      econia_f = ifelse(V0601 == 2, ifelse(V6900 == 2, 1, 0), NA),
      econia_m = ifelse(V0601 == 1, ifelse(V6900 == 2, 1, 0), NA),
      
      econa = ifelse(is.na(V6900), NA, ifelse(V6900 == 1, 1, 0)),
      econa_f = ifelse(V0601 == 2, ifelse(V6900 == 1, 1, 0), NA),
      econa_m = ifelse(V0601 == 1, ifelse(V6900 == 1, 1, 0), NA)
     ) %>% 
    select(
      # Weight
      weight,
      #Geoids
      uf_code, mun_code, wa_id,
      reg_code, mesoreg_code, microreg_code, 
      tot_m, tot_f,
      
      `0to5`, `0to5_f`, `0to5_m`,
      `6to11`, `6to11_f`, `6to11_m`,
      `12to17`, `12to17_f`, `12to17_m`,
      `18to24`, `18to24_f`, `18to24_m`,
      `25to64`, `25to64_f`, `25to64_m`,
      `65m`, `65m_f`, `65m_m`,

           tdr, chddr, olddr,
           wht, wht_f, wht_m,
           black, black_f, black_m,
           yellow, yellow_f, yellow_m,
           brown, brown_f, brown_m,
           indig, indig_f, indig_m,
           disab_vis, disab_vis_f, disab_vis_m,
           disab_hear, disab_hear_f, disab_hear_m,
           disab_mtr, disab_mtr_f, disab_mtr_m,
           disab_mntl, disab_mntl_f, disab_mntl_m,
           disab, disab_f, disab_m,
           born_om, born_om_f, born_om_m,
           born_os, born_os_f, born_os_m,
           lit, lit_f, lit_m,
           `6to11as`, `6to11as_f`, `6to11as_m`,
           `12to17as`, `12to17as_f`, `12to17as_m`,
           `18to24as`, `18to24as`, `18to24as_m`,
           emp, emp_f, emp_m,
           unem, unem_f, unem_m,
           econia, econia_f, econia_m,
           econa, econa_f, econa_m) 
    
    }
      
# File paths
input_folder <- "01_data/01_raw/dados_csv2010/pes"
dir.create("01_data/02_proc/01_recoded/pop")
dir.create("01_data/02_proc/01_recoded/pop")
output_folder <- "01_data/02_proc/01_recoded/pop"

# Get list of uf folders
uf_folders <- list.dirs(input_folder, recursive = FALSE)

# Process each uf folder
for (uf_folder in uf_folders) {
  uf_name <- basename(uf_folder)
  
  # Get list of municipality CSV files
  file_list <- list.files(uf_folder, pattern = "\\.csv$", full.names = TRUE)
  
  # Process each file
  for (file in file_list) {
    df <- fread(file, showProgress = FALSE)
    
    # Extract wa_id from the file name
    wa_id <- tools::file_path_sans_ext(basename(file))
    
    # Transform the data
    df_transformed <- transform_data(df)
    
    # Split the transformed data by wa_id
    wa_id_split <- split(df_transformed, df_transformed$wa_id)
    
    # Process each split by wa_id
    for (wa_id_name in names(wa_id_split)) {
      df_wa_id <- wa_id_split[[wa_id_name]]
      
      # Get unique reg_codes from the transformed data
      reg_codes <- unique(df_wa_id$reg_code)
      
      # Create a folder for each reg_code and save the corresponding files
      for (reg_code in reg_codes) {
        # Define the output directory for the reg_code
        reg_code_folder <- file.path(output_folder, as.character(reg_code))
        if (!dir.exists(reg_code_folder)) {
          dir.create(reg_code_folder, recursive = TRUE)
        }
        
        # Construct the new file name and output path
        new_file_name <- paste0(wa_id_name, ".csv")
        output_file <- file.path(reg_code_folder, new_file_name)
        
        # Save the transformed data to the new folder
        fwrite(df_wa_id, output_file)
      }
    }
  }
}