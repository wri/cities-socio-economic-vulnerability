rm(list=ls()) # Clear environment

library(data.table)
library(tidyverse)
library(dplyr)
library(sf)

data_format <- function(df) {
  df <- df |>
    mutate(across(ends_with("_id"), as.character)) |>
    mutate(across(ends_with("_code"), as.character)) 
  return(df)
}

columns_to_add <- c(
  "reg_code","reg_name",  
  "uf_code", "uf_name",
  "mesoreg_code","mesoreg_id","mesoreg_name",
  "microreg_code","microreg_id",
  "metro_name", "metro_type",
  "mun_code", "mun_id", "mun_name",  
  "wa_id", "tract_id"
)
dir.create("01_data/02_proc/04_census_geo")

# mapping -----------------------------------------------------------------
# Read data
mapping <- fread("01_data/01_raw/boundaries/geo_levels_names.csv",
                 encoding = "Latin-1")

# Extract codes from ids
mapping <- mapping |>
  mutate(
    uf_code = substr(mun_id, 1, 2),
    mun_code = substr(mun_id, 3, 7),
    mesoreg_code = substr(mesoreg_id, 3, 4),
    microreg_code = substr(microreg_id, 3, 5)) |>
  data_format()

# nat ---------------------------------------------------------------------
# Create necessary directories
dir.create("01_data/02_proc/04_census_geo/nat/All", recursive = TRUE, showWarnings = FALSE)

# Load data and set additional columns
df <- fread("01_data/02_proc/02_indicators/nat.csv")
df <- df |>
  mutate(year = "2010", entity_level = "Nation")

# Read geojson and join with data
geo <- st_read("01_data/01_raw/boundaries/nat.geojson")
census_geo <- cbind(df, geo, all = TRUE)

param_cols <- setdiff(columns_to_add, colnames(census_geo))

if(length(param_cols) > 0) {
  # Generate missing columns
  census_geo[, param_cols] <- NA
}

# Write the result to a geojson file
st_write(census_geo, "01_data/02_proc/04_census_geo/nat/All/census_geo.geojson", append = FALSE)

# region ------------------------------------------------------------------
# Load indicator data and add columns for year and entity level
df <- fread("01_data/02_proc/02_indicators/reg.csv") |>
  mutate(year = "2010", entity_level = "Region")

# Read the regional boundaries from the GeoJSON file
geo <- st_read("01_data/01_raw/boundaries/reg.geojson")

# Perform a full join of the indicator data and geographic boundaries by region code
census_geo <- full_join(df, geo, by = "reg_code")

# Identify columns that need to be added to the dataset
param_cols <- setdiff(columns_to_add, colnames(census_geo))

if(length(param_cols) > 0) {
  # Generate missing columns
  census_geo[, param_cols] <- NA
}

# Create necessary directories for storing processed data
dir.create("01_data/02_proc/04_census_geo/reg/All", recursive = TRUE, showWarnings = FALSE)

# Save the complete dataset as a GeoJSON file
st_write(census_geo, "01_data/02_proc/04_census_geo/reg/All/census_geo.geojson", append = FALSE)

# Get a list of unique region codes
reg_codes <- unique(census_geo$reg_code)

# Loop through each region code to create directories and save GeoJSON files
for (reg_i_code in reg_codes) {
  
  # Filter the dataset for the current region
  census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
  
  # Define the directory path for the current region and create the directory
  dir_path <- file.path("01_data/02_proc/04_census_geo/reg", reg_i_code)
  dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
  
  # Define the file path for the GeoJSON file and save the filtered dataset
  file_path <- file.path(dir_path, "census_geo.geojson")
  st_write(census_geo_i, file_path, delete_dsn = TRUE, append = FALSE)
}
# uf ----------------------------------------------------------------
# Load indicator data and apply custom formatting
df <- fread("01_data/02_proc/02_indicators/uf.csv") |>
  data_format() |>  # Apply the data_format function to clean or format the data
  mutate(year = "2010", entity_level = "Federation Unit")  # Add year and entity level columns

# Read the geographic boundaries for Federation Units and apply custom formatting
geo <- st_read("01_data/01_raw/boundaries/uf.geojson") |>
  data_format()  # Apply the data_format function to clean or format the geographic data

# Perform a full join of the indicator data and geographic boundaries by region and UF codes
census_geo <- full_join(df, geo, by = c("reg_code", "uf_code"))

param_cols <- setdiff(columns_to_add, colnames(census_geo))
if(length(param_cols) > 0) {
  census_geo[, param_cols] <- NA
}

dir.create("01_data/02_proc/04_census_geo/uf/All", recursive = TRUE, showWarnings = FALSE)
st_write(census_geo, "01_data/02_proc/04_census_geo/uf/All/census_geo.geojson")

reg_codes <- unique(census_geo$reg_code)
# Create directory for each department
for (reg_i_code in reg_codes) {
  census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
  dir_path <- file.path("./01_data/02_proc/04_census_geo/uf/", reg_i_code)
  dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
  file_path <- file.path(dir_path, "census_geo.geojson")
  st_write(census_geo_i, file_path, delete_dsn = TRUE, append=FALSE)
}

# mesoreg ----------------------------------------------------------------------
df <- fread("01_data/02_proc/02_indicators/mesoreg.csv") |>
  mutate(mesoreg_code = str_pad(mesoreg_code, width = 2, pad = "0"),
         mesoreg_id = paste0(uf_code, mesoreg_code))

geo <- st_read("01_data/01_raw/boundaries/mesoreg.geojson") |>
  data_format()

mapping_s <- mapping |>
  select(reg_name, mesoreg_id) |>
  distinct()

df <- df |>
  left_join(mapping_s, by = "mesoreg_id") |>
  data_format() |>
  mutate(year = "2010", entity_level = "Mesoregion")

census_geo <- full_join(df, geo, by = c("uf_code", "mesoreg_id"))

param_cols <- setdiff(columns_to_add, colnames(census_geo))
if(length(param_cols) > 0) {
  census_geo[, param_cols] <- NA
}

dir.create("01_data/02_proc/04_census_geo/mesoreg/All", recursive = TRUE, showWarnings = FALSE)
st_write(census_geo, "01_data/02_proc/04_census_geo/mesoreg/All/census_geo.geojson")
                       
reg_codes <- unique(census_geo$reg_code)
# Create directory for each region
  for (reg_i_code in reg_codes) {
    census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
    dir_path <- file.path("./01_data/02_proc/04_census_geo/mesoreg/", reg_i_code)
    dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
    file_path <- file.path(dir_path, "census_geo.geojson")
                         st_write(census_geo_i, file_path, delete_dsn = TRUE, append=FALSE)
                       }
# microreg ----------------------------------------------------------------
# Load and format indicator data for microregions
df <- fread("01_data/02_proc/02_indicators/microreg.csv") |>
  data_format() |>  # Apply custom data formatting
  mutate(
    mesoreg_code = str_pad(mesoreg_code, width = 2, pad = "0"),  # Pad mesoreg_code to 2 digits
    microreg_code = str_pad(microreg_code, width = 3, pad = "0"),  # Pad microreg_code to 3 digits
    microreg_id = paste0(uf_code, microreg_code),  # Create microreg_id by concatenating uf_code and microreg_code
    year = "2010",  # Add year column
    entity_level = "Microregion"  # Add entity level column
  )

# Read and format geographic boundaries for microregions
geo <- st_read("01_data/01_raw/boundaries/microreg.geojson") |>
  data_format()  # Apply custom data formatting

# Select relevant columns from mapping and remove duplicates
mapping_s <- mapping |>
  select(reg_name, mesoreg_id, microreg_id) |>
  distinct()  # Remove duplicated rows

# Merge the formatted indicator data with the selected mapping data
df <- df |>
  left_join(mapping_s, by = "microreg_id") |>
  data_format()  # Apply additional data formatting

# Perform a full join of the indicator data and geographic boundaries by UF code and microregion ID
census_geo <- full_join(df, geo, by = c("uf_code", "microreg_id"))
param_cols <- setdiff(columns_to_add, colnames(census_geo))
if(length(param_cols) > 0) {
  # Generate missing columns
  census_geo[, param_cols] <- NA
}

dir.create("01_data/02_proc/04_census_geo/microreg/All", recursive = TRUE, showWarnings = FALSE)
st_write(census_geo, "01_data/02_proc/04_census_geo/microreg/All/census_geo.geojson")

reg_codes <- unique(census_geo$reg_code)
# Create directory for each department
for (reg_i_code in reg_codes) {
  census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
  dir_path <- file.path("./01_data/02_proc/04_census_geo/microreg/", reg_i_code)
  dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
  file_path <- file.path(dir_path, "census_geo.geojson")
  st_write(census_geo_i, file_path, delete_dsn = TRUE, append=FALSE)
}

# mun ---------------------------------------------------------------------
# Load and format indicator data for municipalities
df <- fread("01_data/02_proc/02_indicators/mun.csv") |>
  data_format() |>  # Apply custom data formatting
  mutate(
    mun_code = str_pad(mun_code, width = 5, pad = "0"),  # Pad mun_code to 5 digits
    mun_id = paste0(uf_code, mun_code),  # Create mun_id by concatenating uf_code and mun_code
    year = "2010",  # Add year column
    entity_level = "Municipality"  # Add entity level column
  ) |>
  select(-reg_code, -uf_code, -mesoreg_code, -microreg_code, -metro_code, -mun_code)  # Drop unnecessary columns

# Read and format geographic boundaries for municipalities
geo <- st_read("01_data/01_raw/boundaries/mun.geojson") |>
  data_format()  # Apply custom data formatting

# Merge the formatted indicator data with the mapping data
df <- df |>
  left_join(mapping, by = "mun_id") |>
  data_format()  # Apply additional data formatting

# Perform a full join of the indicator data and geographic boundaries by UF code and municipality ID
census_geo <- full_join(df, geo, by = c("uf_code", "mun_id"))

param_cols <- setdiff(columns_to_add, colnames(census_geo))
if(length(param_cols) > 0) {
  # Generate missing columns
  census_geo[, param_cols] <- NA
}

# Create directories for storing processed data
dir.create("01_data/02_proc/04_census_geo/mun/All", recursive = TRUE, showWarnings = FALSE)

st_write(census_geo, "01_data/02_proc/04_census_geo/mun/All/census_geo.geojson")

reg_codes <- unique(census_geo$reg_code)
# Create directory for each department
for (reg_i_code in reg_codes) {
  census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
  dir_path <- file.path("./01_data/02_proc/04_census_geo/mun/", reg_i_code)
  dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
  file_path <- file.path(dir_path, "census_geo.geojson")
  st_write(census_geo_i, file_path, delete_dsn = TRUE, append=FALSE)
}
# wa ---------------------------------------------------------------------
# Load and format weighting area indicator data, removing unnecessary columns
df <- fread("01_data/02_proc/02_indicators/wa.csv") |>
  data_format() |>
  select(-metro_code, -metro_name, -uf_code, -mun_code, -reg_code, -mesoreg_code, -microreg_code)

# Merge the formatted indicator data with the mapping data by 'mun_id'
df <- full_join(mapping, df, by = "mun_id") |>
  mutate(
    year = "2010",  # Add year column
    entity_level = "Weighting Area"  # Add entity level column
  )

# Read and format geographic boundaries for weighting areas
geo <- st_read("01_data/01_raw/boundaries/wa.geojson") |>
  data_format() |>
  select(code_weighting, geometry) |> 
  rename(wa_id = code_weighting)

# Perform a full join of the indicator data and geographic boundaries by 'wa_id'
census_geo <- full_join(df, geo, by = "wa_id")
param_cols <- setdiff(columns_to_add, colnames(census_geo))
if(length(param_cols) > 0) {
  # Generate missing columns
  census_geo[, param_cols] <- NA
}

dir.create("01_data/02_proc/04_census_geo/wa/All", recursive = TRUE, showWarnings = FALSE)
st_write(census_geo, "01_data/02_proc/04_census_geo/wa/All/census_geo.geojson")

reg_codes <- unique(census_geo$reg_code)
# Create directory for each department
for (reg_i_code in reg_codes) {
  census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
  dir_path <- file.path("./01_data/02_proc/04_census_geo/wa/", reg_i_code)
  dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
  file_path <- file.path(dir_path, "census_geo.geojson")
  st_write(census_geo_i, file_path, delete_dsn = TRUE, append=FALSE)
}
# ct ----------------------------------------------------------------------
# Load and process the census tract indicator data
df <- fread("01_data/02_proc/02_indicators/ct.csv") |>
  mutate(
    year = "2010",                        # Add year column
    entity_level = "Census tract"         # Add entity level column
  ) |> 
  data_format()

# Load and process the geographic boundaries for census tracts
geo <- st_read("01_data/01_raw/boundaries/tract.geojson") |>
  data_format()

# Merge the indicator data and geographic boundaries by 'tract_id'
census_geo <- full_join(df, geo, by = "tract_id") |>
  data_format()  # Apply final formatting

census_geo <- full_join(mapping, census_geo, by = "mun_id") 
names(census_geo)
param_cols <- setdiff(columns_to_add, colnames(census_geo))
if(length(param_cols) > 0) {
  census_geo[, param_cols] <- NA
}

dir.create("01_data/02_proc/04_census_geo/ct/All",  recursive = TRUE, showWarnings = FALSE)
st_write(census_geo, "01_data/02_proc/04_census_geo/ct/All/census_geo.geojson")

reg_codes <- unique(census_geo$reg_code)
# Create directory for each department
for (reg_i_code in reg_codes) {
  census_geo_i <- census_geo |>
    filter(reg_code == reg_i_code)
  dir_path <- file.path("./01_data/02_proc/04_census_geo/ct/", reg_i_code)
  dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)
  file_path <- file.path(dir_path, "census_geo.geojson")
  st_write(census_geo_i, file_path, delete_dsn = TRUE, append=FALSE)
}