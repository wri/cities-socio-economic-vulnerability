library(shiny)
library(tidyr)
library(tidyverse)
library(dplyr)
library(readr)
library(vroom)
library(data.table)
library(leaflet)
library(leaflet.extras)
library(sf)
library(DT)
library(aws.s3)


s3_path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/"

env = "dev" 
year = "2011" 
country = "india" 

# geographical level names ----

geo_levels_names_ind = data.table::fread(paste(s3_path, "data/",env,"/","india","/boundaries/","2011","/geo_levels_names_v2.csv",sep = ""),
                                         sep = ",",
                                         header = TRUE,
                                         colClasses = c('state_name'='character',
                                                        'state_id'='character',
                                                        'district_name'='character',
                                                        'district_id'='character',
                                                        'sub_district_name'='character',
                                                        'sub_district_id'='character'))

geo_levels_names_ind = as.data.frame(geo_levels_names_ind)


# india dev
census_variables_definition_ind_dev = read.csv(paste(s3_path, "data/", env, "/","india_2","/census/2011/census_variables_definition.csv",sep = ""))
census_variables_group_ind_dev = unique(census_variables_definition_ind_dev$variable_category)


##############################################
################## state level #################
##############################################

census_geo_ind_state_raw = read_sf(paste(s3_path,
                                     "data/raw/india/GeoCensus_State.geojson",
                                     sep = ""))


census_geo_ind_state = census_geo_ind_state_raw %>% 
  rename("state_id" = "statecode",
         "district_id" = "districtco",
         "sub_district_id" = "tehsilcode",
         "townvill_id" = "townvillco",
         "state_name" = "name") %>% 
  add_column(entity_level = "state")

census_geo_ind_state$state_id = str_pad(census_geo_ind_state$state_id, width=2, pad="0")

census_geo_ind_state = st_zm(census_geo_ind_state)

# upload processed data in aws ----
state_codes = unique(geo_levels_names_ind$state_id)

# create directory 
dir.create("./data/dev/india/census_geo/2011/state")


# generate census_geo files

for(i in 1:length(state_codes)){
  
  state_i_code = state_codes[i]
  print(state_i_code)
  
  # filter state
  census_state_geo_state = census_geo_ind_state %>% 
    filter(state_id == state_i_code)
  
  # create dir
  dir_path = paste("./data/dev/india/census_geo/2011/state/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_state_geo_2011.geojson",
                    sep = "/")
  st_write(census_state_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/india/census_geo/2011/state/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

# create census geo with all states ----

# create dir
dir_path = paste("./data/dev/india/census_geo/2011/state/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_state_geo_2011.geojson",
                  sep = "/")
st_write(census_geo_ind_state,
         file_path,
         delete_dsn = TRUE)

# upload to s3
object_path = paste("data/dev/india/census_geo/2011/state/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


##############################################
################## district level #################
##############################################

census_geo_ind_district_raw = read_sf(paste(s3_path,
                                         "data/raw/india/GeoCensus_District.geojson",
                                         sep = ""))


census_geo_ind_district = census_geo_ind_district_raw %>% 
  rename("state_id" = "statecode",
         "district_id" = "districtco",
         "sub_district_id" = "tehsilcode",
         "townvill_id" = "townvillco",
         "state_name" = "state",
         "district_name" = "name") %>% 
  add_column(entity_level = "district")

census_geo_ind_district$state_id = str_pad(census_geo_ind_district$state_id, width=2, pad="0")

census_geo_ind_district = st_zm(census_geo_ind_district)

# upload processed data in aws ----
state_codes = unique(geo_levels_names_ind$state_id)

# create directory 
dir.create("./data/dev/india/census_geo/2011/district")


# generate census_geo files

for(i in 1:length(state_codes)){
  
  state_i_code = state_codes[i]
  print(state_i_code)
  
  # filter state
  census_district_geo_state = census_geo_ind_district %>% 
    filter(state_id == state_i_code)
  
  # create dir
  dir_path = paste("./data/dev/india/census_geo/2011/district/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_district_geo_2011.geojson",
                    sep = "/")
  st_write(census_district_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/india/census_geo/2011/district/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

# create census geo with all states ----

# create dir
dir_path = paste("./data/dev/india/census_geo/2011/district/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_district_geo_2011.geojson",
                  sep = "/")
st_write(census_geo_ind_district,
         file_path,
         delete_dsn = TRUE)

# upload to s3
object_path = paste("data/dev/india/census_geo/2011/district/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


##############################################
################## sub-district level #################
##############################################

census_geo_ind_subdistrict_raw = read_sf(paste(s3_path,
                                            "data/raw/india/GeoCensus_SubDistrict.geojson",
                                            sep = ""))


census_geo_ind_subdistrict = census_geo_ind_subdistrict_raw %>% 
  rename("state_id" = "statecode",
         "district_id" = "districtco",
         "sub_district_id" = "tehsilcode",
         "townvill_id" = "townvillco",
         "state_name" = "state",
         "district_name" = "district",
         "sub-district_name" = "name") %>% 
  add_column(entity_level = "sub-district")

census_geo_ind_subdistrict$state_id = str_pad(census_geo_ind_subdistrict$state_id, width=2, pad="0")

census_geo_ind_subdistrict = st_zm(census_geo_ind_subdistrict)

# upload processed data in aws ----
state_codes = unique(geo_levels_names_ind$state_id)

# create directory 
dir.create("./data/dev/india/census_geo/2011/sub-district")


# generate census_geo files

for(i in 1:length(state_codes)){
  
  state_i_code = state_codes[i]
  print(state_i_code)
  
  # filter state
  census_subdistrict_geo_state = census_geo_ind_subdistrict %>% 
    filter(state_id == state_i_code)
  
  # create dir
  dir_path = paste("./data/dev/india/census_geo/2011/sub-district/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_subdistrict_geo_2011.geojson",
                    sep = "/")
  st_write(census_subdistrict_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/india/census_geo/2011/sub-district/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

# create census geo with all states ----

# create dir
dir_path = paste("./data/dev/india/census_geo/2011/sub-district/",
                 "All",
                 sep = "")
dir.create(dir_path)

# store locally
file_path = paste(dir_path,
                  "census_subdistrict_geo_2011.geojson",
                  sep = "/")
st_write(census_geo_ind_subdistrict,
         file_path,
         delete_dsn = TRUE)

# upload to s3
object_path = paste("data/dev/india/census_geo/2011/sub-district/",
                    "All",
                    "/",
                    "census_geo.geojson",
                    sep = "")
put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

##############################################
################## ward level #################
##############################################

# process census-geo indian data ward ----

census_geo_india_raw = read_sf(paste(s3_path,
                                 "data/raw/india/GeoCensus_Agra.geojson",
                                 sep = ""))

boundary_without_z = st_zm(boundary)

census_geo_india_ward = census_geo_india_raw %>% 
  rename("state_id" = "statecode",
         "district_id" = "districtco",
         "tehsil_id" = "tehsilcode",
         "ward_id" = "ward_no",
         "state_name" = "state",
         "district_name" = "district",
         "tehsil_name" = "tehsil",
         "ward_name" = "name",
         "entity_level" = "level")


# upload processed data in aws ----
state_codes = unique(census_geo_india$state_id)

# create directory 
dir.create("./data/dev/india/census_geo/2011/ward")

# generate census_geo files

for(i in 1:length(state_codes)){
  
  state_i_code = state_codes[i]
  print(state_i_code)
  
  # filter state
  census_ward_geo_state = census_geo_india_ward %>% 
    filter(state_id == state_i)
  
  # create dir
  dir_path = paste("./data/dev/india/census_geo/2011/ward/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_ward_geo_2011.geojson",
                    sep = "/")
  st_write(census_ward_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/india/census_geo/2011/ward/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

# generate geo_levels_names file ----

geo_levels_names =census_geo_india_ward %>% 
  as.data.frame() %>% 
  select(-geometry) %>% 
  dplyr::select(state_name,
                state_id, 
                district_name,
                district_id,
                ward_name,
                ward_id)

# store output local 

write.csv(geo_levels_names,
          paste("./data/",env,"/",country,"/boundaries/",year,"/geo_levels_names.csv", sep =""))


# upload to s3 

dir_path = getwd()

file_path = paste(dir_path,
                  paste("/data/",env,"/",country,"/boundaries/",year,"/geo_levels_names.csv", sep =""),
                  sep = "")

object_path = paste("data/",env,"/",country,"/boundaries/",year,"/geo_levels_names.csv",sep = "")

put_object(file = file_path, 
           object = object_path, 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)


#################################################################
## app test -------------

# India
geo_levels_names_ind = data.table::fread(paste(s3_path, "data/",env,"/","india","/boundaries/","2011","/geo_levels_names.csv",sep = ""),
                                         sep = ",",
                                         header = TRUE,
                                         colClasses = c('state_name'='character',
                                                        'state_id'='character',
                                                        'district_name'='character',
                                                        'district_id'='character',
                                                        'ward_name'='character',
                                                        'ward_id'='character'))

geo_levels_names_ind = as.data.frame(geo_levels_names_ind)

# get selected level ----

selected_level = "district"
env = "dev"
country = "india_2"
year = "2011"
state_code = "All"

# get selected state ----

states =unique(geo_levels_names$state_name)

selected_state = states[1]
selected_state

# get selected state code ----
state_code = geo_levels_names %>% 
  filter(state_name == selected_state) %>% 
  distinct(state_id) %>% 
  as.character()
print(state_code)

# read data ----

data_path = paste(s3_path,
                  "data/",env,"/",country,"/census_geo/",year,"/",
                  selected_level,
                  "/",
                  state_code,
                  "/census_geo.geojson",
                  sep = "")

census_geo = st_read(data_path)

# select census variable ----

selected_variable_viz = census_variables_definition_ind_dev$variable_name_processed_viz[1]
selected_variable_viz

selected_variable = census_variables_definition_ind_dev %>% 
  filter(variable_name_processed_viz %in% selected_variable_viz) %>% 
  pull(variable_name_processed)
selected_variable

# filter data  ----

data_filtered = census_geo %>% 
  select("entity_level","state_name","district_name", selected_variable)

geo_name = data_filtered$ward_name

# table ----

data_filtered_table = data_filtered %>% 
  as.data.frame() %>% 
  mutate(across(c(selected_variable), na_if, "")) %>% 
  drop_na(selected_variable) %>% 
  select(-geometry)

# plot table -----

DT::datatable(
  data_filtered_table,
  filter = 'top',
  options = list(paging = TRUE,    
                 pageLength = 10,  
                 scrollX = TRUE,   
                 scrollY = TRUE,   
                 autoWidth = TRUE, 
                 server = FALSE)
)

# map ----


# get selected census variable value

selected_variable_map = selected_variable[1]

census_variable_values = data_filtered %>% 
  as.data.frame() %>% 
  pull(selected_variable_map)

# define pal
pal_census<- colorNumeric("RdYlBu", 
                          census_variable_values,
                          na.color = "transparent",
                          reverse = TRUE)


# define labels information
labels_cesus <- sprintf("<strong>%s</strong> %s <br/><strong>%s:</strong> %s <br/><strong>%s:</strong> %s<br/><strong>%s:</strong> %s",
                        "State",selected_state, 
                        "Census variable", selected_variable_map,
                        "Value", census_variable_values,
                        "Name", geo_name) %>% 
  lapply(htmltools::HTML)


# map plot

leaflet(data_filtered, height = 700, width = "100%")  %>%
  addTiles() %>%
  addProviderTiles(providers$OpenStreetMap, group = "OSM") %>%
  addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # polygons ----
addPolygons(data = data_filtered,
            group = "census-var",
            fillColor = ~pal_census(census_variable_values),
            weight = 0.1,
            opacity = 1,
            color = "grey",
            fillOpacity = 0.9,
            label = labels_cesus,
            highlightOptions = highlightOptions(color = "black", weight = 2,
                                                bringToFront = FALSE),
            labelOptions = labelOptions(
              style = list("font-weight" = "normal", padding = "3px 6px"),
              textsize = "15px",
              direction = "auto")) %>%
  # legend ----
addLegend(pal = pal_census,
          values = census_variable_values,
          opacity = 0.9,
          # title = input$variable,
          title = selected_variable_map,
          group = "census-var",
          position = "topright",
          labFormat = labelFormat(suffix = "")) %>%
  # Layers control ----
addLayersControl(
  overlayGroups = c("census-var"),
  baseGroups = c("OSM","Toner Lite", "CartoDB"),
  options = layersControlOptions(collapsed = FALSE)
) %>% 
  #hideGroup(c("Administrative boundaries")) %>% 
  addFullscreenControl()
