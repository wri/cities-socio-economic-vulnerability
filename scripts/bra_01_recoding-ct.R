# set up ------------------------------------------------------------------
rm(list=ls())

library(data.table)
library(dplyr)
library(readxl)

# domicilio01 -------------------------------------------------------------

# Set the directory path
directory_path <- "01_data/01_raw/sc/01_xls_topic/Domicilio01"

# Get a list of XLS files in the directory
file_list <- list.files(directory_path, pattern = "\\.xls$", full.names = TRUE)

# Initialize an empty list to store data frames
data_list <- list()

# Loop through the list of files and read them into data frames
for (file in file_list) {
  data <- read_excel(file)
  data_list[[file]] <- data
}

# Combine all data frames into one
domicilio01 <- do.call(rbind, data_list)

domicilio01 <- domicilio01 %>%
  mutate_at(vars(-Cod_setor, -Situacao_setor), as.numeric)

domicilio01 <- domicilio01 %>% mutate(
                                      tract_id = Cod_setor,
                                      d_dwg=V002,
                                      d_own = V006 + V007,
                                      d_prop_own = (V006 + V007) / V002 * 100,
                                      d_rented=V008,
                                      d_prop_rented=V008/V002*100,
                                      d_loaned=V009 + V010,
                                      d_prop_loaned=(V009 + V010)/V002*100,
                                      d_other=V011,
                                      d_prop_other=V011/V002*100,
                                      d_water_network=V012,
                                      d_prop_water_network=V012/V002*100,
                                      d_water_well_in=V013,
                                      d_prop_water_well_in=V013/V002*100,
                                      d_water_rain=V014,
                                      d_prop_water_rain=V014/V002*100,
                                      d_water_other=V015,
                                      d_prop_water_other=V015/V002*100,
                                      d_toil=V016,
                                      d_prop_toil=V016/V002*100,
                                      d_ss_network=V017,
                                      d_prop_ss_network=V017/V002*100,
                                      d_ss_pit=V018+V019,
                                      d_prop_ss_pit=(V018+V019)/V002*100,
                                      d_ss_ditch=V020,
                                      d_prop_ss_ditch=V020/V002*100,
                                      d_ss_river=V021,
                                      d_prop_ss_river=V021/V002*100,
                                      d_ss_other=V022,
                                      d_prop_ss_other=V022/V002*100,
                                      d_ntoil=V023,
                                      d_prop_ntoil=V023/V002*100,
                                      d_toil=V024,
                                      d_prop_toil=V024/V002*100,
                                      d_ntoil=V034,
                                      d_prop_ntoil=V034/V002*100,
                                      d_garbage=V035,
                                      d_prop_garbage=V035/V002*100,
                                      d_garbage_clngsvcs1=V036,
                                      d_prop_garbage_clngsvcs1=V036/V002*100,
                                      d_garbage_clngsvcs2=V037,
                                      d_prop_garbage_clngsvcs2=V037/V002*100,
                                      d_garbage_burnt=V038,
                                      d_prop_garbage_burnt=V038/V002*100,
                                      d_garbage_buried=V039,
                                      d_prop_garbage_buried=V039/V002*100,
                                      d_garbage_throwed1=V040,
                                      d_prop_garbage_throwed1=V040/V002*100,
                                      d_garbage_throwed2=V041,
                                      d_prop_garbage_throwed2=V041/V002*100,
                                      d_garbage_other=V042,
                                      d_prop_garbage_other=V042/V002*100,
                                      d_elect=V043,
                                      d_prop_elect=V043/V002*100,
                                      d_elect1=V044,
                                      d_elect2=V045,
                                      d_nelect=V046,
                                      d_1occup=V050,
                                      d_2occup=V051,
                                      d_3occup=V052,
                                      d_4occup=V053,
                                      d_5occup=V054,
                                      d_6occup=V055,
                                      d_7occup=V056,
                                      d_8occup=V057,
                                      d_9occup=V058,
                                      d_10moccup=V059,
                                      d_mh_2occup=V062,
                                      d_mh_3occup=V063,
                                      d_mh_4occup=V064,
                                      d_mh_5occup=V065,
                                      d_mh_6occup=V066,
                                      d_mh_7moccup=V067,
                                      d_mh_1occup=V068,
                                      d_fh_2occup=V081,
                                      d_fh_3occup=V082,
                                      d_fh_4occup=V083,
                                      d_fh_5occup=V084,
                                      d_fh_6occup=V085,
                                      d_fh_7moccup=V086,
                                      d_fh_1occup=V087)
names(domicilio01)
domicilio01 <- select(domicilio01,
                      244:319)
# pessoa03 ----------------------------------------------------------------
# Set the directory path
directory_path <- "01_data/01_raw/sc/01_xls_topic/Pessoa03"

# Get a list of XLS files in the directory
file_list <- list.files(directory_path, pattern = "\\.xls$", full.names = TRUE)

# Initialize an empty list to store data frames
data_list <- list()

# Loop through the list of files and read them into data frames
for (file in file_list) {
  data <- read_excel(file)
  data_list[[file]] <- data
}

# Combine all data frames into one
pessoa03 <- do.call(rbind, data_list)
pessoa03 <- pessoa03 %>%
  mutate_at(vars(-Cod_setor, -Situacao_setor), as.numeric)

pessoa03 <- pessoa03 %>%  mutate(
  tract_id = Cod_setor,
  p_tot=V001,
  p_wht=V002,
  p_prop_wht=V002/V001 * 100,
  p_black=V003,
  p_prop_black=V003/V001 * 100,
  p_yellow=V004,
  p_prop_yellow=V004/V001 * 100,
  p_brown=V005,
  p_prop_brown=V005/V001 * 100,
  p_indig=V006,
  p_prop_indig=V006/V001 * 100,
  p_0to4wh=V007,
  p_0to4bl=V008,
  p_0to4ye=V009,
  p_0to4br=V010,
  p_0to4in=V011,
  p_0to4=V007 + V008 + V009 + V010 + V011,
  p_5to9wh=V012,
  p_5to9bl=V013,
  p_5to9ye=V014,
  p_5to9br=V015,
  p_5to9in=V016,
  p_5to9=V012 + V013 + V014 + V015 + V016,
  p_10to14wh=V017,
  p_10to14bl=V018,
  p_10to14ye=V019,
  p_10to14br=V020,
  p_10to14in=V021,
  p_10to14=V017 + V018 + V019 + V020 + V021,
  p_15to19wh=V022,
  p_15to19bl=V023,
  p_15to19ye=V024,
  p_15to19br=V025,
  p_15to19in=V026,
  p_15to19=V022 + V023 + V024 + V025 +V026,
  p_15to17wh=V027,
  p_15to17bl=V028,
  p_15to17ye=V029,
  p_15to17br=V030,
  p_15to17in=V031,
  p_15to17=V027 + V028 + V029 + V030 + V031,
  p_18or19wh=V032,
  p_18or19bl=V033,
  p_18or19ye=V034,
  p_18or19br=V035,
  p_18or19in=V036,
  p_18or19=V032 + V033 + V034 + V035 + V036,
  p_20to24wh=V037,
  p_20to24bl=V038,
  p_20to24ye=V039,
  p_20to24br=V040,
  p_20to24in=V041,
  p_20to24=V037 + V038 + V039 + V040 + V041,
  p_25to29wh=V042,
  p_25to29bl=V043,
  p_25to29ye=V044,
  p_25to29br=V045,
  p_25to29in=V046,
  p_25to29=V042 + V043 + V044 + V045 + V046,
  p_30to34wh=V047,
  p_30to34bl=V048,
  p_30to34ye=V049,
  p_30to34br=V050,
  p_30to34in=V051,
  p_30to34=V047 + V048 + V049 + V050 + V051,
  p_35to39wh=V052,
  p_35to39bl=V053,
  p_35to39ye=V054,
  p_35to39br=V055,
  p_35to39in=V056,
  p_35to39=V052 + V053 + V054 + V055 + V056,
  p_40to44wh=V057,
  p_40to44bl=V058,
  p_40to44ye=V059,
  p_40to44br=V060,
  p_40to44in=V061,
  p_40to44=V057 + V058 + V059 + V060 + V061,
  p_45to49wh=V062,
  p_45to49bl=V063,
  p_45to49ye=V064,
  p_45to49br=V065,
  p_45to49in=V066,
  p_45to49=V062 + V063 + V064 + V065 + V066,
  p_50to54wh=V067,
  p_50to54bl=V068,
  p_50to54ye=V069,
  p_50to54br=V070,
  p_50to54in=V071,
  p_50to54=V067 + V068 + V069 + V070 + V071,
  p_55to59wh=V072,
  p_55to59bl=V073,
  p_55to59ye=V074,
  p_55to59br=V075,
  p_55to59in=V076,
  p_55to59=V072 + V073 + V074 + V075 + V076,
  p_60to69wh=V077,
  p_60to69bl=V078,
  p_60to69ye=V079,
  p_60to69br=V080,
  p_60to69in=V081,
  p_60to69=V077 + V078 + V079 + V080 + V081,
  p_70mwh=V082,
  p_70mbl=V083,
  p_70mye=V084,
  p_70mbr=V085,
  p_70min=V086,
  p_70m=V082 + V083 + V084 + V085 + V086,
  p_5or6wh_m=V087,
  p_5or6bl_m=V088,
  p_5or6ye_m=V089,
  p_5or6br_m=V090,
  p_5or6in_m=V091,
  p_5or6=V087 + V088 + V089 + V090 + V091,
  p_7to9wh_m=V092,
  p_7to9bl_m=V093,
  p_7to9ye_m=V094,
  p_7to9br_m=V095,
  p_7to9in_m=V096,
  p_7to9_m=V092 + V093 + V094 + V095 + V096,
  p_10to14wh_m=V097,
  p_10to14bl_m=V098,
  p_10to14ye_m=V099,
  p_10to14br_m=V100,
  p_10to14in_m=V101,
  p_10to14_m=V097 + V098 + V099 + V100 +  V101,
  p_15to19wh_m=V102,
  p_15to19bl_m=V103,
  p_15to19ye_m=V104,
  p_15to19br_m=V105,
  p_15to19in_m=V106,
  p_15to19_m=V102 + V103 + V104 + V105 + V106,
  p_15to17wh_m=V107,
  p_15to17bl_m=V108,
  p_15to17ye_m=V109,
  p_15to17br_m=V110,
  p_15to17in_m=V111,
  p_15to17_m=V107 + V108 + V109 + V110 + V111,
  p_18or19wh_m=V112,
  p_18or19bl_m=V113,
  p_18or19ye_m=V114,
  p_18or19br_m=V115,
  p_18or19in_m=V116,
  p_18or19_m=V112 + V113 + V114 + V115 + V116,
  p_20to24wh_m=V117,
  p_20to24bl_m=V118,
  p_20to24ye_m=V119,
  p_20to24br_m=V120,
  p_20to24in_m=V121,
  p_20to24_m=V117 + V118 + V119 + V120 + V121,
  p_25to29wh_m=V122,
  p_25to29bl_m=V123,
  p_25to29ye_m=V124,
  p_25to29br_m=V125,
  p_25to29in_m=V126,
  p_25to29_m=V122 + V123 + V124 + V125 + V126,
  p_30to34wh_m=V127,
  p_30to34bl_m=V128,
  p_30to34ye_m=V129,
  p_30to34br_m=V130,
  p_30to34in_m=V131,
  p_30to34_m=V127 + V128 + V129 + V130 + V131,
  p_35to39wh_m=V132,
  p_35to39bl_m=V133,
  p_35to39ye_m=V134,
  p_35to39br_m=V135,
  p_35to39in_m=V136,
  p_35to39_m=V132 + V133 + V134 + V135 + V136,
  p_40to44wh_m=V137,
  p_40to44bl_m=V138,
  p_40to44ye_m=V139,
  p_40to44br_m=V140,
  p_40to44in_m=V141,
  p_40to44_m=V137 + V138 + V139 + V140 + V141,
  p_45to49wh_m=V142,
  p_45to49bl_m=V143,
  p_45to49ye_m=V144,
  p_45to49br_m=V145,
  p_45to49in_m=V146,
  p_45to49_m=V142 + V143 + V144 + V145 + V146 ,
  p_50to54wh_m=V147,
  p_50to54bl_m=V148,
  p_50to54ye_m=V149,
  p_50to54br_m=V150,
  p_50to54in_m=V151,
  p_50to54_m=V147 + V148 + V149 + V150 + V151 ,
  p_55to59wh_m=V152,
  p_55to59bl_m=V153,
  p_55to59ye_m=V154,
  p_55to59br_m=V155,
  p_55to59in_m=V156,
  p_55to59_m=V152 + V153 + V154 + V155 + V156,
  p_60to69wh_m=V157,
  p_60to69bl_m=V158,
  p_60to69ye_m=V159,
  p_60to69br_m=V160,
  p_60to69in_m=V161,
  p_60to69_m=V157 + V158 + V159 + V160 + V161,
  p_70mwh_m=V162,
  p_70mbl_m=V163,
  p_70mye_m=V164,
  p_70mbr_m=V165,
  p_70min_m=V166,
  p_70m_m=V162 + V163 + V164 + V165 + V166,
  p_5or6wh_f=V167,
  p_5or6bl_f=V168,
  p_5or6ye_f=V169,
  p_5or6br_f=V170,
  p_5or6in_f=V171,
  p_5or6_f=V167 + V168 + V169 + V170 + V171 ,
  p_7to9wh_f=V172,
  p_7to9bl_f=V173,
  p_7to9ye_f=V174,
  p_7to9br_f=V175,
  p_7to9in_f=V176,
  p_7to9_f=V172 +V173 + V174 + V175 + V176,
  p_10to14wh_f=V177,
  p_10to14bl_f=V178,
  p_10to14ye_f=V179,
  p_10to14br_f=V180,
  p_10to14in_f=V181,
  p_10to14_f=V177 + V178 + V178 + V179 + V180 + V181,
  p_15to19wh_f=V182,
  p_15to19bl_f=V183,
  p_15to19ye_f=V184,
  p_15to19br_f=V185,
  p_15to19in_f=V186,
  p_15to19_f=V182 + V183 + V184 + V185 + V186,
  p_15to17wh_f=V187,
  p_15to17bl_f=V188,
  p_15to17ye_f=V189,
  p_15to17br_f=V190,
  p_15to17in_f=V191,
  p_15to17_f=V187 + V188 + V189 + V190 + V191,
  p_18or19wh_f=V192,
  p_18or19bl_f=V193,
  p_18or19ye_f=V194,
  p_18or19br_f=V195,
  p_18or19in_f=V196,
  p_18or19_f=V192 + V193 + V194 + V195 + V196,
  p_20to24wh_f=V197,
  p_20to24bl_f=V198,
  p_20to24ye_f=V199,
  p_20to24br_f=V200,
  p_20to24in_f=V201,
  p_20to24_f=V197 + V198 + V199 + V200 + V201,
  p_25to29wh_f=V202,
  p_25to29bl_f=V203,
  p_25to29ye_f=V204,
  p_25to29br_f=V205,
  p_25to29in_f=V206,
  p_25to29_f=V202 + V203 + V204 + V205 + V206,
  p_30to34wh_f=V207,
  p_30to34bl_f=V208,
  p_30to34ye_f=V209,
  p_30to34br_f=V210,
  p_30to34in_f=V211,
  p_30to34_f=V207 + V208 + V209 + V210 + V211,
  p_35to39wh_f=V212,
  p_35to39bl_f=V213,
  p_35to39ye_f=V214,
  p_35to39br_f=V215,
  p_35to39in_f=V216,
  p_35to39_f=V212 + V213 + V214 + V215 + V216,
  p_40to44wh_f=V217,
  p_40to44bl_f=V218,
  p_40to44ye_f=V219,
  p_40to44br_f=V220,
  p_40to44in_f=V221,
  p_40to44_f=V217 + V218 + V219 + V220 + V221,
  p_45to49wh_f=V222,
  p_45to49bl_f=V223,
  p_45to49ye_f=V224,
  p_45to49br_f=V225,
  p_45to49in_f=V226,
  p_45to49_f=V222 + V223 + V224 + V225 + V226,
  p_50to54wh_f=V227,
  p_50to54bl_f=V228,
  p_50to54ye_f=V229,
  p_50to54br_f=V230,
  p_50to54in_f=V231,
  p_50to54_f=V227 + V228 + V229 + V230 + V231,
  p_55to59wh_f=V232,
  p_55to59bl_f=V233,
  p_55to59ye_f=V234,
  p_55to59br_f=V235,
  p_55to59in_f=V236,
  p_55to59_f=V232 + V233 + V234 + V235 + V236,
  p_60to69wh_f=V237,
  p_60to69bl_f=V238,
  p_60to69ye_f=V239,
  p_60to69br_f=V240,
  p_60to69in_f=V241,
  p_60to69_f=V237 + V238 + V239 + V240 + V241,
  p_70mwh_f=V242,
  p_70mbl_f=V243,
  p_70mye_f=V244,
  p_70mbr_f=V245,
  p_70min_f=V246,
  p_70m_f=V242 + V243 + V244 + V245 + V246 ,

  p_0to14=p_0to4   + p_5to9 + p_10to14,
  p_15to69=p_tot - p_0to14 - p_70m,
  p_prop_tdr=(p_0to14 + p_70m) / p_15to69 *100,
  p_prop_chddr=p_0to14  / p_15to69 *100,
  p_prop_olddr= p_70m / p_15to69 *100
  
)

pessoa03 <- select(pessoa03, 
                   254:558
                   )
#write_xlsx(pessoa03, "01_data/02_proc/pessoa03.xlsx")

df_1 <- full_join(pessoa03, domicilio01)


# basico ------------------------------------------------------------------

# Set the directory path
directory_path <- "01_data/01_raw/sc/01_xls_topic/Basico"

# Get a list of XLS files in the directory
file_list <- list.files(directory_path, pattern = "\\.xls$", full.names = TRUE)

# Initialize an empty list to store data frames
data_list <- list()

# Loop through the list of files and read them into data frames
for (file in file_list) {
  data <- read_excel(file)
  data_list[[file]] <- data
}

# Combine all data frames into one
basico <- do.call(rbind, data_list)


basico <- basico %>% mutate(
  tract_id = Cod_setor,
  #reg_code = `Cod_Grandes Regiões`,
  #reg_name = `Nome_Grande_Regiao`,
  #state_id= Cod_UF,
  #state_name=Nome_da_UF,
  #mesoreg_id = Cod_meso,
  #mesoreg_name = Nome_da_meso,
  #microreg_id = Cod_micro,
  #microreg_name = Nome_da_micro,
  #metrop_id = Cod_RM,
  #metrop_name = Nome_da_RM,
  #mun_id = Cod_municipio,
  #mun_name = Nome_do_municipio,
  #district_id = Cod_distrito,
  #district_name = Nome_do_distrito,
  #subdistrict_id = Cod_subdistrito,
  #subdistrict_name = Nome_do_subdistrito,
  #neighborhood_id = Cod_bairro,
  #neighborhood_name = Nome_do_bairro,
  #sector=Situacao_setor,
  #d_tot=V001,
  #p_tot=V002,
  d_mean_occup=V003,
  d_var_occup=V004,
  hh_mean_inc1=V005,
  hh_var_inc1=V006,
  hh_mean_inc2=V007,
  hh_var_inc2=V008,
  p_mean_inc1=V009,
  p_var_inc1=V010,
  p_mean_inc2=V011,
  p_var_inc2=V012
  )

basico <- select(basico, 
                   34:44)


df_2 <- full_join(basico, df_1)

fwrite(df_2, "01_data/02_proc/02_indicators/ct.csv")

# split by reg_code -----------------------------------------------------
dir.create("01_data/02_proc/02_indicators/sc")
output_dir <- "01_data/02_proc/02_indicators/sc"
# Split the dataframe by reg
df_list <- split(df_2, df_2$reg_code)

# Save each subset as a CSV file
for (code_reg_value in names(df_list)) {
  subset_df <- df_list[[code_reg_value]]
  file_path <- file.path(output_dir, paste0(code_reg_value, ".csv"))
  
  write.csv(subset_df, file_path, row.names = FALSE, fileEncoding = "latin1")
}

