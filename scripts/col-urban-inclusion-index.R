library(data.table) 
library(tidyverse)
library(stringi)


path = "https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/colombia_2/"

############### 03_PCA_city_seccurb


# read data


df0 <- fread(paste(path, "iisu_nat_seccurb.csv", sep = ""))

# urban inclusion index function
urban.inclusion.index = function(census_df){
  
  # get list of aglomerations
  aglomerations <- unique(df0$aglomeration)
  
  # creat empty df for storing urbaninclusion index
  census_df_urban_inclusion_index <- data.frame()
  
  # loop over aglomeration and calculate urbaninclusion index class
  for(i in 1:length(aglomerations)){
    
    aglomeration_i = aglomerations[i]
    
    df = df0  %>% 
      filter(aglomeration == aglomeration_i)
    
    pca_mun <- prcomp(select(df, 
                             d_prop_walls_artificial,
                             d_prop_gas, d_prop_gc, 
                             #d_prop_inet,d_prop_toil_swg,        
                             h_prop_novc,h_prop_kitchen, 
                             h_prop_heduc, 
                             p_prop_15to19as), scale.=T )
    
    print(pca_mun)
    summary(pca_mun)
    
    PC <- as.data.frame(pca_mun[2])
    PC1_s  <- nrow(PC[PC$rotation.PC1<0,])
    
    pred <- predict(pca_mun, newdata = df) 
    pred <- as.data.frame(pred)
    
    df$iisu_mun <- pred$PC1
    
    rescale_1 <- function(x) (x - min(x)) / (max(x) - min(x)) * 100 # para cargas positivas
    rescale_2 <- function(x) (x - max(x)) / (min(x) - max(x)) * 100 # para cargas negativas
    
    
    df$iisu_mun_norm <- if(PC1_s == 0){
      rescale_1(df$iisu_mun)} else{
        rescale_2(df$iisu_mun)} 
    
    # Strat ------------------------------------------------------------------
    df$iisu_mun_g <- cut(df$iisu_mun_norm, breaks = 5)
    
    df$iisu_mun_g <- factor(df$iisu_mun_g,
                            levels = c("(-0.1,20]", "(20,40]", "(40,60]", "(60,80]", "(80,100]"),
                            labels = c("Very low", "Low", "Medium", "High", "Very high")
    )
    
    df = select(df,
                dept_code, mun_code,mun_class, sect_rur_code,secc_rur_code, popcenter_code, sect_urb_code, secc_urb_code,  
                aglomeration, func, mun_id,  muncl_id , secc_urb_id, d_tot, p_tot,
                d_prop_walls_artificial,
                d_prop_gas, d_prop_gc, 
                #d_prop_inet,d_prop_toil_swg,        
                h_prop_novc,h_prop_kitchen, 
                h_prop_heduc, 
                p_prop_15to19as,
                iisu_nat,iisu_nat_norm,iisu_nat_g, 
                iisu_mun,iisu_mun_norm,iisu_mun_g
    )
    
    census_df_urban_inclusion_index <- rbind(census_df_urban_inclusion_index, df)
    
  }
  
  return(census_df_urban_inclusion_index)
  
}

# test
test = urban.inclusion.index(census_df = df0)