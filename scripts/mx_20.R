# set up ------------------------------------------------------------------
rm(list=ls())
# Libraries
library(tidyverse)
library(dplyr)
library(tidyr)
library(naniar)
library(pacman)
library(data.table)
library(readxl)
library(openxlsx)
library(sf)
library(aws.s3)
# aws keys
Sys.setenv(
  "AWS_ACCESS_KEY_ID" = "key_ID",
  "AWS_SECRET_ACCESS_KEY" = "sa_key",
  "AWS_DEFAULT_REGION" = "region")

# 1. data  --------------------------------------------------------------------
df_0 <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/census/2020/mx_20_raw.csv",
                        encoding = "Latin-1", header = TRUE) %>% rename_all(tolower)
  
df <- df_0 %>% 
  mutate(state_code = str_pad(entidad, 2, pad = '0'),
         municipality_code = str_pad(mun, 3, pad = '0'),
         locality_code = str_pad(loc, 4, pad = '0'),
         ageb_code = str_pad(ageb, 4, pad = '0'),
         block_code = str_pad(mza, 3, pad = '0'))

# keep just necessary vars
df <- df %>% 
  select(state_code, nom_ent, municipality_code, nom_mun, locality_code, nom_loc,
         ageb_code, block_code, 
         vivtot, vivparh_cv, vph_1cuart, vph_2cuart,
         vph_3ymasc, pro_ocup_c, vph_1dor, vph_2ymasd, vph_pisoti, vph_excsa,
         vph_drenaj, vph_aguadv, vph_c_elec, vph_ndeaed, vph_inter, vph_pc,
         vph_cel, vph_tv, vph_sintic, vph_autom,vph_moto, vph_bici,vph_ndacmm,
         vph_refri, vph_lavad, vph_snbien, pobtot, pobmas, pobfem, p_0a2,
         p_0a2_f, p_0a2_m, p_3a5, p_3a5_m, p_3a5_f, p_6a11, p_6a11_f, p_6a11_m,
         p_12a14, p_12a14_f, p_12a14_m, p_15a17, p_15a17_f, p_15a17_m,
         p_15ymas_f, p_15ymas_m, p_15ymas_f, p_18a24, p_18a24_f, p_18a24_m,
         p_60ymas, p_60ymas_f, p_60ymas_m, pob0_14, pob65_mas, pob15_64,
         prom_hnv, p_12ymas_f, pder_ss, p15ym_an, p15ym_an_f, p15ym_an_m,
         p6a11_noa, p6a11_noaf, p6a11_noam, p12a14noa, p12a14noaf, p12a14noam,
         p15a17a, p15a17a_f, p15a17a_m, p18a24a, p18a24a_f, p18a24a_m,
         graproes, p_15ymas, graproes_f, p_15ymas_f, graproes_m, p_15ymas_m,
         pocupada, pocupada_f, pocupada_m, pdesocup, pdesocup_f, pdesocup_m,
         pe_inac, pe_inac_f, pe_inac_m, tothog, hogjef_f, hogjef_m, p3ym_hli,
         p3ym_hli_f, p3ym_hli_m, pcon_disc, pcdisc_mot, pcdisc_vis)

# convert to numeric
df <- df %>% 
  dplyr::mutate(across(c(9:103),as.numeric))

# 2. Processing  ------------------------------------------
## National  ------------------------------------------
census_mexico_national_2020 <- filter(df,municipality_code =="000")
census_mexico_national_2020 <- census_mexico_national_2020 %>% 
  dplyr:: summarize(
    year = "2020",
    entity_level = "national",
    state_code = NA,
    state_name = NA,
    municipality_code = NA, 
    municipality_name = NA,
    municipality_id = NA,
    locality_code = NA, 
    locality_name = NA,
    locality_id = NA,
    ageb_code = NA,
    ageb_id = NA,
    block_code = NA, 
    block_id = NA,
    
    d_tot = sum(vivparh_cv), 
    d_1rm = sum(vph_1cuart),
    d_prop_1rm = sum(vph_1cuart) / sum(vivparh_cv) * 100,
    
    d_2rms = sum(vph_2cuart),
    d_prop_2rms = sum(vph_2cuart) / sum(vivparh_cv) * 100,
    
    d_3mrms = sum(vph_3ymasc),
    d_prop_3mrms = sum(vph_3ymasc) / sum(vivparh_cv) * 100,
    
    d_mean_occup_r = weighted.mean(pro_ocup_c, vivtot),
    
    d_1bedrm = sum(vph_1dor),
    d_prop_1bedrm = sum(vph_1dor) / sum(vivparh_cv) * 100,
    
    d_2mbedrms = sum(vph_2ymasd),
    d_prop_2mbedrms  = sum(vph_2ymasd) / sum(vivparh_cv) * 100,
    
    d_dirtfloor = sum(vph_pisoti),
    d_prop_dirtfloor = sum(vph_pisoti) / sum(vivparh_cv) * 100,
    
    d_ntoil = sum(vivparh_cv) - sum(vph_excsa),
    d_prop_ntoil = (1 - (sum(vph_excsa) / sum(vivparh_cv))) * 100, 
    
    d_ndrng = sum(vivparh_cv)-sum(vph_drenaj),
    d_prop_ndrng = (1-(sum(vph_drenaj)/ sum(vivparh_cv))) * 100,
    
    d_npwater = sum(vivparh_cv) - sum(vph_aguadv),
    d_prop_npwater = (1 - (sum(vph_aguadv) / sum(vivparh_cv))) * 100,
    
    d_nelect = sum(vph_c_elec),
    d_prop_nelect = (1 - (sum(vph_c_elec) / sum(vivparh_cv))) * 100,
    
    d_nbs = sum(vph_ndeaed),
    d_prop_nbs = sum(vph_ndeaed) / sum(vivparh_cv) * 100,
    
    d_ninet = sum(vivparh_cv) - sum(vph_inter),
    d_prop_ninet = (1 - (sum(vph_inter) / sum(vivparh_cv))) * 100, 
    
    d_ncmp = sum(vivparh_cv) - sum(vph_pc),
    d_prop_ncmp =  (1 - (sum(vph_pc) / sum(vivparh_cv))) * 100, 
    
    d_ncp = sum(vivparh_cv) - sum(vph_cel),
    d_prop_ncp =  (1 - (sum(vph_cel)/sum(vivparh_cv))) * 100,
    
    d_ntv = sum(vivparh_cv) - sum(vph_tv),
    d_prop_ntv = (1 - (sum(vph_tv)/sum(vivparh_cv))) * 100,
    
    d_nict = sum(vph_sintic),
    d_prop_nict = sum(vph_sintic)/ sum(vivparh_cv) * 100, 
    
    d_ncar = sum(vivparh_cv) -  sum(vph_autom),
    d_prop_ncar = (1 - (sum(vph_autom)/sum(vivparh_cv))) * 100,
    
    d_mtrcl =  sum(vph_moto),
    d_prop_mtrcl = sum(vph_moto)/sum(vivparh_cv) * 100,
    
    d_nmovh = sum(vph_ndacmm),
    d_prop_nmovh = sum(vph_ndacmm)/ sum(vivparh_cv) * 100, 
    
    d_bike =  sum(vph_bici),
    d_prop_bike = sum(vph_bici)/sum(vivparh_cv) * 100,
    
    d_nrefri = sum(vivparh_cv) -  sum(vph_refri),
    d_prop_nrefri = (1 - (sum(vph_refri)/sum(vivparh_cv))) * 100,
    
    d_nwm = sum(vivparh_cv) - sum(vph_lavad),
    d_prop_nwm = (1 - (sum(vph_lavad)/sum(vivparh_cv))) * 100,
    
    d_ngoods = sum(vph_snbien), 
    d_prop_ngoods = sum(vph_snbien) / sum(vivparh_cv) * 100, 
    
    hh_tot = sum(tothog),
    hh_f = sum(hogjef_f),
    hh_prop_f = sum(hogjef_f) / sum(tothog) * 100,
    hh_m = sum(hogjef_m),
    hh_prop_m = sum(hogjef_m) / sum(tothog) * 100,
    
    p_tot = sum(pobtot),
    
    p_tot_m = sum(pobmas),
    p_tot_f = sum(pobfem),
    
    prop_m_f = sum(pobmas) / sum(pobfem) * 100,  
    p_0to2 = sum(p_0a2),
    p_0to2_f = sum(p_0a2_f),
    p_0to2_m = sum(p_0a2_m),
    
    p_3to5 = sum(p_3a5 ),
    p_3to5_f = sum(p_3a5_f),
    p_3to5_m = sum(p_3a5_m),
    
    p_6to11 = sum(p_6a11),
    p_6to11_f = sum(p_6a11_f),
    p_6to11_m = sum(p_6a11_m),
    
    p_12to14 = sum(p_12a14),
    p_12to14_f = sum(p_12a14_f),
    p_12to14_m = sum(p_12a14_m),
    
    p_15to17 = sum(p_15a17),
    p_15to17_f = sum(p_15a17_f),
    p_15to17_m = sum(p_15a17_m),
    
    p_18to24 = sum(p_18a24),
    p_18to24_f = sum(p_18a24_f),
    p_18to24_m = sum(p_18a24_m),
    
    
    p_25to59 = sum(p_tot) - sum(p_0a2) - sum(p_3a5) - sum(p_6a11) - sum(p_12a14) - sum(p_15a17) - sum(p_18a24) - sum(p_60ymas),
    
    p_25to59_f = sum(p_tot_f) - sum(p_0a2_f) - sum(p_3a5_f) - sum(p_6a11_f) - sum(p_12a14_f) - sum(p_15a17_f) - sum(p_18a24_f) - sum(p_60ymas_f),
    
    p_25to59_m = sum(p_tot_m) - sum(p_0a2_m) - sum(p_3a5_m) - sum(p_6a11_m) - sum(p_12a14_m) - sum(p_15a17_m) - sum(p_18a24_m) - sum(p_60ymas_m), 
    
    p_60m = sum(p_60ymas),
    p_60m_f = sum(p_60ymas_f),
    p_60m_m = sum(p_60ymas_m),
    
    p_prop_tdr = (sum(pob0_14) + sum(pob65_mas)) / sum(pob15_64) * 100,
    p_prop_chddr = sum(pob0_14) / sum(pob15_64) * 100,
    p_prop_olddr = sum(pob65_mas) / sum(pob15_64) * 100,
    
    p_mean_chdba = weighted.mean(prom_hnv, p_12ymas_f),
    
    p_nhealth = sum(pobtot) - sum(pder_ss),
    p_prop_nhealth = (1-(sum(pder_ss) / sum(pobtot))) * 100,
    
    p_ilit = sum(p15ym_an),
    p_prop_ilit = sum(p15ym_an) / sum(p_15ymas) * 100,
    
    p_ilit_f = sum(p15ym_an_f),
    p_prop_ilit_f = sum(p15ym_an_f) / sum(p_15ymas_f)* 100,
    
    p_ilit_m = sum(p15ym_an_m),
    p_prop_ilit_m = sum(p15ym_an_m) / sum(p_15ymas_m)* 100,
    
    p_6to11nas = sum(p6a11_noa),
    p_prop_6to11nas = sum(p6a11_noa) / sum(p_6a11) * 100,
    p_6to11nas_f = sum(p6a11_noaf),
    p_prop_6to11nas_f = sum(p6a11_noaf) / sum(p_6a11_f) * 100,
    p_6to11nas_m = sum(p6a11_noam),
    p_prop_6to11nas_m = sum(p6a11_noam) / sum(p_6a11_m) * 100,
    
    p_12to14nas = sum(p12a14noa),
    p_prop_12to14nas = sum(p12a14noa) / sum(p_12a14) * 100,
    p_12to14nas_f = sum(p12a14noaf),
    p_prop_12to14nas_f = sum(p12a14noaf) / sum(p_12a14_f) * 100,
    p_12to14nas_m = sum(p12a14noam),
    p_prop_12to14nas_m = sum(p12a14noam) / sum(p_12a14_m) * 100,
    
    p_15to17nas = sum(p_15a17) - sum(p15a17a),
    p_prop_15to17nas = (1 - (sum(p15a17a) / sum(p_15a17))) * 100,
    p_15to17nas_f = sum(p_15a17_f) - sum(p15a17a_f),
    p_prop_15to17nas_f = (1 - (sum(p15a17a_f) / sum(p_15a17_f))) * 100,
    p_15to17nas_m = sum(p_15a17_m) - sum(p15a17a_m),
    p_prop_15to17nas_m = (1 - (sum(p15a17a_m) / sum(p_15a17_m))) * 100,
    
    p_18to24nas = sum(p_18a24) - sum(p18a24a), 
    p_prop_18to24nas = (1 - (sum(p18a24a) / sum(p_18a24))) * 100,
    p_18to24nas_f = sum(p_18a24_f) - sum(p18a24a_f), 
    p_prop_18to24nas_f = (1 - (sum(p18a24a_f) / sum(p_18a24_f))) * 100,
    p_18to24nas_m = sum(p_18a24_m) - sum(p18a24a_m), 
    p_prop_18to24nas_m = (1 - (sum(p18a24a_m) / sum(p_18a24_m))) * 100,
    
    p_mean_yredu = weighted.mean(graproes, p_15ymas),
    p_mean_yredu_f = weighted.mean(graproes_f, p_15ymas_f),
    p_mean_yredu_m = weighted.mean(graproes_m, p_15ymas_m),
    
    p_emp = sum(pocupada),
    p_emp_f = sum(pocupada_f),
    p_emp_m = sum(pocupada_m),
    p_unem = sum(pdesocup),
    p_unem_f = sum(pdesocup_f ),
    p_unem_m = sum(pdesocup_m ), 
    
    p_prop_emp = sum(pocupada) / (sum(pocupada) + sum(pdesocup)) * 100,
    p_prop_emp_f = sum(pocupada_f) / (sum(pocupada_f) + sum(pdesocup_f)) * 100,
    p_prop_emp_m= sum(pocupada_m) / (sum(pocupada_m) + sum(pdesocup_m)) * 100,
    
    p_econia = sum(pe_inac), 
    p_econia_f = sum(pe_inac_f),
    p_econia_m = sum(pe_inac_m),
    
    p_langindig = sum(p3ym_hli),
    p_langindig_f = sum(p3ym_hli_f),
    p_langindig_m = sum(p3ym_hli_m),
    p_disab = sum(pcon_disc), 
    p_disab_mtr = sum(pcdisc_mot),
    p_disab_vis = sum(pcdisc_vis))

## Other levels  ------------------------------------------
df$nom_loc2 = df$nom_loc
df$cve_loc = paste(df$state_code, df$municipality_code, df$locality_code, sep="") %>% as.character()

df = df %>%
  naniar::replace_with_na(replace = list(nom_loc2 = c("Total de la localidad urbana", "Total AGEB urbana")))

df$nom_loc2 <- ave(df$nom_loc2, df$cve_loc, FUN=function(x)unique(x[!is.na(x)]))

df <- df %>% dplyr::mutate(state_name = nom_ent,
                           municipality_name = nom_mun,
                           locality_name = nom_loc2)%>% 
  add_column(year = "2020",
             entity_level = NA,
             municipality_id = NA,
             locality_id = NA,
             ageb_id = NA,
             block_id = NA
             )

df <- df %>% 
  dplyr::mutate(
    state_name = nom_ent,
    municipality_name = nom_mun,
    d_tot = vivparh_cv, 
    d_1rm = vph_1cuart,
    d_prop_1rm = vph_1cuart / vivparh_cv * 100,
    d_2rms = vph_2cuart,
    d_prop_2rms = vph_2cuart / vivparh_cv * 100,
    d_3mrms = vph_3ymasc,
    d_prop_3mrms = vph_3ymasc / vivparh_cv * 100,
    d_mean_occup_r = pro_ocup_c,
    d_1bedrm = vph_1dor,
    d_prop_1bedrm = vph_1dor / vivparh_cv * 100,
    d_2mbedrms = vph_2ymasd,
    d_prop_2mbedrms = vph_2ymasd / vivparh_cv * 100,
    
    d_dirtfloor = vph_pisoti,
    d_prop_dirtfloor = vph_pisoti / vivparh_cv * 100,
    d_ntoil =  vivparh_cv - vph_excsa,
    d_prop_ntoil = (1 - (vph_excsa / vivparh_cv)) * 100,   
    d_ndrng = vivparh_cv - vph_drenaj,
    d_prop_ndrng = (1-(vph_drenaj / vivparh_cv)) * 100,
    d_npwater =vivparh_cv- vph_aguadv,
    d_prop_npwater = (1 - (vph_aguadv / vivparh_cv)) * 100,
    d_nelect = vivparh_cv - vph_c_elec,
    d_prop_nelect = (1 - (vph_c_elec / vivparh_cv)) * 100,
    d_nbs = vph_ndeaed,
    d_prop_nbs = vph_ndeaed / vivparh_cv * 100,
    d_ninet = vivparh_cv - vph_inter,
    d_prop_ninet = (1 - (vph_inter/vivparh_cv)) * 100,
    d_ncmp = vivparh_cv - vph_pc, 
    d_prop_ncmp =  (1 - (vph_pc/vivparh_cv)) * 100,
    d_ncp = vivparh_cv - vph_cel, 
    d_prop_ncp =  (1 - (vph_cel/vivparh_cv)) * 100,
    d_ntv = vivparh_cv - vph_tv, 
    d_prop_ntv = (1 - (vph_tv/vivparh_cv)) * 100,
    d_nict = vph_sintic, 
    d_prop_nict = vph_sintic/vivparh_cv * 100,
    d_ncar = vivparh_cv - vph_autom, 
    d_prop_ncar = (1 - (vph_autom/vivparh_cv)) * 100,
    d_mtrcl = vph_moto, 
    d_prop_mtrcl = vph_moto/vivparh_cv * 100,
    d_nmovh = vph_ndacmm, 
    d_prop_nmovh = vph_ndacmm/vivparh_cv * 100,
    d_bike  = vph_bici, 
    d_prop_bike  = vph_bici/vivparh_cv * 100,    
    d_nrefri = vivparh_cv - vph_refri, 
    d_prop_nrefri = (1 - (vph_refri/vivparh_cv)) * 100,
    d_nwm = vivparh_cv - vph_lavad,
    d_prop_nwm = (1 - (vph_lavad/vivparh_cv)) * 100,
    d_ngoods = vph_snbien,
    d_prop_ngoods = vph_snbien/vivparh_cv * 100,
    
    hh_tot = tothog,
    hh_f = hogjef_f,
    hh_prop_f = hogjef_f / tothog * 100,
    hh_m = hogjef_m,
    hh_prop_m = hogjef_m / tothog * 100,       
    
    p_tot = pobtot, 
    p_tot_m = pobmas, 
    p_tot_f = pobfem, 
    p_prop_m_f = pobmas/pobfem * 100, 
    
    p_0to2 = p_0a2, 
    p_0to2_f = p_0a2_f, 
    p_0to2_m = p_0a2_m, 
    
    p_3to5 = p_3a5 , 
    p_3to5_f = p_3a5_f, 
    p_3to5_m = p_3a5_m, 
    p_6to11 = p_6a11, 
    p_6to11_f = p_6a11_f, 
    p_6to11_m = p_6a11_m, 
    p_12to14 = p_12a14, 
    p_12to14_f = p_12a14_f, 
    p_12to14_m = p_12a14_m, 
    p_15to17 = p_15a17, 
    p_15to17_f = p_15a17_f, 
    p_15to17_m = p_15a17_m, 
    p_18to24 = p_18a24, 
    p_18to24_f = p_18a24_f, 
    p_18to24_m = p_18a24_m, 
    p_25to59 = p_tot - p_0a2 - p_3a5 - p_6a11 - p_12a14 - p_15a17 - p_18a24 - p_60ymas,
    p_25to59_f = p_tot_f - p_0a2_f - p_3a5_f - p_6a11_f - p_12a14_f - p_15a17_f - p_18a24_f - p_60ymas_f,
    p_25to59_m = p_tot_m - p_0a2_m - p_3a5_m - p_6a11_m - p_12a14_m - p_15a17_m - p_18a24_m - p_60ymas_m,     
    p_60m = p_60ymas, 
    p_60m_f = p_60ymas_f, 
    p_60m_m = p_60ymas_m, 
    p_prop_tdr = (pob0_14 + pob65_mas) / pob15_64 * 100,
    p_prop_chddr = pob0_14 / pob15_64 * 100,
    p_prop_olddr = pob65_mas / pob15_64 * 100,
    p_mean_chdba = prom_hnv,
    
    p_nhealth = pobtot - pder_ss,
    p_prop_nhealth = (1-(pder_ss / pobtot)) * 100,
    
    p_ilit = p15ym_an,
    p_prop_ilit = p15ym_an / p_15ymas * 100,
    p_ilit_f = p15ym_an_f,
    p_prop_ilit_f = p15ym_an_f / p_15ymas_f * 100,
    p_ilit_m = p15ym_an_m,
    p_prop_ilit_m = p15ym_an_m / p_15ymas_m * 100,
    
    p_6to11nas = p6a11_noa,
    p_prop_6to11nas = p6a11_noa / p_6a11 * 100,
    p_6to11nas_f = p6a11_noaf,
    p_prop_6to11nas_f =  p6a11_noaf / p_6a11_f * 100,
    p_6to11nas_m = p6a11_noam,
    p_prop_6to11nas_m =  p6a11_noam / p_6a11_m * 100,      
    
    p_12to14nas = p12a14noa,
    p_prop_12to14nas = p12a14noa / p_12a14 * 100,
    p_12to14nas_f = p12a14noaf,
    p_prop_12to14nas_f = p12a14noaf / p_12a14_f * 100, 
    p_12to14nas_m = p12a14noam,
    p_prop_12to14nas_m = p12a14noam / p_12a14_m * 100,
    
    p_15to17nas = p_15a17 - p15a17a, 
    p_prop_15to17nas = (1 - (p15a17a / p_15a17)) * 100,
    p_15to17nas_f = p_15a17_f - p15a17a_f,
    p_prop_15to17nas_f = (1 - (p15a17a_f / p_15a17_f)) * 100,
    p_15to17nas_m = p_15a17_m - p15a17a_m,
    p_prop_15to17nas_m = (1 - (p15a17a_m / p_15a17_m)) * 100,
    
    p_18to24nas = p_18a24 - p18a24a, 
    p_prop_18to24nas = (1 - (p18a24a / p_18a24)) * 100,
    p_18to24nas_f = p_18a24_f - p18a24a_f,
    p_prop_18to24nas_f = (1 - (p18a24a_f / p_18a24_f)) * 100,
    p_18to24nas_m = p_18a24_m - p18a24a_m,
    p_prop_18to24nas_m = (1 - (p18a24a_m / p_18a24_m)) * 100,
    p_mean_yredu =  graproes,
    p_mean_yredu_f = graproes_f,
    p_mean_yredu_m = graproes_m,
    
    p_emp = pocupada,
    p_emp_f = pocupada_f,
    p_emp_m = pocupada_m,
    p_unem = pdesocup,
    p_unem_f = pdesocup_f,
    p_unem_m = pdesocup_m, 
    p_prop_emp = pocupada / (pocupada + pdesocup) * 100,
    p_prop_emp_f = pocupada_f / (pocupada_f + pdesocup_f) * 100,
    p_prop_emp_m = pocupada_m / (pocupada_m + pdesocup_m) * 100,
    p_econia = pe_inac, 
    p_econia_f = pe_inac_f,
    p_econia_m = pe_inac_m,
    
    p_langindig = p3ym_hli,
    p_langindig_f = p3ym_hli_f,
    p_langindig_m = p3ym_hli_m,
    p_disab = pcon_disc, 
    p_disab_mtr = pcdisc_mot,
    p_disab_vis = pcdisc_vis
  ) 

# Just processed vars
df <- df %>% 
  select(year, entity_level, state_code, state_name, 
         municipality_code, municipality_name, municipality_id,
         locality_code, locality_name, locality_id,
         ageb_code, ageb_id,
         block_code, block_id,
         d_tot, d_1rm,d_prop_1rm, d_2rms,            
         d_prop_2rms,        d_3mrms,            d_prop_3mrms,      
         d_mean_occup_r,     d_1bedrm,           d_prop_1bedrm,     
         d_2mbedrms,         d_prop_2mbedrms,    d_dirtfloor,       
         d_prop_dirtfloor,   d_ntoil,            d_prop_ntoil,      
         d_ndrng,            d_prop_ndrng,       d_npwater,         
         d_prop_npwater,     d_nelect,           d_prop_nelect,     
         d_nbs,d_prop_nbs,   d_ninet,           
         d_prop_ninet,       d_ncmp,             d_prop_ncmp,       
         d_ncp,d_prop_ncp,    d_ntv,             
         d_prop_ntv,         d_nict,             d_prop_nict,       
         d_ncar,             d_prop_ncar,        d_mtrcl,           
         d_prop_mtrcl,       d_nmovh,            d_prop_nmovh,      
         d_bike,             d_prop_bike,        d_nrefri,          
         d_prop_nrefri,      d_nwm,d_prop_nwm,        
         d_ngoods,           d_prop_ngoods,      
         hh_tot, hh_f, hh_prop_f, hh_m, hh_prop_m,
         p_tot,             
         p_tot_m,            p_tot_f,            p_prop_m_f,          
         p_0to2,             p_0to2_f,           p_0to2_m,          
         p_3to5,             p_3to5_f,           p_3to5_m,          
         p_6to11,            p_6to11_f,          p_6to11_m,         
         p_12to14,           p_12to14_f,         p_12to14_m,        
         p_15to17,           p_15to17_f,         p_15to17_m,        
         p_18to24,           p_18to24_f,         p_18to24_m,        
         p_25to59,           p_25to59_f,         p_25to59_m,        
         p_60m,p_60m_f,      p_60m_m,           
         p_prop_tdr,         p_prop_chddr,       p_prop_olddr,      
         p_mean_chdba,       p_nhealth,          p_prop_nhealth,     
         p_ilit,             p_prop_ilit,        p_ilit_f,          
         p_prop_ilit_f,      p_ilit_m,           p_prop_ilit_m,     
         p_6to11nas,         p_prop_6to11nas,    p_6to11nas_f,      
         p_prop_6to11nas_f,  p_6to11nas_m,       p_prop_6to11nas_m, 
         p_12to14nas,        p_prop_12to14nas,   p_12to14nas_f,     
         p_prop_12to14nas_f, p_12to14nas_m,      p_prop_12to14nas_m,
         p_15to17nas,        p_prop_15to17nas,   p_15to17nas_f,     
         p_prop_15to17nas_f, p_15to17nas_m,      p_prop_15to17nas_m,
         p_18to24nas,        p_prop_18to24nas,   p_18to24nas_f,     
         p_prop_18to24nas_f, p_18to24nas_m,      p_prop_18to24nas_m,
         p_mean_yredu,       p_mean_yredu_f,     p_mean_yredu_m,    
         p_emp,p_emp_f,      p_emp_m,           
         p_unem,             p_unem_f,           p_unem_m,          
         p_prop_emp,         p_prop_emp_f,       p_prop_emp_m,      
         p_econia,           p_econia_f,         p_econia_m,        
         p_langindig,       
         p_langindig_f,      p_langindig_m,      p_disab,           
         p_disab_mtr,        p_disab_vis)

# 3. save -----------------------------------------------------------------
## national -----------------------------------------------------------------
### census
fwrite(census_mexico_national_2020, "01_data/20/02_proc_census/census_mexico_national_2020.csv",
      row.names = FALSE
      )

put_object(file = "01_data/20/02_proc_census/census_mexico_national_2020.csv",
           object = "data/dev/mexico_2/census/census_mexico_national_2020.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

### census_geo
b_national <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2020/boundary_00_country.geojson")
b_national <- select(b_national, geometry)
b_national$state_code <- NA
census_geo <- full_join(census_mexico_national_2020, b_national)

st_write(census_geo,
         "01_data/20/02_proc_geo/national/census_geo.geojson",
         update = TRUE)


put_object(file = "01_data/20/02_proc_geo/national/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/national/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read",
           multipart = TRUE)

## state -----------------------------------------------------------------
census_mexico_state_2020 <- filter(df, municipality_code == "000")

census_mexico_state_2020 = census_mexico_state_2020 %>%
  mutate(
    entity_level = "state",
    municipality_code = NA, 
    municipality_name = NA,
    municipality_id = NA,
    locality_code = NA, 
    locality_name = NA,
    locality_id = NA,
    ageb_code = NA, 
    ageb_id = NA,
    block_code = NA,
    block_id = NA
  )

mi_state = read.xlsx("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2020/IM/01_state_im.xlsx")

# keep index and vars which are not publicly available
mi_state = select(mi_state,
                  state_id,
                  p_prop_neducbasic, d_prop_ovp, p_prop_pobl5k, p_prop_lwage, mi_nat_s, mi_nat_group
                  )

census_mexico_state_2020 <- merge(census_mexico_state_2020, mi_state, by.x ="state_code", by.y="state_id")
fwrite(census_mexico_state_2020, "01_data/20/02_proc_census/census_mexico_state_2020.csv",
       row.names = FALSE
)

put_object(file = "01_data/20/02_proc_census/census_mexico_state_2020.csv",
           object = "data/dev/mexico_2/census/census_mexico_state_2020.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

### census_geo
geo_state <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2020/boundary_01_state.geojson")
geo_state <- select(geo_state,
                  CVEGEO, geometry
                  )
names(geo_state) <- c("state_code", "geometry")

census_state_geo <-  full_join(census_mexico_state_2020, geo_state, by = "state_code")


state_list = unique(census_mexico_state_2020$state_name)
state_codes = unique(census_mexico_state_2020$state_code)

# create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  # filter state
  census_state_geo_state = census_state_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./01_data/20/02_proc_geo/state/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  
  # store locally
  file_path = paste(dir_path,
                    "census_state_geo_2020.geojson",
                    sep = "/")
  st_write(census_state_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2020/state/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}
st_write(census_state_geo,
         "01_data/20/02_proc_geo/state/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "01_data/20/02_proc_geo/state/2020/All/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/state/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

## municipality  -----------------------------------------------------------------
census_mexico_municipality_2020 <- filter(df, municipality_code != "000" & locality_code == "0000")

census_mexico_municipality_2020 = census_mexico_municipality_2020 %>%
  mutate(
    entity_level = "Municipality",
    locality_code = NA, 
    locality_name = NA,
    locality_id = NA,
    ageb_code = NA, 
    ageb_id = NA,
    block_code = NA,
    block_id = NA)

census_mexico_municipality_2020$municipality_id= paste0(formatC(census_mexico_municipality_2020$state_code,width=2, flag="0"), 
                                                formatC(census_mexico_municipality_2020$municipality_code,width=3, flag="0"))

mi_municipality <- read.xlsx("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2020/IM/02_municipality_im.xlsx")

mi_municipality <- select(mi_municipality,
                          municipality_id,
                          p_prop_neducbasic, d_prop_ovp, p_prop_pobl5k, p_prop_lwage, mi_nat_s, mi_nat_group)

census_mexico_municipality_2020 <- merge(census_mexico_municipality_2020, mi_municipality, by="municipality_id")
fwrite(census_mexico_municipality_2020, "01_data/20/02_proc_census/census_mexico_municipality_2020.csv",
       row.names = FALSE
)

put_object(file = "01_data/20/02_proc_census/census_mexico_municipality_2020.csv",
           object = "data/dev/mexico_2/census/census_mexico_municipality_2020.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

### census_geo
geo_municipality <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2020/boundary_02_municipality.geojson")

geo_municipality <- select(geo_municipality,
                    CVEGEO,geometry
)
names(geo_municipality) <- c("municipality_id","geometry")


census_municipality_geo <-  full_join(census_mexico_municipality_2020, geo_municipality, by = "municipality_id")


# Write to file with Latin-1 encoding
st_write(census_municipality_geo,
         "01_data/20/02_proc_geo/municipality/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "01_data/20/02_proc_geo/municipality/All/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/2020/municipality/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

# create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_municipality_geo_state = census_municipality_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./01_data/20/02_proc_geo/municipality/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_municipality_geo_2020.geojson",
                    sep = "/")
  st_write(census_municipality_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2020/municipality/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)}

## locality  -----------------------------------------------------------------
census_mexico_locality_2020 <- filter(df, locality_code != "0000" & ageb_code == "0000")

census_mexico_locality_2020 = census_mexico_locality_2020 %>%
  mutate(
    entity_level = "Locality",
    ageb_code = NA, 
    ageb_id = NA,
    block_code = NA,
    block_id = NA)

census_mexico_locality_2020$locality_id = paste0(formatC(census_mexico_locality_2020$state_code,width=2, flag="0"), 
                                            formatC(census_mexico_locality_2020$municipality_code, width=3, flag="0"),
                                            formatC(census_mexico_locality_2020$locality_code, width=4, flag="0"))

mi_locality <- read.xlsx("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2020/IM/03_locality_im.xlsx")

mi_locality <- select(mi_locality,
                      locality_id,
                      p_prop_neducbasic, d_prop_ovp
                      )
census_mexico_locality_2020 <- merge(census_mexico_locality_2020, mi_locality, by="locality_id")
fwrite(census_mexico_locality_2020, "01_data/20/02_proc_census/census_mexico_locality_2020.csv",
       row.names = FALSE
)

put_object(file = "01_data/20/02_proc_census/census_mexico_locality_2020.csv",
           object = "data/dev/mexico_2/census/census_mexico_locality_2020.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
### census_geo
geo_locality <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2020/boundary_03_locality.geojson")
geo_locality <- select(geo_locality,
                       CVEGEO, geometry
)
names(geo_locality) <- c("locality_id", "geometry")

census_locality_geo <-  full_join(census_mexico_locality_2020, geo_locality, by = "locality_id")

st_write(census_locality_geo,
         "01_data/20/02_proc_geo/locality/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "01_data/20/02_proc_geo/locality/All/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/2020/locality/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
# create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_locality_geo_state = census_locality_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./01_data/20/02_proc_geo/locality/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_locality_geo_2020.geojson",
                    sep = "/")
  st_write(census_locality_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2020/locality/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

## AGEB  -----------------------------------------------------------------
census_mexico_ageb_2020 <- filter(df, ageb_code != "0000" & block_code == "000")

census_mexico_ageb_2020 = census_mexico_ageb_2020 %>%
  mutate(
    entity_level = "AGEB",
    block_code = NA,
    block_id = NA)

census_mexico_ageb_2020$ageb_id = paste0(formatC(census_mexico_ageb_2020$state_code,width=2, flag="0"), 
                                         formatC(census_mexico_ageb_2020$municipality_code, width=3, flag="0"),
                                         formatC(census_mexico_ageb_2020$locality_code, width=4, flag="0"),
                                         formatC(census_mexico_ageb_2020$ageb_code, width=4, flag="0"))

iisu_ageb <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/mexico/indices/2020/iisu_20_v3.csv",
                  encoding = "UTF-8", header = TRUE) %>% rename_all(tolower)
iisu_ageb <- select(iisu_ageb,
                    sun_id, sun_name, ageb_id, 
                    d_prop_ovp,
                    mi_nat_s, mi_nat_group,
                    suii_nat, suii_nat_s, suii_nat_group,
                    suii_city, suii_city_s, suii_city_group
                    )
census_mexico_ageb_2020 <- full_join(census_mexico_ageb_2020, iisu_ageb, by = "ageb_id")

fwrite(census_mexico_ageb_2020, "01_data/20/02_proc_census/census_mexico_ageb_2020.csv",
       row.names = FALSE
)

put_object(file = "01_data/20/02_proc_census/census_mexico_ageb_2020.csv",
           object = "data/dev/mexico_2/census/census_mexico_ageb_2020.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
### census_geo
geo_ageb <- st_read("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/dev/mexico_2/boundaries/2020/boundary_04_ageb.geojson")
geo_ageb <- select(geo_ageb,
                   CVEGEO, geometry
)
names(geo_ageb) <- c("ageb_id", "geometry")

census_ageb_geo <-  full_join(census_mexico_ageb_2020, geo_ageb, by = "ageb_id")

st_write(census_ageb_geo,
         "01_data/20/02_proc_geo/ageb/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "01_data/20/02_proc_geo/ageb/All/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/ageb/2020/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
# create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_ageb_geo_state = census_ageb_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./01_data/20/02_proc_geo/ageb/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_ageb_geo_2020.geojson",
                    sep = "/")
  st_write(census_ageb_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2020/ageb/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

## block  -----------------------------------------------------------------
census_mexico_block_2020 <- filter(df,  block_code != "000") 

census_mexico_block_2020 <- census_mexico_block_2020 %>% 
  mutate(entity_level = "block",
         block_id = paste0(formatC(state_code, width = 2, flag = "0"),
                           formatC(municipality_code, width = 3, flag = "0"),
                           formatC(locality_code, width = 4, flag = "0"),
                           formatC(ageb_code, width = 4, flag = "0"),
                           formatC(block_code, width = 3, flag = "0")))

put_object(file = "01_data/20/02_proc_census/census_mexico_block_2020.csv",
           object = "data/dev/mexico_2/census/census_mexico_block_2020.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
### census_geo
geo_block <- st_read("01_data/20/01_raw_geo/boundary_05_block.geojson")
geo_block <- select(geo_block,
                    CVEGEO, geometry
)
names(geo_block) <- c("block_id", "geometry")

census_block_geo <-  full_join(census_mexico_block_2020, geo_block, by = "block_id")

# create geojson files for each state  ----
for(i in 1:length(state_codes)){
  
  state_i = state_list[i]
  state_i_code = state_codes[i]
  
  # filter state
  census_block_geo_state = census_block_geo %>% 
    filter(state_name == state_i)
  # create dir
  dir_path = paste("./01_data/20/02_proc_geo/block/",
                   state_i_code,
                   sep = "")
  dir.create(dir_path)
  # store locally
  file_path = paste(dir_path,
                    "census_block_geo_2020.geojson",
                    sep = "/")
  st_write(census_block_geo_state,
           file_path,
           delete_dsn = TRUE)
  
  # upload to s3
  object_path = paste("data/dev/mexico_2/census_geo/2020/block/",
                      state_i_code,
                      "/",
                      "census_geo.geojson",
                      sep = "")
  put_object(file = file_path, 
             object = object_path, 
             bucket = "cities-socio-economic-vulnerability",
             acl = "public-read",
             multipart = TRUE)
  
}

st_write(census_block_geo,
         "01_data/20/02_proc_geo/block/All/census_geo.geojson",
         delete_dsn = TRUE)

put_object(file = "01_data/20/02_proc_geo/block/All/census_geo.geojson",
           object = "data/dev/mexico_2/census_geo/2020/block/All/census_geo.geojson", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")