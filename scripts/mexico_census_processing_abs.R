# Set up
rm(list=ls())
memory.limit(size=56000)

# Libraries
library(tidyverse)
library(tidyr)
require(dplyr)
library(plyr)
library(pacman)

# States data
# setwd("data/01_raw-mexico") available in 
#https://onewri.sharepoint.com/:f:/s/SpatialSocioEconomicVulnerabilityIndex/EhGoMrv2_EBMm-kv1hAplA0B_0pACdpEiCFZ17PstLygGQ?e=ggXWnT
# census_mexico  <- ldply(list.files(), read.csv, header=TRUE)

# Replace * with NA
census_mexico <- census_mexico %>% dplyr::na_if("*")
# Names to lower
names(census_mexico) <- tolower(names(census_mexico))

# Just chosen variables
census_mexico <- select(census_mexico, 
                        ï..entidad, nom_ent, mun, nom_mun, loc, nom_loc, ageb, mza,
                        vivtot, vivparh_cv, vph_1cuart, vph_2cuart, vph_3ymasc, pro_ocup_c,
                        vph_1dor, vph_2ymasd, vph_pisoti, vph_excsa, vph_nodren, vph_aguafv, vph_s_elec,
                        vph_ndeaed, vph_inter, vph_pc, vph_cel, vph_tv, vph_sintic, vph_autom,vph_moto, vph_ndacmm, vph_refri, vph_lavad, 
                        pobtot, pobmas, pobfem, p_0a2, p_0a2_f, p_0a2_m, p_3a5, p_3a5_m, p_3a5_f, p_6a11, p_6a11_f, p_6a11_m, 
                        p_12a14, p_12a14_f, p_12a14_m, p_15a17, p_15a17_f, p_15a17_m,p_15ymas_f , p_15ymas_m, p_15ymas_f,
                        p_18a24, p_18a24_f, p_18a24_m,
                        p_60ymas, p_60ymas_f, p_60ymas_m, 
                        pob0_14, pob65_mas, pob15_64, prom_hnv, p_12ymas_f, psinder, p15ym_an, p15ym_an_f, p15ym_an_m, 
                        p6a11_noa, p6a11_noaf, p6a11_noam, p12a14noa, p12a14noaf, p12a14noam, p15a17a, p15a17a_f, p15a17a_m,
                        p18a24a, p18a24a_f, p18a24a_m, graproes, p_15ymas, graproes_f, p_15ymas_f, graproes_m, p_15ymas_m,
                        pocupada, pocupada_f, pocupada_m, pdesocup, pdesocup_f, pdesocup_m, pe_inac, pe_inac_f, pe_inac_m,
                        tothog, hogjef_f, hogjef_m, p3ym_hli, p3ym_hli_f, p3ym_hli_m, pcon_disc, pcdisc_mot, pcdisc_vis)

# Convert to numeric
census_mexico[, c(8:101)] <- sapply(census_mexico[, c(8:101)], as.numeric)

# Variable_name_processed
census_mexico <- census_mexico %>% 
  dplyr::mutate(
    state_id = ï..entidad,           
    state_name = nom_ent,
    municipality_id= mun,
    municipality_name = nom_mun,
    locality_id = loc,
    locality_name = nom_loc,
    ageb_id = ageb,
    d_dwg = vivparh_cv, 
    d_1rm = vph_1cuart,
    d_2rms = vph_2cuart,
    d_3mrms = vph_3ymasc,
    d_mean_occup_r = pro_ocup_c,
    d_1bedrm = vph_1dor,
    d_2mbedrms = vph_2ymasd,
    d_dirtfloor = vph_pisoti,
    d_ntoil =  vivparh_cv - vph_excsa,
    d_ndrng = vph_nodren,
    d_npwater = vph_aguafv,
    d_nelect = vph_s_elec,
    d_nbs = vph_ndeaed,
    d_ninet = vivparh_cv - vph_inter,
    d_ncmp = vivparh_cv - vph_pc,
    d_ncp = vivparh_cv - vph_cel, 
    d_ntv = vivparh_cv - vph_tv, 
    d_nict = vph_sintic, 
    d_ncar = vivparh_cv - vph_autom, 
    d_nmtrcl = vivparh_cv - vph_moto, 
    d_nmovh = vph_ndacmm, 
    d_nrefri = vivparh_cv - vph_refri, 
    d_nwm = vivparh_cv - vph_lavad,
    p_tot = pobtot, 
    p_tot_m = pobmas, 
    p_tot_f = pobfem, 
    p_0to2 = p_0a2, 
    p_0to2_f = p_0a2_f, 
    p_0to2_m = p_0a2_m, 
    p_3to5 = p_3a5 , 
    p_3to5_f = p_3a5_f, 
    p_3to5_m = p_3a5_m, 
    p_6to11 = p_6a11, 
    p_6to11_f = p_6a11_f, 
    p_6to11_m = p_6a11_m, 
    p_12to14 = p_12a14, 
    p_12to14_f = p_12a14_f, 
    p_12to14_m = p_12a14_m, 
    p_15to17 = p_15a17, 
    p_15to17_f = p_15a17_f, 
    p_15to17_m = p_15a17_m, 
    p_18to24 = p_18a24, 
    p_18to24_f = p_18a24_f, 
    p_18to24_m = p_18a24_m, 
    p_25to59 = p_tot - p_0a2 - p_3a5 - p_6a11 - p_12a14 - p_15a17 - p_18a24 - p_60ymas,
    p_25to59_f = p_tot_f - p_0a2_f - p_3a5_f - p_6a11_f - p_12a14_f - p_15a17_f - p_18a24_f - p_60ymas_f,
    p_25to59_m = p_tot_m - p_0a2_m - p_3a5_m - p_6a11_m - p_12a14_m - p_15a17_m - p_18a24_m - p_60ymas_m,            
    p_60m = p_60ymas, 
    p_60m_f = p_60ymas_f, 
    p_60m_m = p_60ymas_m, 
    p_mean_chdba = prom_hnv,
    p_nhealth = psinder,
    p_ilit = p15ym_an,
    p_ilit_f = p15ym_an_f,
    p_ilit_m = p15ym_an_m,
    p_6to11nas = p6a11_noa,
    p_6to11nas_f = p6a11_noaf,
    p_6to11nas_m = p6a11_noam,
    p_12to14nas = p12a14noa,
    p_12to14nas_f = p12a14noaf,
    p_12to14nas_m = p12a14noam,
    p_15to17nas = p_15a17 - p15a17a, 
    p_15to17nas_f = p_15a17_f - p15a17a_f,
    p_15to17nas_m = p_15a17_m - p15a17a_m,
    p_18to24nas = p_18a24 - p18a24a, 
    p_18to24nas_f = p_18a24_f - p18a24a_f,
    p_18to24nas_m = p_18a24_m - p18a24a_m,
    p_mean_yredu =  graproes,
    p_mean_yredu_f = graproes_f,
    p_mean_yredu_m = graproes_m,
    p_emp = pocupada,
    p_emp_f = pocupada_f,
    p_emp_m = pocupada_m,
    p_unem = pdesocup,
    p_unem_f = pdesocup_f,
    p_unem_m = pdesocup_m, 
    p_econia = pe_inac, 
    p_econia_f = pe_inac_f,
    p_econia_m = pe_inac_m,
    p_hh = tothog,
    p_hh_f = hogjef_f,
    p_hh_m = hogjef_m,
    p_langindig = p3ym_hli,
    p_langindig_f = p3ym_hli_f,
    p_langindig_m = p3ym_hli_m,
    p_disab = pcon_disc, 
    p_disab_mtr = pcdisc_mot,
    p_disab_vis = pcdisc_vis
  ) 

# Block id
census_mexico$block_id <- paste(census_mexico$ageb_id, census_mexico$mza, sep = "_")%>% as.character()

# Column with localities' names
census_mexico$locality_id_2 <- paste0(formatC(census_mexico$state_id,width=2, flag="0"), 
                                      formatC(census_mexico$municipality_id,width=3, flag="0"),
                                      formatC(census_mexico$locality_id,width=4, flag="0"), sep="")

locality_id_2 <- census_mexico[c("locality_id_2")] 

locality_name2 <- census_mexico[c("locality_id_2","locality_name")]


locality_name2 <- filter(locality_name2, locality_name!="Total de la entidad", locality_name!="Total del municipio",
                         locality_name!= "Total de la localidad urbana", locality_name!= "Total AGEB urbana"
)

locality_name2  <- locality_name2[!duplicated(locality_name2$locality_id_2), ]

# Just processed vars
census_mexico <- census_mexico %>% 
  select(state_name, municipality_name, locality_name, locality_id_2, ageb_id, block_id,
         d_dwg, d_1rm, d_2rms, d_3mrms, d_mean_occup_r, d_1bedrm, d_2mbedrms, 
         d_dirtfloor, d_ntoil, d_ndrng, d_npwater, d_nelect, d_nbs, d_ninet, d_ncmp, d_ncp, d_ntv, d_nict, d_ncar, d_nmtrcl, d_nmovh, d_nrefri, d_nwm, 
         p_tot, p_tot_m, p_tot_f, p_0to2, p_0to2_f, p_0to2_m, p_3to5, p_3to5_f, p_3to5_m, p_6to11, p_6to11_f, p_6to11_m, 
         p_12to14, p_12to14_f, p_12to14_m, p_15to17, p_15to17_f, p_15to17_m, p_18to24, p_18to24_f, p_18to24_m, p_25to59, p_25to59_f, p_25to59_m, p_60m, p_60m_f,
         p_60m_m, p_mean_chdba, p_nhealth, p_ilit, p_ilit_f, p_ilit_m, p_6to11nas, p_6to11nas_f, p_6to11nas_m, p_12to14nas, p_12to14nas_f, p_12to14nas_m, p_15to17nas, 
         p_15to17nas_f, p_15to17nas_m, p_18to24nas, p_18to24nas_f, p_18to24nas_m, p_mean_yredu, p_mean_yredu_f, p_mean_yredu_m, p_emp, p_emp_f, p_emp_m, p_unem, 
         p_unem_f, p_unem_m, p_econia, p_econia_f, p_econia_m, p_hh, p_hh_f, p_hh_m, p_langindig, p_langindig_f, p_langindig_m, p_disab, p_disab_mtr, p_disab_vis
  )


# Variable_name_processed_viz
census_mexico <- plyr::rename(census_mexico, 
                              c(
                                "d_dwg"="Dwlgs",
                                "d_1rm"="Dwlgs with 1 room",
                                "d_2rms"="Dwlgs  with 2 rooms",
                                "d_3mrms"="Dwlgs with 3+ rooms",
                                "d_mean_occup_r"="Avg occupants per room",
                                "d_1bedrm"="Dwlgs with 1 bedroom",
                                "d_2mbedrms"="Dwlgs with 2+ bedrooms",
                                "d_dirtfloor"="Dwlgs with dirt floor",
                                "d_ntoil"="Dwlgs without toilet ",
                                "d_ndrng"="Dwlgs without drainage",
                                "d_npwater"="Dwlgs without piped water",
                                "d_nelect"="Dwlgs without electrical energy ",
                                "d_nbs"="Dwlgs without electrical energy neither drainage network neither toilet with water intake",
                                "d_ninet"="Dwlgs without internet",
                                "d_ncmp"="Dwlgs without computer",
                                "d_ncp"="Dwlgs without cellphone",
                                "d_ntv"="Dwlgs without tv",
                                "d_nict"="Dwlgs without ICT",
                                "d_ncar"="Dwlgs without cars",
                                "d_nmtrcl"="Dwlgs without mtrcl",
                                "d_nmovh"="Dwlgs without vehicles",
                                "d_nrefri"="Dwlgs without refrigerator",
                                "d_nwm"="Dwlgs without  washing machine",
                                "p_tot"="Pop",
                                "p_tot_m"="Male pop",
                                "p_tot_f"="Female pop",
                                "p_0to2"="Pop aged 0-2 yrs",
                                "p_0to2_f"="Female pop aged 0-2 yrs",
                                "p_0to2_m"="Male pop aged 0-2 yrs",
                                "p_3to5"="Pop aged 3-5 yrs",
                                "p_3to5_f"="Female pop aged 3-5 yrs",
                                "p_3to5_m"="Male pop aged 3-5 yrs",
                                "p_6to11"="Pop aged 6-11 yrs",
                                "p_6to11_f"="Female pop aged 6-11 yrs",
                                "p_6to11_m"="Male pop aged 6 -11 yrs",
                                "p_12to14"="Pop aged 12-14 yrs",
                                "p_12to14_f"="Female pop aged 12-14 yrs",
                                "p_12to14_m"="Male pop aged 12-14 yrs",
                                "p_15to17"="Pop aged 15-17 yrs",
                                "p_15to17_f"="Female pop aged 15 -17 yrs",
                                "p_15to17_m"="Male pop aged 15-17 yrs",
                                "p_18to24"="Pop aged 18-24 yrs",
                                "p_18to24_f"="Female pop aged 18-24 yrs",
                                "p_18to24_m"="Male Pop aged 18 -24 yrs",
                                "p_25to59"="Pop aged 25-59 yrs",
                                "p_25to59_f"="Female Pop aged 25-59 yrs",
                                "p_25to59_m"="Male Pop aged 25-59 yrs",
                                "p_60m"="Pop aged 60+ yrs",
                                "p_60m_f"="Female pop aged 60+ yrs",
                                "p_60m_m"="Male pop aged 60+ yrs",
                                "p_mean_chdba"="Avg of children born alive ",
                                "p_nhealth"="Pop without health services",
                                "p_ilit"="Illiterate pop",
                                "p_ilit_f"="Illiterate female pop ",
                                "p_ilit_m"="Illiterate male pop ",
                                "p_6to11nas"="Pop aged 6-11 yrs  who do not go to school",
                                "p_6to11nas_f"="Female pop aged 6-11 yrs who do not go to school",
                                "p_6to11nas_m"="Male pop aged 6-11 yrs who do not go to school",
                                "p_12to14nas"="Pop aged 12-14 yrs who do not go to school",
                                "p_12to14nas_f"="Female pop aged 12-14 yrs who do not go to school",
                                "p_12to14nas_m"="Male pop aged 12-14 yrs who do not go to school",
                                "p_15to17nas"="Pop aged 15-17 who do not go to school",
                                "p_15to17nas_f"="Female pop aged 15-17 yrs who do not go to school",
                                "p_15to17nas_m"="Male pop aged 15-17 yrs who do not go to school",
                                "p_18to24nas"="Pop aged 18-24 yrs who do not go to school",
                                "p_18to24nas_f"="Female pop aged 18-24 yrs who do not go to school",
                                "p_18to24nas_m"="Male pop aged 18-24 yrs who do not go to school",
                                "p_mean_yredu"="Avg number of completed yrs of education ",
                                "p_mean_yredu_f"="Avg number of completed yrs of education of female pop",
                                "p_mean_yredu_m"="Avg number of completed yrs of education of male pop",
                                "p_emp"="Employed pop",
                                "p_emp_f"="Employed female pop",
                                "p_emp_m"="Employed male pop",
                                "p_unem"="Unemployed pop",
                                "p_unem_f"="Unemployed female pop",
                                "p_unem_m"="Unemployed male pop",
                                "p_econia"="Economically inactive pop ",
                                "p_econia_f"="Economically inactive female pop ",
                                "p_econia_m"="Economically inactive male pop ",
                                "p_hh"="Households",
                                "p_hh_f"="Female-headed households  ",
                                "p_hh_m"="Male-headed households  ",
                                "p_langindig"="Speakers of an indigenous language",
                                "p_langindig_f"="Female speakers of an indigenous language",
                                "p_langindig_m"="Male speakers of an indigenous language",
                                "p_disab"="Pop with disabilities",
                                "p_disab_mtr"="Pop with motor disabilities",
                                "p_disab_vis"="Pop with visual disabilities"))

# Geographic levels

## State
census_mexico_state <- census_mexico[census_mexico$locality_name=="Total de la entidad", ]
census_mexico_state <- subset(census_mexico_state , select = -c(municipality_name, locality_name, locality_id_2, ageb_id, block_id) )
census_mexico_state <- census_mexico_state %>% 
  pivot_longer(!c(state_name),
               names_to = "variable",
               values_to = "value") %>% 
  add_column(year = "2020",
             entity_level = "state",
             municipality_name = NA,
             locality_name = NA) %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,variable,year,value)

## Municipality
census_mexico_mun  <- census_mexico[census_mexico$locality_name=="Total del municipio", ]
census_mexico_mun <- subset(census_mexico_mun , select = -c(locality_name, locality_id_2,  ageb_id, block_id) )
census_mexico_mun <- census_mexico_mun %>% 
  pivot_longer(!c(state_name,municipality_name),
               names_to = "variable",
               values_to = "value") %>% 
  add_column(year = "2020",
             entity_level = "Municipality",
             locality_name = NA) %>% 
  dplyr::select(entity_level, state_name, municipality_name, locality_name, variable, year, value)

## Locality
### Locality names
census_mexico <- merge(census_mexico, locality_name2, by = "locality_id_2")
census_mexico <- plyr::rename(census_mexico, c("locality_name.y" = "locality_name"))

census_mexico_loc  <- census_mexico[census_mexico$locality_name.x=="Total de la localidad urbana", ]
census_mexico_loc <- subset(census_mexico_loc, select = -c(locality_id_2, locality_name.x, ageb_id, block_id))

census_mexico_loc <- census_mexico_loc %>% 
  pivot_longer(!c(state_name, municipality_name, locality_name),
               names_to = "variable",
               values_to = "value")%>% 
  add_column(year = "2020",
             entity_level = "Locality") %>% 
  dplyr::select(entity_level, state_name, municipality_name, locality_name, variable, year, value)

## AGEB
census_mexico_ageb  <- census_mexico[census_mexico$locality_name.x=="Total AGEB urbana", ]
#census_mexico_ageb <- filter(census_mexico, locality_name == "Total AGEB urbana")

census_mexico_ageb <- subset(census_mexico_ageb, select = -c(locality_id_2, locality_name.x, block_id))

census_mexico_ageb <- census_mexico_ageb %>% 
  pivot_longer(!c(state_name,municipality_name,locality_name, ageb_id),
               names_to = "variable",
               values_to = "value") %>% 
  add_column(year = "2020",
             entity_level = "ageb") %>% 
  dplyr::select(entity_level,state_name,municipality_name,locality_name,ageb_id,variable,year,value)

## Block
ensus_mexico_block <- filter(census_mexico,  locality_name.x != "Total de la localidad urbana", 
                             locality_name.x != "Total AGEB urbana" ,
                             locality_name.x != "Total del municipio",
                             locality_name.x != "Total de la entidad"
)

census_mexico_block$locality_name <- census_mexico_block$municipality_name
census_mexico_block <- subset(census_mexico_block, select = -c(locality_id_2, locality_name.x))
census_mexico_block <- census_mexico_block %>% 
  tidyr::pivot_longer(!c(state_name, municipality_name, locality_name, ageb_id, block_id),
                      names_to = "variable",
                      values_to = "value") %>% 
  add_column(year = "2020",
             entity_level = "block") %>% 
  dplyr::select(entity_level, state_name, municipality_name,locality_name, 
                ageb_id, block_id, variable, year, value)

## All levels
census_mexico_all_levels = census_mexico_state %>% 
  bind_rows(census_mexico_mun,
            census_mexico_loc,
            census_mexico_ageb,
            census_mexico_block) %>% 
  dplyr::select('Level' = entity_level,
                'State' = state_name,
                'Municipality' = municipality_name,
                'Locality' = locality_name,
                'AGEB' = ageb_id,
                'Block' = block_id,
                'Variable' = variable,
                'Year' = year,
                'Value' = value)


#write.csv(census_mexico_all_levels,data/02_processed-mexico/census_mexico_all_levels_abs.csv",
          #row.names = FALSE, fileEncoding = "UTF-8")


