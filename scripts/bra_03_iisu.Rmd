---
title: "IISU"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls()) # Clear environment
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(reshape2)
library(pander)
library(ggplot2)
library(DT)
library(stringi)
library(RcmdrMisc)
library(ggcorrplot)
library(gridExtra)
library(psych)
library(classInt)

data_format <- function(df) {
  df <- df %>%
    mutate(across(ends_with("_id"), as.character)) %>%
    mutate(across(ends_with("_code"), as.character)) 
  return(df)
}

vars <- c('d_prop_walls_masonry',
            'd_prop_bthrm','d_prop_water_netwk',
            "d_prop_novc",
            'd_prop_garbage_clngsvcs',
            'd_prop_elect',
            'd_prop_inet',
            'd_prop_tv',
            'd_prop_wm','d_prop_refri',
            'd_prop_cp',
            'd_prop_cmp',
            'd_mean_pcincome',
            #'p_prop_6to11as', 
            'p_prop_12to17as', 
            'p_prop_18to24as',
            'p_prop_emp'
)

```

```{r include=FALSE}
df <- fread("01_data/02_proc/02_indicators/wa.csv")

df$reg_code <- factor(df$reg_code)
df$uf_code <-  sprintf("%02d", df$uf_code)
df$mun_code <-  sprintf("%05d", df$mun_code)
df$mun_id <- paste0(df$uf_code, df$mun_code, sep="")

df$mesoreg_code <- sprintf("%02d", df$mesoreg_code)
df$microreg_code <- sprintf("%03d", df$microreg_code)
#df$metro_code <- sprintf("%02d", df$metro_code )

df$wa_id <- sprintf("%013s", df$wa_id)

df <- data_format(df)
```

```{r}
missings <- as.data.frame(colMeans(is.na(df[, ..vars])) * 100)
datatable(missings, caption = "% missings")
```

```{r}
df[, (vars) := lapply(.SD, function(x) ifelse(is.na(x), 0, x)), .SDcols = vars]
missings <- as.data.frame(colMeans(is.na(df[, ..vars])) * 100)
```

# National

# Index
```{r}
rescale_1 <- function(x) (x - min(x)) / (max(x) - min(x)) * 100 #  for positive charges
rescale_2 <- function(x) (x - max(x)) / (min(x) - max(x)) * 100 #  neg
```

```{r}
vars <- c(
  #'d_prop_walls_masonry',
            'd_prop_bthrm','d_prop_water_netwk',
            #"d_prop_novc",
            'd_prop_garbage_clngsvcs',
            'd_prop_elect',
            'd_prop_inet',
            'd_prop_tv',
            'd_prop_wm','d_prop_refri',
            'd_prop_cp',
            'd_prop_cmp',
            'd_mean_pcincome',
            #'p_prop_6to11as', 
            #'p_prop_12to17as', 
            'p_prop_18to24as'
            #'p_prop_emp'
)
pca_nat <- prcomp(select(df, all_of(vars)), scale = TRUE)
print(pca_nat)
summary(pca_nat)

PC <- as.data.frame(pca_nat[2])
PC1_s  <- nrow(PC[PC$rotation.PC1<0,]) # to identify negative charge
pred <- predict(pca_nat, newdata = df) 
pred <- as.data.frame(pred)

df$iisu_nat <- pred$PC1
df$iisu_nat_s <- rescale_1(df$iisu_nat)

# Determine natural breaks
breaks <- classIntervals(df$iisu_nat_s, n = 5, style = "jenks")$brks

# Assign strata based on natural breaks
df$iisu_nat_g <- cut(df$iisu_nat_s, breaks = breaks, include.lowest = TRUE, labels = c("Very low", "Low", "Medium", "High", "Very high"))

# Display the distribution
table(df$iisu_nat_g)
prop.table(table(df$iisu_nat_g))*100
```
añadir codo
# Metropolitan areas

## Between
```{r}
metro_area_codes <- read.csv("01_data/01_raw/boundaries/metro_area10_codes.csv", fileEncoding = "latin1")
#metro_area_codes$mun_id <- as.character(metro_area_codes$mun_id)
metro_area_codes$mun_code <- sprintf("%05d", metro_area_codes$mun_code)

metro_area_codes <- data_format(metro_area_codes)

df <- full_join(metro_area_codes, df, by = c("uf_code", "mun_code", "mun_id"))
```

```{r}
wa_n <- df |> 
  group_by(metro_name) |> summarize(
    n = n(),
    pop_tot = round(sum(d_pop, na.rm = TRUE), 2)
    
    )
datatable(wa_n, caption = "Numer of weighting areas by metropolitan area")
```
```{r}
vars <- c(
  #'d_prop_walls_masonry',
            'd_prop_bthrm',
            #'d_prop_water_netwk',
            #"d_prop_novc",
            'd_prop_garbage_clngsvcs',
            #'d_prop_elect',
            'd_prop_inet',
            'd_prop_tv',
            'd_prop_wm','d_prop_refri',
            'd_prop_cp',
            'd_prop_cmp',
            'd_mean_pcincome',
            #'p_prop_6to11as', 
            #'p_prop_12to17as', 
            'p_prop_18to24as'
            #'p_prop_emp'
)
df_metro1 <- df %>% filter(!is.na(metro_name))

pca_natmetro <- prcomp(select(df_metro1, all_of(vars)), scale = TRUE)
print(pca_natmetro)
summary(pca_natmetro)

PC <- as.data.frame(pca_natmetro[2])
PC1_s  <- nrow(PC[PC$rotation.PC1<0,]) # to identify negative charge
pred <- predict(pca_natmetro, newdata = df_metro1) 
pred <- as.data.frame(pred)

df_metro1$iisu_natmetro <- pred$PC1
df_metro1$iisu_natmetro_s <- rescale_1(df_metro1$iisu_natmetro)

breaks <- classIntervals(df_metro1$iisu_nat_s, n = 5, style = "jenks")$brks


df_metro1$iisu_natmetro_g <- cut(df_metro1$iisu_natmetro_s, breaks = breaks, include.lowest = TRUE, labels = c("Very low", "Low", "Medium", "High", "Very high"))

table(df_metro1$iisu_natmetro_g)
prop.table(table(df_metro1$iisu_natmetro_g))*100

```


## Within

bye, bye:
38	RM Sudoeste Maranhense	19
28	RM Macapá	22
27	RM Londrina	23
1	Aglomeração Urbana do Litoral Norte - Rio Grande do Sul	24
40	RM Tubarão	27
16	RM Cariri	28
9	RM Aracaju	29
21	RM Foz do Rio Itajaí	29

P.S. Since 2010, Brazil has seen the creation of 28 new municipal districts. These additions were officially recorded in the most recent update by the Brazilian Institute of Geography and Statistics (IBGE) in 2022. The new districts were distributed across several states:
Minas Gerais: 16 new districts
Pernambuco: 9 new districts
Amazonas: 1 new district
Rondônia: 1 new district
Mato Grosso: 1 new district
In addition to these new districts, there were also changes in the existing municipal structure, including the extinction of 7 districts and the creation of 12 sub-districts.
Overall, the total number of municipalities in Brazil has remained stable at 5,568 since 2013, despite the creation of new districts and sub-districts.

Also, in the new metropolitan areas, a municipality can be in 2 metro areas

```{r}
# Create directories 
dir.create("01_data/02_proc/03_iisu/metro", showWarnings = FALSE)
dir.create("01_data/02_proc/03_iisu/metro/index", showWarnings = FALSE)
dir.create("01_data/02_proc/03_iisu/metro/PCA", showWarnings = FALSE)
dir_path = "01_data/02_proc/03_iisu/metro/index/"
dir_path_2 = "01_data/02_proc/03_iisu/metro/PCA/"

sanitize_file_name <- function(name) {
  name %>%
    gsub("[/\\:*?\"<>|]", "_", .) %>%  
    gsub("\\s+", "_", .) %>%           
    gsub("\\(", "", .) %>%             
    gsub("\\)", "", .)                
}

# Filter metros with more than 29 unique wa_id
metros <- df %>%
  group_by(metro_name) %>%
  summarise(unique_wa_id_count = n_distinct(wa_id)) %>%
  filter(unique_wa_id_count > 29) %>%
  pull(metro_name)

for (i in 1:length(metros)) {
  
  metro_i = metros[i]
  
  df_2 = df %>% 
    filter(metro_name == metro_i) %>%
    drop_na(all_of(vars))  # Omit rows with NAs in the relevant columns
  
  if (nrow(df_2) == 0) {
    next  # Skip the rest of the loop if df_2 is empty after omitting NAs
  }
  
  pca_metro <- prcomp(select(df_2, all_of(vars)), scale = TRUE)

  PC <- as.data.frame(pca_metro$rotation[, 1:3])
  PC1_s  <- nrow(PC[PC$rotation.PC1 < 0,])
  
  pred <- predict(pca_metro, newdata = df_2)
  pred <- as.data.frame(pred)
  
  df_2$iisu_metro <- pred$PC1

  df_2$iisu_metro_s <- if (PC1_s == 0) {
    rescale_1(df_2$iisu_metro)
  } else {
    rescale_2(df_2$iisu_metro)
  }

  # Add a small jitter to ensure unique breaks
  df_2$iisu_metro_s <- jitter(df_2$iisu_metro_s)

  breaks <- classIntervals(df_2$iisu_metro_s, n = 5, style = "jenks")$brks
  
  if (length(unique(breaks)) < length(breaks)) {
    breaks <- unique(breaks)
  }
  
  if (length(breaks) != 6) {
    breaks <- classIntervals(df_2$iisu_metro_s, n = 5, style = "equal")$brks
  }

  df_2$iisu_metro_g <- cut(df_2$iisu_metro_s, breaks = breaks, include.lowest = TRUE, labels = c("Very low", "Low", "Medium", "High", "Very high"))
  
  PC <- as.data.frame(pca_metro$rotation[, 1:3])
  colnames(PC) <- paste0("PC_", 1:3)
  PC$indicators <- rownames(pca_metro$rotation)
  PC$metro <- metro_i
  
  PC <- select(PC, metro, indicators, PC_1, PC_2, PC_3)

  # Sanitize metro_i for file names
  metro_i_sanitized <- sanitize_file_name(metro_i)

  write.csv(df_2,
            file = file.path(dir_path, paste0(metro_i_sanitized, ".csv")),
            fileEncoding = "latin1", row.names = FALSE)
            
  write.csv(PC,
            file = file.path(dir_path_2, paste0(metro_i_sanitized, ".csv")),
            fileEncoding = "latin1", row.names = FALSE)
}
```

## Verificar
```{r PCA loads join}
dir_path = "01_data/02_proc/03_iisu/metro/PCA/"

# Get the list of CSV files in the directory
csv_files <- list.files(dir_path, pattern = "\\.csv$", full.names = TRUE)

# Initialize an empty data frame to store the combined data
pca_loads <- data.frame()

# Loop through each CSV file and rbind the data
for (file in csv_files) {
  data <- read.csv(file, stringsAsFactors = FALSE)
  pca_loads <- rbind(pca_loads, data)
}

fwrite(pca_loads,
       "01_data/02_proc/03_iisu/metro/PCA/metro-PCAloads.csv",
        row.names = FALSE)
```

# PCA 
```{r PC1 directions, message=FALSE}
directions <- pca_loads %>%
  group_by(metro) %>%
  summarize(
    positive_count = sum(PC_1 > 0),
    negative_count = sum(PC_1 < 0)
  ) %>% 
   filter(positive_count > 0, negative_count > 0) 
# Print the result
print(directions)

directions_problm <- directions$metro

if (length(directions_problm) == 0) {
  cat("For PC1, all indicators across all metros exhibit consistent loading directions.\n")
} else {
  # Filter the data only if metro_names_problm is not empty
  pca_loads_subset <- filter(pca_loads,
                                 metro %in% directions_problm)
 print(pca_loads_subset)
}

```


```{r}
# Define the custom function
read_all_csv <- function(base_dir) {
  # Get a list of all CSV files in the directory
  file_list <- list.files(base_dir, pattern = "\\.csv$", full.names = TRUE)
  
  # Read each CSV file and store in a list
   df_list <- lapply(file_list, function(file) read.csv(file, fileEncoding = "latin1"))
  
  # Find the union of all column names
  all_columns <- Reduce(union, lapply(df_list, colnames))
  
  # Ensure all data frames have the same columns
  df_list <- lapply(df_list, function(df) {
    df <- df %>% select(all_of(all_columns), everything())
    df[setdiff(all_columns, colnames(df))] <- NA
    return(df)
  })
  
  # Combine all data frames into one
  combined_df <- bind_rows(df_list)
  
  return(combined_df)
}

# Use the function to read all CSV files
base_dir <- "01_data/02_proc/03_iisu/metro/index"
df_metro <- read_all_csv(base_dir)
```

```{r}
df_metro$iisu_metro_g <- factor(df_metro$iisu_metro_g,
                                levels = c("Very low", "Low", "Medium", "High", "Very high"),
                                labels = c("Very low", "Low", "Medium", "High", "Very high")
                                )
table(df_metro$iisu_metro_g)
prop.table(table(df_metro$iisu_metro_g))*100
```
```{r}
df_metro1 <- select(df_metro1,
                   wa_id,iisu_natmetro, iisu_natmetro_s, iisu_natmetro_g
                   )

df_metro1$wa_id <- as.character(df_metro1$wa_id)

df_metro <- select(df_metro,
                   wa_id,iisu_metro, iisu_metro_s, iisu_metro_g
                   )

df_metro$wa_id <- as.character(df_metro$wa_id)
```

```{r}
df <- full_join(df, df_metro1, by="wa_id")

df_final <- full_join(df, df_metro, by="wa_id")
```

```{r}
write.csv(df_final, "01_data/02_proc/02_indicators/wa_index.csv", 
      row.names = FALSE, fileEncoding="latin1")
```

```{r}
shp <- st_read("01_data/01_raw/boundaries/wa.geojson")
shp <- select(shp, 
              name_muni, code_weighting, geometry
              )
names(shp) <- c("mun_name", "wa_id", "geometry")
```

```{r}
census_geo <- full_join(shp, df_final, by="wa_id")

st_write(census_geo, "01_data/02_proc/03_iisu/wa.geojson", , delete_dsn = TRUE)
```



