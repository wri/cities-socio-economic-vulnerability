# set up ------------------------------------------------------------------
rm(list=ls())
library(data.table)
library(tidyverse)
library(srvyr)
library(sf)
# aws keys
Sys.setenv(
  "AWS_ACCESS_KEY_ID" = "KEY_ID",
  "AWS_SECRET_ACCESS_KEY" = "ACCESS_KEY",
  "AWS_DEFAULT_REGION" = "REGION")
# data --------------------------------------------------------------------
dwg <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/brazil/dwg_full_r.csv")  %>% rename_all(tolower)
dwg$d_dwg <- 1
dwg_srvyr <- dwg %>% as_survey_design(weights=v0010)

pop <- data.table::fread("https://cities-socio-economic-vulnerability.s3.eu-west-3.amazonaws.com/data/raw/brazil/pop_full_r.csv")  %>% rename_all(tolower)
pop$p_tot <- 1
pop_srvyr <- pop %>% as_survey_design(weights=v0010) 
# 0. National -------------------------------------------------------------
nat_abs_d <- dwg_srvyr %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

nat_per_d <- dwg_srvyr %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))
     
nat_abs_p <- pop_srvyr %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))
## population
nat_per_p <- pop_srvyr %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

nat_abs <- cbind(nat_abs_d, nat_abs_p)    
nat_per <- cbind(nat_per_d, nat_per_p)     

nat <- cbind(nat_abs, nat_per)
## add parameters
nat <- nat %>% mutate(year= "2010", level = "national", 
                      reg_id = "", reg_name = "",
                      state_id="", state_name="", 
                      mesoreg_id = "", mesoreg_name = "", 
                      microreg_id = "", microreg_name ="",
                      municipality_id ="", municipality_name="",
                      weighting_area_id ="")

## rear and save
nat = select(nat,
             level, year, reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
             d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
             d_mean_rv,d_mean_rv_cv,
             d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
             d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
             d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
             d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
             d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
             d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
             d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
             d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
             d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
             d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
             d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
             d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
             d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
             p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
             p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
             p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
             p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
             p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
             p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
             p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
             p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
             p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
             p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
             p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

nat_vars = nat %>% select(-matches("cv"))
nat_cv = nat %>% select(matches("cv"))

fwrite(nat, "aws/data/dev/brazil/census/census_brazil_national_2010_all.csv", row.names = FALSE)

fwrite(nat_vars, "aws/data/dev/brazil/census/census_brazil_national_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_national_2010.csv",
           object = "data/dev/brazil/census/census_brazil_national_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(nat_cv, "aws/data/dev/brazil/census/census_brazil_national_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_national_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_national_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")


# 1. Region ---------------------------------------------------------------
## dwellings
reg_abs_d <- dwg_srvyr %>%
  group_by(v1001) %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

reg_per_d <- dwg_srvyr %>%
  group_by(v1001) %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))

## population
reg_abs_p <- pop_srvyr %>%
  group_by(v1001) %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

reg_per_p <- pop_srvyr %>%
  group_by(v1001) %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

reg_abs <- merge(reg_abs_d, reg_abs_p, by = "v1001") 
reg_per <- merge(reg_per_d, reg_per_p, by = "v1001")

reg <- merge(reg_abs, reg_per, by = "v1001")

## add parameters
reg <- reg %>% mutate(year= "2010", level = "region", 
                      #reg_id = "", reg_name = "",
                      state_id="", state_name="",
                      mesoreg_id = "", mesoreg_name = "", 
                      microreg_id = "", microreg_name ="",
                      municipality_id ="", municipality_name="",
                      weighting_area_id ="")

## rear and save
reg = select(reg,
             level, year, reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
             d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
             d_mean_rv,d_mean_rv_cv,
             d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
             d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
             d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
             d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
             d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
             d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
             d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
             d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
             d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
             d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
             d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
             d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
             d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
             p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
             p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
             p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
             p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
             p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
             p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
             p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
             p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
             p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
             p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
             p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

reg_vars = reg %>% select(-matches("cv"))
reg_cv = reg %>% select(matches("cv"))

fwrite(reg, "aws/data/dev/brazil/census/census_brazil_region_2010_all.csv", row.names = FALSE)

fwrite(reg_vars, "aws/data/dev/brazil/census/census_brazil_region_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_region_2010.csv",
           object = "data/dev/brazil/census/census_brazil_region_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(reg_cv, "aws/data/dev/brazil/census/census_brazil_region_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_region_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_region_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

# 2. UF -------------------------------------------------------------------
## dwellings
uf_abs_d <- dwg_srvyr %>%
  group_by(v0001) %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

uf_per_d <- dwg_srvyr %>%
  group_by(v0001) %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))

## population
uf_abs_p <- pop_srvyr %>%
  group_by(v0001) %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

uf_per_p <- pop_srvyr %>%
  group_by(v0001) %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

uf_abs <- merge(uf_abs_d, uf_abs_p, by = "v0001")
uf_per <- merge(uf_per_d, uf_per_p, by = "v0001")

uf <- merge(uf_abs, uf_per, by = "v0001")
## add parameters
uf <- uf %>% mutate(year= "2010", level = "state", 
                    #reg_id = "", reg_name = "",
                    #state_id="", state_name="",
                    mesoreg_id = "", mesoreg_name = "", 
                    microreg_id = "", microreg_name ="",
                    municipality_id ="", municipality_name="",
                    weighting_area_id ="")

## rear and save
uf = select(uf,
            level, year,reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
            d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
            d_mean_rv,d_mean_rv_cv,
            d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
            d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
            d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
            d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
            d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
            d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
            d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
            d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
            d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
            d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
            d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
            d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
            d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
            p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
            p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
            p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
            p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
            p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
            p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
            p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
            p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
            p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
            p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
            p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

uf_vars = uf %>% select(-matches("cv"))
uf_cv = uf %>% select(matches("cv"))

fwrite(uf, "01_data/02_proc/census_brazil_state_2010_all.csv")
fwrite(uf_vars, "01_data/02_proc/census_brazil_state_2010.csv")
fwrite(uf_cv, "01_data/02_proc/census_brazil_state_2010_cv.csv")

fwrite(uf, "aws/data/dev/brazil/census/census_brazil_state_2010_all.csv", row.names = FALSE)

fwrite(uf_vars, "aws/data/dev/brazil/census/census_brazil_state_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_state_2010.csv",
           object = "data/dev/brazil/census/census_brazil_state_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(uf_cv, "aws/data/dev/brazil/census/census_brazil_state_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_state_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_state_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
# 3. Mesoreg -----------------------------------------------------------
## dwellings
mes_abs_d <- dwg_srvyr %>%
  group_by(v1002) %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

mes_per_d <- dwg_srvyr %>%
  group_by(v1002) %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))

## population
mes_abs_p <- pop_srvyr %>%
  group_by(v1002) %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

mes_per_p <- pop_srvyr %>%
  group_by(v1002) %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

mes_abs <- merge(mes_abs_d, mes_abs_p, by = "v1002")
mes_per <- merge(mes_per_d, mes_per_p, by = "v1002")

mes <- merge(mes_abs, mes_per, by = "v1002")

## add parameters
mes <- mes %>% mutate(year= "2010", level = "mesoregion", 
                      #reg_id = "", reg_name = "", 
                      #state_id="", state_name="",
                      #mesoreg_id = "", mesoreg_name = "", 
                      microreg_id = "", microreg_name ="",
                      municipality_id ="", municipality_name="",
                      weighting_area_id ="")
###########Região Metropolitana
## rear and save
mes = select(mes,
             level, year,reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
             d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
             d_mean_rv,d_mean_rv_cv,
             d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
             d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
             d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
             d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
             d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
             d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
             d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
             d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
             d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
             d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
             d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
             d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
             d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
             p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
             p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
             p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
             p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
             p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
             p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
             p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
             p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
             p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
             p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
             p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

mes_vars = mes %>% select(-matches("cv"))
mes_cv = mes %>% select(matches("cv"))

fwrite(mes, "01_data/02_proc/census_brazil_mesoreg_2010_all.csv")
fwrite(mes_vars, "01_data/02_proc/census_brazil_mesoreg_2010.csv")
fwrite(mes_cv, "01_data/02_proc/census_brazil_mesoreg_2010_cv.csv")

fwrite(mes, "aws/data/dev/brazil/census/census_brazil_mesoreg_2010_all.csv", row.names = FALSE)

fwrite(mes_vars, "aws/data/dev/brazil/census/census_brazil_mesoreg_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_mesoreg_2010.csv",
           object = "data/dev/brazil/census/census_brazil_mesoreg_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(mes_cv, "aws/data/dev/brazil/census/census_brazil_mesoreg_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_mesoreg_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_mesoreg_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
# 4. Microreg ----------------------------------------------------------
## dwellings
mic_abs_d <- dwg_srvyr %>%
  group_by(v1003) %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

mic_per_d <- dwg_srvyr %>%
  group_by(v1003) %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))

## population
mic_abs_p <- pop_srvyr %>%
  group_by(v1003) %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

mic_per_p <- pop_srvyr %>%
  group_by(v1003) %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

mic_abs <- merge(mic_abs_d, mic_abs_p, by = "v1003")
mic_per <- merge(mic_per_d, mic_per_p, by = "v1003")

mic <- merge(mic_abs, mic_per, by = "v1003")

## add parameters
mic <- mic %>% mutate(year= "2010", level = "microregion", 
                      #reg_id = "", reg_name = "", 
                      #state_id="", state_name="",
                      #mesoreg_id = "", mesoreg_name = "", 
                      #microreg_id = "", microreg_name ="",
                      municipality_id ="", municipality_name="",
                      weighting_area_id ="")
###########Região Metropolitana

## rear and save
mic = select(mic,
             level, year,reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
             d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
             d_mean_rv,d_mean_rv_cv,
             d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
             d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
             d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
             d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
             d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
             d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
             d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
             d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
             d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
             d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
             d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
             d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
             d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
             p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
             p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
             p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
             p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
             p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
             p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
             p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
             p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
             p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
             p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
             p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

mic_vars = mic %>% select(-matches("cv"))
mic_cv = mic %>% select(matches("cv"))

fwrite(mic, "01_data/02_proc/census_brazil_microreg_2010_all.csv")
fwrite(mic_vars, "01_data/02_proc/census_brazil_microreg_2010.csv")
fwrite(mic_cv, "01_data/02_proc/census_brazil_microreg_2010_cv.csv")


fwrite(mic, "aws/data/dev/brazil/census/census_brazil_microreg_2010_all.csv", row.names = FALSE)

fwrite(mic_vars, "aws/data/dev/brazil/census/census_brazil_microreg_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_microreg_2010.csv",
           object = "data/dev/brazil/census/census_brazil_microreg_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(mic_cv, "aws/data/dev/brazil/census/census_brazil_microreg_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_microreg_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_microreg_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")
# 5. Municipality ---------------------------------------------------------
## dwellings
mun_abs_d <- dwg_srvyr %>%
  group_by(v0002) %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

mun_per_d <- dwg_srvyr %>%
  group_by(v0002) %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))

## population
mun_abs_p <- pop_srvyr %>%
  group_by(v0002) %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

mun_per_p <- pop_srvyr %>%
  group_by(v0002) %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

mun_abs <- merge(mun_abs_d, mun_abs_p, by = "v0002")
mun_per <- merge(mun_per_d, mun_per_p, by = "v0002")

mun <- merge(mun_abs, mun_per, by = "v0002")

## add parameters
mun <- mun %>% mutate(year= "2010", level = "municipality", 
                      #reg_id = "", reg_name = "", 
                      #state_id="", state_name="",
                      #mesoreg_id = "", mesoreg_name = "", 
                      #microreg_id = "", microreg_name ="",
                      #municipality_id ="", municipality_name="",
                      weighting_area_id ="")
## rear and save
mun = select(mun,
             level, year,reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
             d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
             d_mean_rv,d_mean_rv_cv,
             d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
             d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
             d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
             d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
             d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
             d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
             d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
             d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
             d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
             d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
             d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
             d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
             d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
             p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
             p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
             p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
             p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
             p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
             p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
             p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
             p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
             p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
             p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
             p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

mun_vars = mun %>% select(-matches("cv"))
mun_cv = mun %>% select(matches("cv"))

fwrite(mun, "aws/data/dev/brazil/census/census_brazil_municipality_2010_all.csv", row.names = FALSE)

fwrite(mun_vars, "aws/data/dev/brazil/census/census_brazil_municipality_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_municipality_2010.csv",
           object = "data/dev/brazil/census/census_brazil_municipality_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(mun_cv, "aws/data/dev/brazil/census/census_brazil_municipality_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_municipality_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_municipality_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

# 6. WA -------------------------------------------------------------------
## dwellings
wa_abs_d <- dwg_srvyr %>%
  group_by(v0011) %>%
  summarize(across(c(d_dwg, d_owned:d_ncar), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

wa_per_d <- dwg_srvyr %>%
  group_by(v0011) %>%
  summarize(
    d_prop_owned= survey_mean(d_owned , vartype =  "cv", na.rm=TRUE),
    d_prop_rented= survey_mean(d_rented , vartype =  "cv", na.rm=TRUE),
    d_prop_loaned= survey_mean(d_loaned , vartype =  "cv", na.rm=TRUE),
    d_prop_other = survey_mean(d_other, vartype =  "cv", na.rm=TRUE),
    d_mean_rv= survey_mean(v2011 , vartype =  "cv", na.rm=TRUE),
    d_prop_nwalls= survey_mean(d_nwalls , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_masonry= survey_mean(d_walls_masonry , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_wood= survey_mean(d_walls_wood , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_rearth= survey_mean(d_walls_rearth , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_straw= survey_mean(d_walls_straw , vartype =  "cv", na.rm=TRUE),
    d_prop_walls_other= survey_mean(d_walls_other , vartype =  "cv", na.rm=TRUE),
    d_prop_1rm= survey_mean(d_1rm , vartype =  "cv", na.rm=TRUE),
    d_prop_2rms= survey_mean(d_2rms , vartype =  "cv", na.rm=TRUE),
    d_prop_3mrms= survey_mean(d_3mrms , vartype =  "cv", na.rm=TRUE),
    d_mean_rm_occup= survey_mean(v6203 , vartype =  "cv", na.rm=TRUE),
    d_prop_1bedrm= survey_mean(d_1bedrm , vartype =  "cv", na.rm=TRUE),
    d_prop_2mbedrms= survey_mean(d_2mbedrms , vartype =  "cv", na.rm=TRUE),
    d_mean_br_occup= survey_mean(v6204 , vartype =  "cv", na.rm=TRUE),
    d_prop_ntoil= survey_mean(d_ntoil , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_sewage= survey_mean(d_ss_sewage , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_pit= survey_mean(d_ss_pit , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_ditch= survey_mean(d_ss_ditch , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_river= survey_mean(d_ss_river , vartype =  "cv", na.rm=TRUE),
    d_prop_ss_other= survey_mean(d_ss_other , vartype =  "cv", na.rm=TRUE),
    d_prop_water_network= survey_mean(d_water_network , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_in= survey_mean(d_water_well_in , vartype =  "cv", na.rm=TRUE),
    d_prop_water_well_out = survey_mean(d_water_well_out  , vartype =  "cv", na.rm=TRUE),
    d_prop_water_wtruck= survey_mean(d_water_wtruck , vartype =  "cv", na.rm=TRUE),
    d_prop_water_rain= survey_mean(d_water_rain , vartype =  "cv", na.rm=TRUE),
    d_prop_water_river= survey_mean(d_water_river , vartype =  "cv", na.rm=TRUE),
    d_prop_water_other= survey_mean(d_water_other , vartype =  "cv", na.rm=TRUE),
    d_prop_npwater= survey_mean(d_npwater , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_burnt= survey_mean(d_garbage_burnt , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_buried= survey_mean(d_garbage_buried , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_throwed= survey_mean(d_garbage_throwed , vartype =  "cv", na.rm=TRUE),
    d_prop_garbage_other= survey_mean(d_garbage_other , vartype =  "cv", na.rm=TRUE),
    d_prop_nelect= survey_mean(d_nelect , vartype =  "cv", na.rm=TRUE),
    d_prop_ntv= survey_mean(d_ntv , vartype =  "cv", na.rm=TRUE),
    d_prop_nwm= survey_mean(d_nwm , vartype =  "cv", na.rm=TRUE),
    d_prop_nrefri= survey_mean(d_nrefri , vartype =  "cv", na.rm=TRUE),
    d_prop_ncp= survey_mean(d_ncp , vartype =  "cv", na.rm=TRUE),
    d_prop_ncmp= survey_mean(d_ncmp , vartype =  "cv", na.rm=TRUE),
    d_prop_ninet= survey_mean(d_ninet , vartype =  "cv", na.rm=TRUE),
    d_prop_nmtrcl= survey_mean(d_nmtrcl , vartype =  "cv", na.rm=TRUE),
    d_prop_ncar= survey_mean(d_ncar , vartype =  "cv", na.rm=TRUE),
    d_mean_income = survey_mean(v6529, vartype =  "cv", na.rm=TRUE),
    d_mean_pcincome = survey_mean(v6531, vartype =  "cv", na.rm=TRUE))

## population
wa_abs_p <- pop_srvyr %>%
  group_by(v0011) %>%
  summarize(across(c(p_tot, p_tot_m:p_econa_m), 
                   ~survey_total(.x, vartype = "cv", na.rm = TRUE)))

wa_per_p <- pop_srvyr %>%
  group_by(v0011) %>%
  summarize(p_prop_m_f= survey_mean(p_tot_m , vartype =  "cv", na.rm=TRUE),
            p_prop_tdr= survey_mean(p_tdr , vartype =  "cv", na.rm=TRUE),
            p_prop_chddr= survey_mean(p_chddr , vartype =  "cv", na.rm=TRUE),
            p_prop_olddr= survey_mean(p_olddr , vartype =  "cv", na.rm=TRUE),
            p_prop_wht= survey_mean(p_wht , vartype =  "cv", na.rm=TRUE),
            p_prop_black= survey_mean(p_black , vartype =  "cv", na.rm=TRUE),
            p_prop_yellow= survey_mean(p_yellow , vartype =  "cv", na.rm=TRUE),
            p_prop_brown= survey_mean(p_brown , vartype =  "cv", na.rm=TRUE),
            p_prop_indig= survey_mean(p_indig , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit= survey_mean(p_ilit , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_f= survey_mean(p_ilit_f , vartype =  "cv", na.rm=TRUE),
            p_prop_ilit_m= survey_mean(p_ilit_m , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas= survey_mean(p_6to11nas , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_f= survey_mean(p_6to11nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_6to11nas_m= survey_mean(p_6to11nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas= survey_mean(p_12to14nas , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_f= survey_mean(p_12to14nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_12to14nas_m= survey_mean(p_12to14nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas= survey_mean(p_15to17nas , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_f= survey_mean(p_15to17nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_15to17nas_m= survey_mean(p_15to17nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas= survey_mean(p_18to24nas , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_f= survey_mean(p_18to24nas_f , vartype =  "cv", na.rm=TRUE),
            p_prop_18to24nas_m= survey_mean(p_18to24nas_m , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_f= survey_mean(p_unem_f , vartype =  "cv", na.rm=TRUE),
            p_prop_unem_m= survey_mean(p_unem_m , vartype =  "cv", na.rm=TRUE))

wa_abs <- merge(wa_abs_d, wa_abs_p, by = "v0011")
wa_per <- merge(wa_per_d, wa_per_p, by = "v0011")

wa <- merge(wa_abs, wa_per, by = "v0011")

## add parameters
wa <- wa %>% mutate(year= "2010", level = "weighting area" 
                      #reg_id = "", reg_name = "", 
                      #state_id="", state_name="",
                      #mesoreg_id = "", mesoreg_name = "", 
                      #microreg_id = "", microreg_name ="",
                      #municipality_id ="", municipality_name="",
                      #weighting_area_id =""
                    )

## rear and save
wa = select(wa,
            level, year, reg_id, reg_name, state_id, state_name, mesoreg_id, mesoreg_name, microreg_id, microreg_name, municipality_id , municipality_name, weighting_area_id, 
            d_dwg, d_dwg_cv,d_owned,d_owned_cv,d_prop_owned,d_prop_owned_cv,d_rented,d_rented_cv,d_prop_rented,d_prop_rented_cv,d_loaned,d_loaned_cv,d_prop_loaned,d_prop_loaned_cv,d_other,d_other_cv,d_prop_other,d_prop_other_cv,
            d_mean_rv,d_mean_rv_cv,
            d_nwalls,d_nwalls_cv,d_prop_nwalls,d_prop_nwalls_cv,d_walls_masonry,d_walls_masonry_cv,d_prop_walls_masonry,d_prop_walls_masonry_cv,d_walls_wood,d_walls_wood_cv,d_prop_walls_wood,d_prop_walls_wood_cv,d_walls_rearth,d_walls_rearth_cv,
            d_prop_walls_rearth,d_prop_walls_rearth_cv,d_walls_straw,d_walls_straw_cv,d_prop_walls_straw,d_prop_walls_straw_cv,d_walls_other,d_walls_other_cv,d_prop_walls_other,d_prop_walls_other_cv,
            d_1rm,d_1rm_cv,d_prop_1rm,d_prop_1rm_cv,d_2rms,d_2rms_cv,d_prop_2rms,d_prop_2rms_cv,d_3mrms,d_3mrms_cv,d_prop_3mrms,d_prop_3mrms_cv,d_1bedrm,d_1bedrm_cv,d_mean_rm_occup,d_mean_rm_occup_cv,
            d_1bedrm,d_1bedrm_cv,d_prop_1bedrm,d_prop_1bedrm_cv,d_2mbedrms,d_2mbedrms_cv,d_prop_2mbedrms,d_prop_2mbedrms_cv,d_mean_br_occup,d_mean_br_occup_cv,
            d_ntoil,d_ntoil_cv,d_ntoil,d_ntoil_cv,d_prop_ntoil,d_prop_ntoil_cv,d_ss_sewage,d_ss_sewage_cv,d_prop_ss_sewage,d_prop_ss_sewage_cv,d_ss_pit,d_ss_pit_cv,d_prop_ss_pit,d_prop_ss_pit_cv,
            d_ss_ditch,d_ss_ditch_cv,d_prop_ss_ditch,d_prop_ss_ditch_cv,d_ss_river,d_ss_river_cv,d_prop_ss_river,d_prop_ss_river_cv,d_ss_other,d_ss_other_cv,d_prop_ss_other,d_prop_ss_other_cv,d_water_network,d_water_network_cv,d_prop_water_network,
            d_prop_water_network_cv,d_water_well_in,d_water_well_in_cv,d_prop_water_well_in,d_prop_water_well_in_cv,d_water_well_out,d_water_well_out_cv,d_prop_water_well_out,d_prop_water_well_out_cv,d_water_wtruck,d_water_wtruck_cv,
            d_prop_water_wtruck,d_prop_water_wtruck_cv,d_water_rain,d_water_rain_cv,d_prop_water_rain,d_prop_water_rain_cv,d_water_river,d_water_river_cv,d_prop_water_river,d_prop_water_river_cv,d_water_other,d_water_other_cv,d_prop_water_other,
            d_prop_water_other_cv,d_npwater,d_npwater_cv,d_prop_npwater,d_prop_npwater_cv,d_garbage_clngsvcs,d_garbage_clngsvcs_cv,d_prop_garbage_burnt,d_prop_garbage_burnt_cv,d_garbage_burnt,d_garbage_burnt_cv,d_prop_garbage_burnt,
            d_prop_garbage_burnt_cv,d_garbage_buried,d_garbage_buried_cv,d_prop_garbage_buried,d_prop_garbage_buried_cv,d_garbage_throwed,d_garbage_throwed_cv,d_prop_garbage_throwed,d_prop_garbage_throwed_cv,d_garbage_other,
            d_garbage_other_cv,d_prop_garbage_other,d_prop_garbage_other_cv,d_nelect,d_nelect_cv,d_prop_nelect,d_prop_nelect_cv,d_ntv,d_ntv_cv,d_prop_ntv,d_prop_ntv_cv,d_nwm,d_nwm_cv,d_prop_nwm,d_prop_nwm_cv,d_nrefri,d_nrefri_cv,d_prop_nrefri,
            d_prop_nrefri_cv,d_ncp,d_ncp_cv,d_prop_ncp,d_prop_ncp_cv,d_ncmp,d_ncmp_cv,d_prop_ncmp,d_prop_ncmp_cv,d_ninet,d_ninet_cv,d_prop_ninet,d_prop_ninet_cv,d_nmtrcl,d_nmtrcl_cv,d_prop_nmtrcl,d_prop_nmtrcl_cv,d_ncar,d_ncar_cv,d_prop_ncar,
            d_prop_ncar_cv,d_mean_income,d_mean_income_cv,d_mean_pcincome,d_mean_pcincome_cv,p_tot,p_tot_cv,p_tot_m,p_tot_m_cv,p_tot_f,p_tot_f_cv,p_prop_m_f,p_prop_m_f_cv,
            p_0to2,p_0to2_cv,p_0to2_f,p_0to2_f_cv,p_0to2_m,p_0to2_m_cv,p_3to5,p_3to5_cv,p_3to5_f,p_3to5_f_cv,p_3to5_m,p_3to5_m_cv,p_6to11,p_6to11_cv,p_6to11_f,p_6to11_f_cv,p_6to11_m,p_6to11_m_cv,
            p_12to14,p_12to14_cv,p_12to14_f,p_12to14_f_cv,p_12to14_m,p_12to14_m_cv,p_15to17,p_15to17_cv,p_15to17_f,p_15to17_f_cv,p_15to17_m,p_15to17_m_cv,p_18to24,p_18to24_cv,p_18to24_f,p_18to24_f_cv,
            p_18to24_m,p_18to24_m_cv,p_25to64,p_25to64_cv,p_25to64_f,p_25to64_f_cv,p_25to64_m,p_25to64_m_cv,p_65m,p_65m_cv,p_65m_f,p_65m_f_cv,p_65m_m,p_65m_m_cv,p_prop_tdr,p_prop_tdr_cv,p_prop_chddr,p_prop_chddr_cv,p_prop_olddr,
            p_prop_olddr_cv,p_wht,p_wht_cv,p_prop_wht,p_prop_wht_cv,p_black,p_black_cv,p_prop_black,p_prop_black_cv,p_yellow, p_yellow_cv, p_prop_yellow, p_prop_yellow_cv,
            p_brown,p_brown_cv,p_prop_brown,p_prop_brown_cv,p_indig,p_indig_cv,p_prop_indig,p_prop_indig_cv,
            p_disab,p_disab_cv,p_disab_mtr,p_disab_mtr_cv,p_disab_vis,p_disab_vis_cv,p_ilit,p_ilit_cv,p_prop_ilit,p_prop_ilit_cv,p_ilit_f,p_ilit_f_cv,p_prop_ilit_f,p_prop_ilit_f_cv,p_ilit_m,p_ilit_m_cv,p_prop_ilit_m,p_prop_ilit_m_cv,
            p_6to11nas,p_6to11nas_cv,p_prop_6to11nas,p_prop_6to11nas_cv,p_6to11nas_f,p_6to11nas_f_cv,p_prop_6to11nas_f,p_prop_6to11nas_f_cv,p_6to11nas_m,p_6to11nas_m_cv,p_prop_6to11nas_m,p_prop_6to11nas_m_cv,p_12to14nas,p_12to14nas_cv,
            p_prop_12to14nas,p_prop_12to14nas_cv,p_12to14nas_f,p_12to14nas_f_cv,p_prop_12to14nas_f,p_prop_12to14nas_f_cv,p_12to14nas_m,p_12to14nas_m_cv,p_prop_12to14nas_m,p_prop_12to14nas_m_cv,p_15to17nas,p_15to17nas_cv,p_prop_15to17nas,
            p_prop_15to17nas_cv,p_15to17nas_f,p_15to17nas_f_cv,p_prop_15to17nas_f,p_prop_15to17nas_f_cv,p_15to17nas_m,p_15to17nas_m_cv,p_prop_15to17nas_m,p_prop_15to17nas_m_cv,p_18to24nas,p_18to24nas_cv,p_prop_18to24nas,p_prop_18to24nas_cv,
            p_18to24nas_f,p_18to24nas_f_cv,p_prop_18to24nas_f,p_prop_18to24nas_f_cv,p_18to24nas_m,p_18to24nas_m_cv,p_prop_18to24nas_m,p_prop_18to24nas_m_cv,p_emp,p_emp_cv,p_emp_f,p_emp_f_cv,p_emp_m,p_emp_m_cv,p_unem,p_unem_cv,p_unem_f,
            p_unem_f_cv,p_unem_m,p_unem_m_cv,p_prop_unem_f,p_prop_unem_f_cv,p_prop_unem_m,p_prop_unem_m_cv,p_econia,p_econia_cv,p_econia_f,p_econia_f_cv,p_econia_m,p_econia_m_cv,p_econa,p_econa_cv,p_econa_f,p_econa_f_cv,p_econa_m,p_econa_m_cv)

wa_vars = wa %>% select(-matches("cv"))
wa_cv = wa %>% select(matches("cv"))

fwrite(wa, "aws/data/dev/brazil/census/census_brazil_weighting_area_2010_all.csv", row.names = FALSE)

fwrite(wa_vars, "aws/data/dev/brazil/census/census_brazil_weighting_area_2010.csv")

put_object(file = "aws/data/dev/brazil/census/census_brazil_weighting_area_2010.csv",
           object = "data/dev/brazil/census/census_brazil_weighting_area_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")

fwrite(wa_cv, "aws/data/dev/brazil/census/census_brazil_weighting_area_2010_cv.csv")
put_object(file = "aws/data/dev/brazil/census/census_brazil_weighting_area_2010_cv.csv",
           object = "data/raw/brazil/cv/census_brazil_weighting_area_2010.csv", 
           bucket = "cities-socio-economic-vulnerability",
           acl = "public-read")



